<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RouterActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">debugAndroidTest</a> &gt; <a href="index.source.html" class="el_package">org.schabi.newpipe</a> &gt; <span class="el_source">RouterActivity.java</span></div><h1>RouterActivity.java</h1><pre class="source lang-java linenums">package org.schabi.newpipe;

import android.annotation.SuppressLint;
import android.app.IntentService;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.SharedPreferences;
import android.content.pm.PackageManager;
import android.os.Bundle;
import android.preference.PreferenceManager;
import android.support.annotation.DrawableRes;
import android.support.annotation.NonNull;
import android.support.annotation.Nullable;
import android.support.v4.app.NotificationCompat;
import android.support.v7.app.AlertDialog;
import android.support.v7.app.AppCompatActivity;
import android.text.TextUtils;
import android.view.ContextThemeWrapper;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.Button;
import android.widget.LinearLayout;
import android.widget.RadioButton;
import android.widget.RadioGroup;
import android.widget.Toast;

import org.schabi.newpipe.download.DownloadDialog;
import org.schabi.newpipe.extractor.Info;
import org.schabi.newpipe.extractor.NewPipe;
import org.schabi.newpipe.extractor.StreamingService;
import org.schabi.newpipe.extractor.StreamingService.LinkType;
import org.schabi.newpipe.extractor.channel.ChannelInfo;
import org.schabi.newpipe.extractor.exceptions.ExtractionException;
import org.schabi.newpipe.extractor.playlist.PlaylistInfo;
import org.schabi.newpipe.extractor.stream.StreamInfo;
import org.schabi.newpipe.extractor.stream.VideoStream;
import org.schabi.newpipe.player.playqueue.ChannelPlayQueue;
import org.schabi.newpipe.player.playqueue.PlayQueue;
import org.schabi.newpipe.player.playqueue.PlaylistPlayQueue;
import org.schabi.newpipe.player.playqueue.SinglePlayQueue;
import org.schabi.newpipe.report.UserAction;
import org.schabi.newpipe.util.Constants;
import org.schabi.newpipe.util.ExtractorHelper;
import org.schabi.newpipe.util.ListHelper;
import org.schabi.newpipe.util.NavigationHelper;
import org.schabi.newpipe.util.PermissionHelper;
import org.schabi.newpipe.util.ThemeHelper;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.HashSet;
import java.util.List;

import icepick.Icepick;
import icepick.State;
import io.reactivex.Observable;
import io.reactivex.Single;
import io.reactivex.android.schedulers.AndroidSchedulers;
import io.reactivex.disposables.CompositeDisposable;
import io.reactivex.disposables.Disposable;
import io.reactivex.functions.Consumer;
import io.reactivex.schedulers.Schedulers;

import static org.schabi.newpipe.extractor.StreamingService.ServiceInfo.MediaCapability.AUDIO;
import static org.schabi.newpipe.extractor.StreamingService.ServiceInfo.MediaCapability.VIDEO;
import static org.schabi.newpipe.util.ThemeHelper.resolveResourceIdFromAttr;

/**
 * Get the url from the intent and open it in the chosen preferred player
 */
<span class="nc" id="L75">public class RouterActivity extends AppCompatActivity {</span>

<span class="nc" id="L77">    @State</span>
    protected int currentServiceId = -1;
    private StreamingService currentService;
    @State
    protected LinkType currentLinkType;
<span class="nc" id="L82">    @State</span>
    protected int selectedRadioPosition = -1;
<span class="nc" id="L84">    protected int selectedPreviously = -1;</span>

    protected String currentUrl;
<span class="nc" id="L87">    protected boolean internalRoute = false;</span>
<span class="nc" id="L88">    protected final CompositeDisposable disposables = new CompositeDisposable();</span>

<span class="nc" id="L90">    private boolean selectionIsDownload = false;</span>

    public static final String internalRouteKey = &quot;internalRoute&quot;;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L96">        super.onCreate(savedInstanceState);</span>
<span class="nc" id="L97">        Icepick.restoreInstanceState(this, savedInstanceState);</span>

<span class="nc bnc" id="L99" title="All 2 branches missed.">        if (TextUtils.isEmpty(currentUrl)) {</span>
<span class="nc" id="L100">            currentUrl = getUrl(getIntent());</span>

<span class="nc bnc" id="L102" title="All 2 branches missed.">            if (TextUtils.isEmpty(currentUrl)) {</span>
<span class="nc" id="L103">                handleText();</span>
<span class="nc" id="L104">                finish();</span>
            }
        }

<span class="nc" id="L108">        internalRoute = getIntent().getBooleanExtra(internalRouteKey, false);</span>

<span class="nc bnc" id="L110" title="All 2 branches missed.">        setTheme(ThemeHelper.isLightThemeSelected(this)</span>
                ? R.style.RouterActivityThemeLight : R.style.RouterActivityThemeDark);
<span class="nc" id="L112">    }</span>

    @Override
    protected void onSaveInstanceState(Bundle outState) {
<span class="nc" id="L116">        super.onSaveInstanceState(outState);</span>
<span class="nc" id="L117">        Icepick.saveInstanceState(this, outState);</span>
<span class="nc" id="L118">    }</span>

    @Override
    protected void onStart() {
<span class="nc" id="L122">        super.onStart();</span>

<span class="nc" id="L124">        handleUrl(currentUrl);</span>
<span class="nc" id="L125">    }</span>

    @Override
    protected void onDestroy() {
<span class="nc" id="L129">        super.onDestroy();</span>

<span class="nc" id="L131">        disposables.clear();</span>
<span class="nc" id="L132">    }</span>

    private void handleUrl(String url) {
<span class="nc" id="L135">        disposables.add(Observable</span>
<span class="nc" id="L136">                .fromCallable(() -&gt; {</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">                    if (currentServiceId == -1) {</span>
<span class="nc" id="L138">                        currentService = NewPipe.getServiceByUrl(url);</span>
<span class="nc" id="L139">                        currentServiceId = currentService.getServiceId();</span>
<span class="nc" id="L140">                        currentLinkType = currentService.getLinkTypeByUrl(url);</span>
<span class="nc" id="L141">                        currentUrl = url;</span>
                    } else {
<span class="nc" id="L143">                        currentService = NewPipe.getService(currentServiceId);</span>
                    }

<span class="nc bnc" id="L146" title="All 2 branches missed.">                    return currentLinkType != LinkType.NONE;</span>
                })
<span class="nc" id="L148">                .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L149">                .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L150">                .subscribe(result -&gt; {</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">                    if (result) {</span>
<span class="nc" id="L152">                        onSuccess();</span>
                    } else {
<span class="nc" id="L154">                        onError();</span>
                    }
<span class="nc" id="L156">                }, this::handleError));</span>
<span class="nc" id="L157">    }</span>

    private void handleError(Throwable error) {
<span class="nc" id="L160">        error.printStackTrace();</span>

<span class="nc bnc" id="L162" title="All 2 branches missed.">        if (error instanceof ExtractionException) {</span>
<span class="nc" id="L163">            Toast.makeText(this, R.string.url_not_supported_toast, Toast.LENGTH_LONG).show();</span>
        } else {
<span class="nc" id="L165">            ExtractorHelper.handleGeneralException(this, -1, null, error, UserAction.SOMETHING_ELSE, null);</span>
        }

<span class="nc" id="L168">        finish();</span>
<span class="nc" id="L169">    }</span>

    private void onError() {
<span class="nc" id="L172">        Toast.makeText(this, R.string.url_not_supported_toast, Toast.LENGTH_LONG).show();</span>
<span class="nc" id="L173">        finish();</span>
<span class="nc" id="L174">    }</span>

    protected void onSuccess() {
<span class="nc" id="L177">        final SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);</span>
<span class="nc" id="L178">        final String selectedChoiceKey = preferences.getString(getString(R.string.preferred_open_action_key), getString(R.string.preferred_open_action_default));</span>

<span class="nc" id="L180">        final String showInfoKey = getString(R.string.show_info_key);</span>
<span class="nc" id="L181">        final String videoPlayerKey = getString(R.string.video_player_key);</span>
<span class="nc" id="L182">        final String backgroundPlayerKey = getString(R.string.background_player_key);</span>
<span class="nc" id="L183">        final String popupPlayerKey = getString(R.string.popup_player_key);</span>
<span class="nc" id="L184">        final String downloadKey = getString(R.string.download_key);</span>
<span class="nc" id="L185">        final String alwaysAskKey = getString(R.string.always_ask_open_action_key);</span>

<span class="nc bnc" id="L187" title="All 2 branches missed.">        if (selectedChoiceKey.equals(alwaysAskKey)) {</span>
<span class="nc" id="L188">            final List&lt;AdapterChoiceItem&gt; choices = getChoicesForService(currentService, currentLinkType);</span>

<span class="nc bnc" id="L190" title="All 3 branches missed.">            switch (choices.size()) {</span>
                case 1:
<span class="nc" id="L192">                    handleChoice(choices.get(0).key);</span>
<span class="nc" id="L193">                    break;</span>
                case 0:
<span class="nc" id="L195">                    handleChoice(showInfoKey);</span>
<span class="nc" id="L196">                    break;</span>
                default:
<span class="nc" id="L198">                    showDialog(choices);</span>
                    break;
            }
<span class="nc bnc" id="L201" title="All 2 branches missed.">        } else if (selectedChoiceKey.equals(showInfoKey)) {</span>
<span class="nc" id="L202">            handleChoice(showInfoKey);</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">        } else if (selectedChoiceKey.equals(downloadKey)) {</span>
<span class="nc" id="L204">            handleChoice(downloadKey);</span>
        } else {
<span class="nc" id="L206">            final boolean isExtVideoEnabled = preferences.getBoolean(getString(R.string.use_external_video_player_key), false);</span>
<span class="nc" id="L207">            final boolean isExtAudioEnabled = preferences.getBoolean(getString(R.string.use_external_audio_player_key), false);</span>
<span class="nc bnc" id="L208" title="All 4 branches missed.">            final boolean isVideoPlayerSelected = selectedChoiceKey.equals(videoPlayerKey) || selectedChoiceKey.equals(popupPlayerKey);</span>
<span class="nc" id="L209">            final boolean isAudioPlayerSelected = selectedChoiceKey.equals(backgroundPlayerKey);</span>

<span class="nc bnc" id="L211" title="All 2 branches missed.">            if (currentLinkType != LinkType.STREAM) {</span>
<span class="nc bnc" id="L212" title="All 8 branches missed.">                if (isExtAudioEnabled &amp;&amp; isAudioPlayerSelected || isExtVideoEnabled &amp;&amp; isVideoPlayerSelected) {</span>
<span class="nc" id="L213">                    Toast.makeText(this, R.string.external_player_unsupported_link_type, Toast.LENGTH_LONG).show();</span>
<span class="nc" id="L214">                    handleChoice(showInfoKey);</span>
<span class="nc" id="L215">                    return;</span>
                }
            }

<span class="nc" id="L219">            final List&lt;StreamingService.ServiceInfo.MediaCapability&gt; capabilities = currentService.getServiceInfo().getMediaCapabilities();</span>

<span class="nc" id="L221">            boolean serviceSupportsChoice = false;</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">            if (isVideoPlayerSelected) {</span>
<span class="nc" id="L223">                serviceSupportsChoice = capabilities.contains(VIDEO);</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">            } else if (selectedChoiceKey.equals(backgroundPlayerKey)) {</span>
<span class="nc" id="L225">                serviceSupportsChoice = capabilities.contains(AUDIO);</span>
            }

<span class="nc bnc" id="L228" title="All 2 branches missed.">            if (serviceSupportsChoice) {</span>
<span class="nc" id="L229">                handleChoice(selectedChoiceKey);</span>
            } else {
<span class="nc" id="L231">                handleChoice(showInfoKey);</span>
            }
        }
<span class="nc" id="L234">    }</span>

    private void showDialog(final List&lt;AdapterChoiceItem&gt; choices) {
<span class="nc" id="L237">        final SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);</span>
<span class="nc" id="L238">        final Context themeWrapperContext = getThemeWrapperContext();</span>

<span class="nc" id="L240">        final LayoutInflater inflater = LayoutInflater.from(themeWrapperContext);</span>
<span class="nc" id="L241">        final LinearLayout rootLayout = (LinearLayout) inflater.inflate(R.layout.preferred_player_dialog_view, null, false);</span>
<span class="nc" id="L242">        final RadioGroup radioGroup = rootLayout.findViewById(android.R.id.list);</span>

<span class="nc" id="L244">        final DialogInterface.OnClickListener dialogButtonsClickListener = (dialog, which) -&gt; {</span>
<span class="nc" id="L245">            final int indexOfChild = radioGroup.indexOfChild(</span>
<span class="nc" id="L246">                    radioGroup.findViewById(radioGroup.getCheckedRadioButtonId()));</span>
<span class="nc" id="L247">            final AdapterChoiceItem choice = choices.get(indexOfChild);</span>

<span class="nc" id="L249">            handleChoice(choice.key);</span>

<span class="nc bnc" id="L251" title="All 2 branches missed.">            if (which == DialogInterface.BUTTON_POSITIVE) {</span>
<span class="nc" id="L252">                preferences.edit().putString(getString(R.string.preferred_open_action_key), choice.key).apply();</span>
            }
<span class="nc" id="L254">        };</span>

<span class="nc" id="L256">        final AlertDialog alertDialog = new AlertDialog.Builder(themeWrapperContext)</span>
<span class="nc" id="L257">                .setTitle(R.string.preferred_open_action_share_menu_title)</span>
<span class="nc" id="L258">                .setView(radioGroup)</span>
<span class="nc" id="L259">                .setCancelable(true)</span>
<span class="nc" id="L260">                .setNegativeButton(R.string.just_once, dialogButtonsClickListener)</span>
<span class="nc" id="L261">                .setPositiveButton(R.string.always, dialogButtonsClickListener)</span>
<span class="nc" id="L262">                .setOnDismissListener((dialog) -&gt; {</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">                    if (!selectionIsDownload) finish();</span>
<span class="nc" id="L264">                })</span>
<span class="nc" id="L265">                .create();</span>

        //noinspection CodeBlock2Expr
<span class="nc" id="L268">        alertDialog.setOnShowListener(dialog -&gt; {</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">            setDialogButtonsState(alertDialog, radioGroup.getCheckedRadioButtonId() != -1);</span>
<span class="nc" id="L270">        });</span>

<span class="nc" id="L272">        radioGroup.setOnCheckedChangeListener((group, checkedId) -&gt; setDialogButtonsState(alertDialog, true));</span>
<span class="nc" id="L273">        final View.OnClickListener radioButtonsClickListener = v -&gt; {</span>
<span class="nc" id="L274">            final int indexOfChild = radioGroup.indexOfChild(v);</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">            if (indexOfChild == -1) return;</span>

<span class="nc" id="L277">            selectedPreviously = selectedRadioPosition;</span>
<span class="nc" id="L278">            selectedRadioPosition = indexOfChild;</span>

<span class="nc bnc" id="L280" title="All 2 branches missed.">            if (selectedPreviously == selectedRadioPosition) {</span>
<span class="nc" id="L281">                handleChoice(choices.get(selectedRadioPosition).key);</span>
            }
<span class="nc" id="L283">        };</span>

<span class="nc" id="L285">        int id = 12345;</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">        for (AdapterChoiceItem item : choices) {</span>
<span class="nc" id="L287">            final RadioButton radioButton = (RadioButton) inflater.inflate(R.layout.list_radio_icon_item, null);</span>
<span class="nc" id="L288">            radioButton.setText(item.description);</span>
<span class="nc" id="L289">            radioButton.setCompoundDrawablesWithIntrinsicBounds(item.icon, 0, 0, 0);</span>
<span class="nc" id="L290">            radioButton.setChecked(false);</span>
<span class="nc" id="L291">            radioButton.setId(id++);</span>
<span class="nc" id="L292">            radioButton.setLayoutParams(new RadioGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT));</span>
<span class="nc" id="L293">            radioButton.setOnClickListener(radioButtonsClickListener);</span>
<span class="nc" id="L294">            radioGroup.addView(radioButton);</span>
<span class="nc" id="L295">        }</span>

<span class="nc bnc" id="L297" title="All 2 branches missed.">        if (selectedRadioPosition == -1) {</span>
<span class="nc" id="L298">            final String lastSelectedPlayer = preferences.getString(getString(R.string.preferred_open_action_last_selected_key), null);</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">            if (!TextUtils.isEmpty(lastSelectedPlayer)) {</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">                for (int i = 0; i &lt; choices.size(); i++) {</span>
<span class="nc" id="L301">                    AdapterChoiceItem c = choices.get(i);</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">                    if (lastSelectedPlayer.equals(c.key)) {</span>
<span class="nc" id="L303">                        selectedRadioPosition = i;</span>
<span class="nc" id="L304">                        break;</span>
                    }
                }
            }
        }

<span class="nc" id="L310">        selectedRadioPosition = Math.min(Math.max(-1, selectedRadioPosition), choices.size() - 1);</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">        if (selectedRadioPosition != -1) {</span>
<span class="nc" id="L312">            ((RadioButton) radioGroup.getChildAt(selectedRadioPosition)).setChecked(true);</span>
        }
<span class="nc" id="L314">        selectedPreviously = selectedRadioPosition;</span>

<span class="nc" id="L316">        alertDialog.show();</span>
<span class="nc" id="L317">    }</span>

    private List&lt;AdapterChoiceItem&gt; getChoicesForService(StreamingService service, LinkType linkType) {
<span class="nc" id="L320">        final Context context = getThemeWrapperContext();</span>

<span class="nc" id="L322">        final List&lt;AdapterChoiceItem&gt; returnList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L323">        final List&lt;StreamingService.ServiceInfo.MediaCapability&gt; capabilities = service.getServiceInfo().getMediaCapabilities();</span>

<span class="nc" id="L325">        final SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);</span>
<span class="nc" id="L326">        boolean isExtVideoEnabled = preferences.getBoolean(getString(R.string.use_external_video_player_key), false);</span>
<span class="nc" id="L327">        boolean isExtAudioEnabled = preferences.getBoolean(getString(R.string.use_external_audio_player_key), false);</span>

<span class="nc" id="L329">        returnList.add(new AdapterChoiceItem(getString(R.string.show_info_key), getString(R.string.show_info),</span>
<span class="nc" id="L330">                resolveResourceIdFromAttr(context, R.attr.info)));</span>

<span class="nc bnc" id="L332" title="All 6 branches missed.">        if (capabilities.contains(VIDEO) &amp;&amp; !(isExtVideoEnabled &amp;&amp; linkType != LinkType.STREAM)) {</span>
<span class="nc" id="L333">            returnList.add(new AdapterChoiceItem(getString(R.string.video_player_key), getString(R.string.video_player),</span>
<span class="nc" id="L334">                    resolveResourceIdFromAttr(context, R.attr.play)));</span>
<span class="nc" id="L335">            returnList.add(new AdapterChoiceItem(getString(R.string.popup_player_key), getString(R.string.popup_player),</span>
<span class="nc" id="L336">                    resolveResourceIdFromAttr(context, R.attr.popup)));</span>
        }

<span class="nc bnc" id="L339" title="All 6 branches missed.">        if (capabilities.contains(AUDIO) &amp;&amp; !(isExtAudioEnabled &amp;&amp; linkType != LinkType.STREAM)) {</span>
<span class="nc" id="L340">            returnList.add(new AdapterChoiceItem(getString(R.string.background_player_key), getString(R.string.background_player),</span>
<span class="nc" id="L341">                    resolveResourceIdFromAttr(context, R.attr.audio)));</span>
        }

<span class="nc" id="L344">        returnList.add(new AdapterChoiceItem(getString(R.string.download_key), getString(R.string.download),</span>
<span class="nc" id="L345">                resolveResourceIdFromAttr(context, R.attr.download)));</span>

<span class="nc" id="L347">        return returnList;</span>
    }

    private Context getThemeWrapperContext() {
<span class="nc" id="L351">        return new ContextThemeWrapper(this,</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">                ThemeHelper.isLightThemeSelected(this) ? R.style.LightTheme : R.style.DarkTheme);</span>
    }

    private void setDialogButtonsState(AlertDialog dialog, boolean state) {
<span class="nc" id="L356">        final Button negativeButton = dialog.getButton(DialogInterface.BUTTON_NEGATIVE);</span>
<span class="nc" id="L357">        final Button positiveButton = dialog.getButton(DialogInterface.BUTTON_POSITIVE);</span>
<span class="nc bnc" id="L358" title="All 4 branches missed.">        if (negativeButton == null || positiveButton == null) return;</span>

<span class="nc" id="L360">        negativeButton.setEnabled(state);</span>
<span class="nc" id="L361">        positiveButton.setEnabled(state);</span>
<span class="nc" id="L362">    }</span>

    private void handleText() {
<span class="nc" id="L365">        String searchString = getIntent().getStringExtra(Intent.EXTRA_TEXT);</span>
<span class="nc" id="L366">        int serviceId = getIntent().getIntExtra(Constants.KEY_SERVICE_ID, 0);</span>
<span class="nc" id="L367">        Intent intent = new Intent(getThemeWrapperContext(), MainActivity.class);</span>
<span class="nc" id="L368">        intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span>
<span class="nc" id="L369">        startActivity(intent);</span>
<span class="nc" id="L370">        NavigationHelper.openSearch(getThemeWrapperContext(), serviceId, searchString);</span>
<span class="nc" id="L371">    }</span>

    private void handleChoice(final String selectedChoiceKey) {
<span class="nc" id="L374">        final List&lt;String&gt; validChoicesList = Arrays.asList(getResources().getStringArray(R.array.preferred_open_action_values_list));</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">        if (validChoicesList.contains(selectedChoiceKey)) {</span>
<span class="nc" id="L376">            PreferenceManager.getDefaultSharedPreferences(this).edit()</span>
<span class="nc" id="L377">                    .putString(getString(R.string.preferred_open_action_last_selected_key), selectedChoiceKey)</span>
<span class="nc" id="L378">                    .apply();</span>
        }

<span class="nc bnc" id="L381" title="All 4 branches missed.">        if (selectedChoiceKey.equals(getString(R.string.popup_player_key)) &amp;&amp; !PermissionHelper.isPopupEnabled(this)) {</span>
<span class="nc" id="L382">            PermissionHelper.showPopupEnablementToast(this);</span>
<span class="nc" id="L383">            finish();</span>
<span class="nc" id="L384">            return;</span>
        }

<span class="nc bnc" id="L387" title="All 2 branches missed.">        if (selectedChoiceKey.equals(getString(R.string.download_key))) {</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">            if (PermissionHelper.checkStoragePermissions(this, PermissionHelper.DOWNLOAD_DIALOG_REQUEST_CODE)) {</span>
<span class="nc" id="L389">                selectionIsDownload = true;</span>
<span class="nc" id="L390">                openDownloadDialog();</span>
            }
<span class="nc" id="L392">            return;</span>
        }

        // stop and bypass FetcherService if InfoScreen was selected since
        // StreamDetailFragment can fetch data itself
<span class="nc bnc" id="L397" title="All 2 branches missed.">        if (selectedChoiceKey.equals(getString(R.string.show_info_key))) {</span>
<span class="nc" id="L398">            disposables.add(Observable</span>
<span class="nc" id="L399">                    .fromCallable(() -&gt; NavigationHelper.getIntentByLink(this, currentUrl))</span>
<span class="nc" id="L400">                    .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L401">                    .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L402">                    .subscribe(intent -&gt; {</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">                        if (!internalRoute) {</span>
<span class="nc" id="L404">                            intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span>
<span class="nc" id="L405">                            intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK);</span>
                        }
<span class="nc" id="L407">                        startActivity(intent);</span>

<span class="nc" id="L409">                        finish();</span>
<span class="nc" id="L410">                    }, this::handleError)</span>
            );
<span class="nc" id="L412">            return;</span>
        }

<span class="nc" id="L415">        final Intent intent = new Intent(this, FetcherService.class);</span>
<span class="nc" id="L416">        final Choice choice = new Choice(currentService.getServiceId(), currentLinkType, currentUrl, selectedChoiceKey);</span>
<span class="nc" id="L417">        intent.putExtra(FetcherService.KEY_CHOICE, choice);</span>
<span class="nc" id="L418">        startService(intent);</span>

<span class="nc" id="L420">        finish();</span>
<span class="nc" id="L421">    }</span>

    @SuppressLint(&quot;CheckResult&quot;)
    private void openDownloadDialog() {
<span class="nc" id="L425">        ExtractorHelper.getStreamInfo(currentServiceId, currentUrl, true)</span>
<span class="nc" id="L426">                .subscribeOn(Schedulers.io())</span>
<span class="nc" id="L427">                .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L428">                .subscribe((@NonNull StreamInfo result) -&gt; {</span>
<span class="nc" id="L429">                    List&lt;VideoStream&gt; sortedVideoStreams = ListHelper.getSortedStreamVideosList(this,</span>
<span class="nc" id="L430">                            result.getVideoStreams(),</span>
<span class="nc" id="L431">                            result.getVideoOnlyStreams(),</span>
                            false);
<span class="nc" id="L433">                    int selectedVideoStreamIndex = ListHelper.getDefaultResolutionIndex(this,</span>
                            sortedVideoStreams);

<span class="nc" id="L436">                    android.support.v4.app.FragmentManager fm = getSupportFragmentManager();</span>
<span class="nc" id="L437">                    DownloadDialog downloadDialog = DownloadDialog.newInstance(result);</span>
<span class="nc" id="L438">                    downloadDialog.setVideoStreams(sortedVideoStreams);</span>
<span class="nc" id="L439">                    downloadDialog.setAudioStreams(result.getAudioStreams());</span>
<span class="nc" id="L440">                    downloadDialog.setSelectedVideoStream(selectedVideoStreamIndex);</span>
<span class="nc" id="L441">                    downloadDialog.show(fm, &quot;downloadDialog&quot;);</span>
<span class="nc" id="L442">                    fm.executePendingTransactions();</span>
<span class="nc" id="L443">                    downloadDialog.getDialog().setOnDismissListener(dialog -&gt; {</span>
<span class="nc" id="L444">                        finish();</span>
<span class="nc" id="L445">                    });</span>
<span class="nc" id="L446">                }, (@NonNull Throwable throwable) -&gt; {</span>
<span class="nc" id="L447">                    onError();</span>
<span class="nc" id="L448">                });</span>
<span class="nc" id="L449">    }</span>

    @Override
    public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) {
<span class="nc bnc" id="L453" title="All 2 branches missed.">        for (int i : grantResults) {</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">            if (i == PackageManager.PERMISSION_DENIED) {</span>
<span class="nc" id="L455">                finish();</span>
<span class="nc" id="L456">                return;</span>
            }
        }
<span class="nc bnc" id="L459" title="All 2 branches missed.">        if (requestCode == PermissionHelper.DOWNLOAD_DIALOG_REQUEST_CODE) {</span>
<span class="nc" id="L460">            openDownloadDialog();</span>
        }
<span class="nc" id="L462">    }</span>

    private static class AdapterChoiceItem {
        final String description, key;
        @DrawableRes
        final int icon;

<span class="nc" id="L469">        AdapterChoiceItem(String key, String description, int icon) {</span>
<span class="nc" id="L470">            this.description = description;</span>
<span class="nc" id="L471">            this.key = key;</span>
<span class="nc" id="L472">            this.icon = icon;</span>
<span class="nc" id="L473">        }</span>
    }

    private static class Choice implements Serializable {
        final int serviceId;
        final String url, playerChoice;
        final LinkType linkType;

<span class="nc" id="L481">        Choice(int serviceId, LinkType linkType, String url, String playerChoice) {</span>
<span class="nc" id="L482">            this.serviceId = serviceId;</span>
<span class="nc" id="L483">            this.linkType = linkType;</span>
<span class="nc" id="L484">            this.url = url;</span>
<span class="nc" id="L485">            this.playerChoice = playerChoice;</span>
<span class="nc" id="L486">        }</span>

        @Override
        public String toString() {
<span class="nc" id="L490">            return serviceId + &quot;:&quot; + url + &quot; &gt; &quot; + linkType + &quot; ::: &quot; + playerChoice;</span>
        }
    }

    /*//////////////////////////////////////////////////////////////////////////
    // Service Fetcher
    //////////////////////////////////////////////////////////////////////////*/

    public static class FetcherService extends IntentService {

        private static final int ID = 456;
        public static final String KEY_CHOICE = &quot;key_choice&quot;;
        private Disposable fetcher;

        public FetcherService() {
<span class="nc" id="L505">            super(FetcherService.class.getSimpleName());</span>
<span class="nc" id="L506">        }</span>

        @Override
        public void onCreate() {
<span class="nc" id="L510">            super.onCreate();</span>
<span class="nc" id="L511">            startForeground(ID, createNotification().build());</span>
<span class="nc" id="L512">        }</span>

        @Override
        protected void onHandleIntent(@Nullable Intent intent) {
<span class="nc bnc" id="L516" title="All 2 branches missed.">            if (intent == null) return;</span>

<span class="nc" id="L518">            final Serializable serializable = intent.getSerializableExtra(KEY_CHOICE);</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">            if (!(serializable instanceof Choice)) return;</span>
<span class="nc" id="L520">            Choice playerChoice = (Choice) serializable;</span>
<span class="nc" id="L521">            handleChoice(playerChoice);</span>
<span class="nc" id="L522">        }</span>

        public void handleChoice(Choice choice) {
<span class="nc" id="L525">            Single&lt;? extends Info&gt; single = null;</span>
<span class="nc" id="L526">            UserAction userAction = UserAction.SOMETHING_ELSE;</span>

<span class="nc bnc" id="L528" title="All 4 branches missed.">            switch (choice.linkType) {</span>
                case STREAM:
<span class="nc" id="L530">                    single = ExtractorHelper.getStreamInfo(choice.serviceId, choice.url, false);</span>
<span class="nc" id="L531">                    userAction = UserAction.REQUESTED_STREAM;</span>
<span class="nc" id="L532">                    break;</span>
                case CHANNEL:
<span class="nc" id="L534">                    single = ExtractorHelper.getChannelInfo(choice.serviceId, choice.url, false);</span>
<span class="nc" id="L535">                    userAction = UserAction.REQUESTED_CHANNEL;</span>
<span class="nc" id="L536">                    break;</span>
                case PLAYLIST:
<span class="nc" id="L538">                    single = ExtractorHelper.getPlaylistInfo(choice.serviceId, choice.url, false);</span>
<span class="nc" id="L539">                    userAction = UserAction.REQUESTED_PLAYLIST;</span>
                    break;
            }


<span class="nc bnc" id="L544" title="All 2 branches missed.">            if (single != null) {</span>
<span class="nc" id="L545">                final UserAction finalUserAction = userAction;</span>
<span class="nc" id="L546">                final Consumer&lt;Info&gt; resultHandler = getResultHandler(choice);</span>
<span class="nc" id="L547">                fetcher = single</span>
<span class="nc" id="L548">                        .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L549">                        .subscribe(info -&gt; {</span>
<span class="nc" id="L550">                            resultHandler.accept(info);</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">                            if (fetcher != null) fetcher.dispose();</span>
<span class="nc" id="L552">                        }, throwable -&gt; ExtractorHelper.handleGeneralException(this,</span>
                                choice.serviceId, choice.url, throwable, finalUserAction, &quot;, opened with &quot; + choice.playerChoice));
            }
<span class="nc" id="L555">        }</span>

        public Consumer&lt;Info&gt; getResultHandler(Choice choice) {
<span class="nc" id="L558">            return info -&gt; {</span>
<span class="nc" id="L559">                final String videoPlayerKey = getString(R.string.video_player_key);</span>
<span class="nc" id="L560">                final String backgroundPlayerKey = getString(R.string.background_player_key);</span>
<span class="nc" id="L561">                final String popupPlayerKey = getString(R.string.popup_player_key);</span>

<span class="nc" id="L563">                final SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);</span>
<span class="nc" id="L564">                boolean isExtVideoEnabled = preferences.getBoolean(getString(R.string.use_external_video_player_key), false);</span>
<span class="nc" id="L565">                boolean isExtAudioEnabled = preferences.getBoolean(getString(R.string.use_external_audio_player_key), false);</span>
                ;

                PlayQueue playQueue;
<span class="nc" id="L569">                String playerChoice = choice.playerChoice;</span>

<span class="nc bnc" id="L571" title="All 2 branches missed.">                if (info instanceof StreamInfo) {</span>
<span class="nc bnc" id="L572" title="All 4 branches missed.">                    if (playerChoice.equals(backgroundPlayerKey) &amp;&amp; isExtAudioEnabled) {</span>
<span class="nc" id="L573">                        NavigationHelper.playOnExternalAudioPlayer(this, (StreamInfo) info);</span>

<span class="nc bnc" id="L575" title="All 4 branches missed.">                    } else if (playerChoice.equals(videoPlayerKey) &amp;&amp; isExtVideoEnabled) {</span>
<span class="nc" id="L576">                        NavigationHelper.playOnExternalVideoPlayer(this, (StreamInfo) info);</span>

                    } else {
<span class="nc" id="L579">                        playQueue = new SinglePlayQueue((StreamInfo) info);</span>

<span class="nc bnc" id="L581" title="All 2 branches missed.">                        if (playerChoice.equals(videoPlayerKey)) {</span>
<span class="nc" id="L582">                            NavigationHelper.playOnMainPlayer(this, playQueue, true);</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">                        } else if (playerChoice.equals(backgroundPlayerKey)) {</span>
<span class="nc" id="L584">                            NavigationHelper.enqueueOnBackgroundPlayer(this, playQueue, true);</span>
<span class="nc bnc" id="L585" title="All 2 branches missed.">                        } else if (playerChoice.equals(popupPlayerKey)) {</span>
<span class="nc" id="L586">                            NavigationHelper.enqueueOnPopupPlayer(this, playQueue, true);</span>
                        }
                    }
                }

<span class="nc bnc" id="L591" title="All 4 branches missed.">                if (info instanceof ChannelInfo || info instanceof PlaylistInfo) {</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">                    playQueue = info instanceof ChannelInfo ? new ChannelPlayQueue((ChannelInfo) info) : new PlaylistPlayQueue((PlaylistInfo) info);</span>

<span class="nc bnc" id="L594" title="All 2 branches missed.">                    if (playerChoice.equals(videoPlayerKey)) {</span>
<span class="nc" id="L595">                        NavigationHelper.playOnMainPlayer(this, playQueue, true);</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">                    } else if (playerChoice.equals(backgroundPlayerKey)) {</span>
<span class="nc" id="L597">                        NavigationHelper.playOnBackgroundPlayer(this, playQueue, true);</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">                    } else if (playerChoice.equals(popupPlayerKey)) {</span>
<span class="nc" id="L599">                        NavigationHelper.playOnPopupPlayer(this, playQueue, true);</span>
                    }
                }
<span class="nc" id="L602">            };</span>
        }

        @Override
        public void onDestroy() {
<span class="nc" id="L607">            super.onDestroy();</span>
<span class="nc" id="L608">            stopForeground(true);</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">            if (fetcher != null) fetcher.dispose();</span>
<span class="nc" id="L610">        }</span>

        private NotificationCompat.Builder createNotification() {
<span class="nc" id="L613">            return new NotificationCompat.Builder(this, getString(R.string.notification_channel_id))</span>
<span class="nc" id="L614">                    .setOngoing(true)</span>
<span class="nc" id="L615">                    .setSmallIcon(R.drawable.ic_newpipe_triangle_white)</span>
<span class="nc" id="L616">                    .setVisibility(NotificationCompat.VISIBILITY_PUBLIC)</span>
<span class="nc" id="L617">                    .setContentTitle(getString(R.string.preferred_player_fetcher_notification_title))</span>
<span class="nc" id="L618">                    .setContentText(getString(R.string.preferred_player_fetcher_notification_message));</span>
        }
    }

    /*//////////////////////////////////////////////////////////////////////////
    // Utils
    //////////////////////////////////////////////////////////////////////////*/

    /**
     * Removes invisible separators (\p{Z}) and punctuation characters including
     * brackets (\p{P}). See http://www.regular-expressions.info/unicode.html for
     * more details.
     */
    private final static String REGEX_REMOVE_FROM_URL = &quot;[\\p{Z}\\p{P}]&quot;;

    private String getUrl(Intent intent) {
        // first gather data and find service
<span class="nc" id="L635">        String videoUrl = null;</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">        if (intent.getData() != null) {</span>
            // this means the video was called though another app
<span class="nc" id="L638">            videoUrl = intent.getData().toString();</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">        } else if (intent.getStringExtra(Intent.EXTRA_TEXT) != null) {</span>
            //this means that vidoe was called through share menu
<span class="nc" id="L641">            String extraText = intent.getStringExtra(Intent.EXTRA_TEXT);</span>
<span class="nc" id="L642">            final String[] uris = getUris(extraText);</span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">            videoUrl = uris.length &gt; 0 ? uris[0] : null;</span>
        }

<span class="nc" id="L646">        return videoUrl;</span>
    }

    private String removeHeadingGibberish(final String input) {
<span class="nc" id="L650">        int start = 0;</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">        for (int i = input.indexOf(&quot;://&quot;) - 1; i &gt;= 0; i--) {</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">            if (!input.substring(i, i + 1).matches(&quot;\\p{L}&quot;)) {</span>
<span class="nc" id="L653">                start = i + 1;</span>
<span class="nc" id="L654">                break;</span>
            }
        }
<span class="nc" id="L657">        return input.substring(start, input.length());</span>
    }

    private String trim(final String input) {
<span class="nc bnc" id="L661" title="All 4 branches missed.">        if (input == null || input.length() &lt; 1) {</span>
<span class="nc" id="L662">            return input;</span>
        } else {
<span class="nc" id="L664">            String output = input;</span>
<span class="nc bnc" id="L665" title="All 4 branches missed.">            while (output.length() &gt; 0 &amp;&amp; output.substring(0, 1).matches(REGEX_REMOVE_FROM_URL)) {</span>
<span class="nc" id="L666">                output = output.substring(1);</span>
            }
<span class="nc bnc" id="L668" title="All 2 branches missed.">            while (output.length() &gt; 0</span>
<span class="nc bnc" id="L669" title="All 2 branches missed.">                    &amp;&amp; output.substring(output.length() - 1, output.length()).matches(REGEX_REMOVE_FROM_URL)) {</span>
<span class="nc" id="L670">                output = output.substring(0, output.length() - 1);</span>
            }
<span class="nc" id="L672">            return output;</span>
        }
    }

    /**
     * Retrieves all Strings which look remotely like URLs from a text.
     * Used if NewPipe was called through share menu.
     *
     * @param sharedText text to scan for URLs.
     * @return potential URLs
     */
    protected String[] getUris(final String sharedText) {
<span class="nc" id="L684">        final Collection&lt;String&gt; result = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L685" title="All 2 branches missed.">        if (sharedText != null) {</span>
<span class="nc" id="L686">            final String[] array = sharedText.split(&quot;\\p{Space}&quot;);</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">            for (String s : array) {</span>
<span class="nc" id="L688">                s = trim(s);</span>
<span class="nc bnc" id="L689" title="All 2 branches missed.">                if (s.length() != 0) {</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">                    if (s.matches(&quot;.+://.+&quot;)) {</span>
<span class="nc" id="L691">                        result.add(removeHeadingGibberish(s));</span>
<span class="nc bnc" id="L692" title="All 2 branches missed.">                    } else if (s.matches(&quot;.+\\..+&quot;)) {</span>
<span class="nc" id="L693">                        result.add(&quot;http://&quot; + s);</span>
                    }
                }
            }
        }
<span class="nc" id="L698">        return result.toArray(new String[result.size()]);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span>Generated by the Android Gradle plugin 3.2.0</div></body></html>