<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>VideoPlayer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">debugAndroidTest</a> &gt; <a href="index.source.html" class="el_package">org.schabi.newpipe.player</a> &gt; <span class="el_source">VideoPlayer.java</span></div><h1>VideoPlayer.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2017 Mauricio Colli &lt;mauriciocolli@outlook.com&gt;
 * VideoPlayer.java is part of NewPipe
 *
 * License: GPL-3.0+
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package org.schabi.newpipe.player;

import android.animation.Animator;
import android.animation.AnimatorListenerAdapter;
import android.animation.ObjectAnimator;
import android.animation.PropertyValuesHolder;
import android.animation.ValueAnimator;
import android.content.Context;
import android.content.Intent;
import android.graphics.Bitmap;
import android.graphics.Color;
import android.graphics.PorterDuff;
import android.os.Build;
import android.os.Handler;
import android.support.annotation.NonNull;
import android.support.annotation.Nullable;
import android.support.v4.content.ContextCompat;
import android.util.Log;
import android.view.Menu;
import android.view.MenuItem;
import android.view.SurfaceView;
import android.view.View;
import android.widget.ImageView;
import android.widget.PopupMenu;
import android.widget.ProgressBar;
import android.widget.SeekBar;
import android.widget.TextView;

import com.google.android.exoplayer2.C;
import com.google.android.exoplayer2.PlaybackParameters;
import com.google.android.exoplayer2.Player;
import com.google.android.exoplayer2.source.MediaSource;
import com.google.android.exoplayer2.source.TrackGroup;
import com.google.android.exoplayer2.source.TrackGroupArray;
import com.google.android.exoplayer2.text.CaptionStyleCompat;
import com.google.android.exoplayer2.trackselection.TrackSelectionArray;
import com.google.android.exoplayer2.ui.AspectRatioFrameLayout;
import com.google.android.exoplayer2.ui.SubtitleView;
import com.google.android.exoplayer2.video.VideoListener;

import org.schabi.newpipe.R;
import org.schabi.newpipe.extractor.MediaFormat;
import org.schabi.newpipe.extractor.stream.StreamInfo;
import org.schabi.newpipe.extractor.stream.VideoStream;
import org.schabi.newpipe.player.helper.PlayerHelper;
import org.schabi.newpipe.player.playqueue.PlayQueueItem;
import org.schabi.newpipe.player.resolver.MediaSourceTag;
import org.schabi.newpipe.player.resolver.VideoPlaybackResolver;
import org.schabi.newpipe.util.AnimationUtils;

import java.util.ArrayList;
import java.util.List;

import static org.schabi.newpipe.player.helper.PlayerHelper.formatSpeed;
import static org.schabi.newpipe.player.helper.PlayerHelper.getTimeString;
import static org.schabi.newpipe.util.AnimationUtils.animateView;

/**
 * Base for &lt;b&gt;video&lt;/b&gt; players
 *
 * @author mauriciocolli
 */
@SuppressWarnings({&quot;WeakerAccess&quot;, &quot;unused&quot;})
public abstract class VideoPlayer extends BasePlayer
        implements VideoListener,
        SeekBar.OnSeekBarChangeListener,
        View.OnClickListener,
        Player.EventListener,
        PopupMenu.OnMenuItemClickListener,
        PopupMenu.OnDismissListener {
<span class="nc" id="L90">    public static final boolean DEBUG = BasePlayer.DEBUG;</span>
    public final String TAG;

    /*//////////////////////////////////////////////////////////////////////////
    // Player
    //////////////////////////////////////////////////////////////////////////*/

    protected static final int RENDERER_UNAVAILABLE = -1;
    public static final int DEFAULT_CONTROLS_DURATION = 300; // 300 millis
    public static final int DEFAULT_CONTROLS_HIDE_TIME = 2000;  // 2 Seconds

    private List&lt;VideoStream&gt; availableStreams;
    private int selectedStreamIndex;

<span class="nc" id="L104">    protected boolean wasPlaying = false;</span>

    @NonNull final private VideoPlaybackResolver resolver;
    /*//////////////////////////////////////////////////////////////////////////
    // Views
    //////////////////////////////////////////////////////////////////////////*/

    private View rootView;

    private AspectRatioFrameLayout aspectRatioFrameLayout;
    private SurfaceView surfaceView;
    private View surfaceForeground;

    private View loadingPanel;
    private ImageView endScreen;
    private ImageView controlAnimationView;

    private View controlsRoot;
    private TextView currentDisplaySeek;

    private View bottomControlsRoot;
    private SeekBar playbackSeekBar;
    private TextView playbackCurrentTime;
    private TextView playbackEndTime;
    private TextView playbackLiveSync;
    private TextView playbackSpeedTextView;

    private View topControlsRoot;
    private TextView qualityTextView;

    private SubtitleView subtitleView;

    private TextView resizeView;
    private TextView captionTextView;

    private ValueAnimator controlViewAnimator;
<span class="nc" id="L140">    private final Handler controlsVisibilityHandler = new Handler();</span>

<span class="nc" id="L142">    boolean isSomePopupMenuVisible = false;</span>
<span class="nc" id="L143">    private final int qualityPopupMenuGroupId = 69;</span>
    private PopupMenu qualityPopupMenu;

<span class="nc" id="L146">    private final int playbackSpeedPopupMenuGroupId = 79;</span>
    private PopupMenu playbackSpeedPopupMenu;

<span class="nc" id="L149">    private final int captionPopupMenuGroupId = 89;</span>
    private PopupMenu captionPopupMenu;

    ///////////////////////////////////////////////////////////////////////////

    public VideoPlayer(String debugTag, Context context) {
<span class="nc" id="L155">        super(context);</span>
<span class="nc" id="L156">        this.TAG = debugTag;</span>
<span class="nc" id="L157">        this.resolver = new VideoPlaybackResolver(context, dataSource, getQualityResolver());</span>
<span class="nc" id="L158">    }</span>

    public void setup(View rootView) {
<span class="nc" id="L161">        initViews(rootView);</span>
<span class="nc" id="L162">        setup();</span>
<span class="nc" id="L163">    }</span>

    public void initViews(View rootView) {
<span class="nc" id="L166">        this.rootView = rootView;</span>
<span class="nc" id="L167">        this.aspectRatioFrameLayout = rootView.findViewById(R.id.aspectRatioLayout);</span>
<span class="nc" id="L168">        this.surfaceView = rootView.findViewById(R.id.surfaceView);</span>
<span class="nc" id="L169">        this.surfaceForeground = rootView.findViewById(R.id.surfaceForeground);</span>
<span class="nc" id="L170">        this.loadingPanel = rootView.findViewById(R.id.loading_panel);</span>
<span class="nc" id="L171">        this.endScreen = rootView.findViewById(R.id.endScreen);</span>
<span class="nc" id="L172">        this.controlAnimationView = rootView.findViewById(R.id.controlAnimationView);</span>
<span class="nc" id="L173">        this.controlsRoot = rootView.findViewById(R.id.playbackControlRoot);</span>
<span class="nc" id="L174">        this.currentDisplaySeek = rootView.findViewById(R.id.currentDisplaySeek);</span>
<span class="nc" id="L175">        this.playbackSeekBar = rootView.findViewById(R.id.playbackSeekBar);</span>
<span class="nc" id="L176">        this.playbackCurrentTime = rootView.findViewById(R.id.playbackCurrentTime);</span>
<span class="nc" id="L177">        this.playbackEndTime = rootView.findViewById(R.id.playbackEndTime);</span>
<span class="nc" id="L178">        this.playbackLiveSync = rootView.findViewById(R.id.playbackLiveSync);</span>
<span class="nc" id="L179">        this.playbackSpeedTextView = rootView.findViewById(R.id.playbackSpeed);</span>
<span class="nc" id="L180">        this.bottomControlsRoot = rootView.findViewById(R.id.bottomControls);</span>
<span class="nc" id="L181">        this.topControlsRoot = rootView.findViewById(R.id.topControls);</span>
<span class="nc" id="L182">        this.qualityTextView = rootView.findViewById(R.id.qualityTextView);</span>

<span class="nc" id="L184">        this.subtitleView = rootView.findViewById(R.id.subtitleView);</span>

<span class="nc" id="L186">        final float captionScale = PlayerHelper.getCaptionScale(context);</span>
<span class="nc" id="L187">        final CaptionStyleCompat captionStyle = PlayerHelper.getCaptionStyle(context);</span>
<span class="nc" id="L188">        setupSubtitleView(subtitleView, captionScale, captionStyle);</span>

<span class="nc" id="L190">        this.resizeView =  rootView.findViewById(R.id.resizeTextView);</span>
<span class="nc" id="L191">        resizeView.setText(PlayerHelper.resizeTypeOf(context, aspectRatioFrameLayout.getResizeMode()));</span>

<span class="nc" id="L193">        this.captionTextView = rootView.findViewById(R.id.captionTextView);</span>

        //this.aspectRatioFrameLayout.setAspectRatio(16.0f / 9.0f);

<span class="nc bnc" id="L197" title="All 2 branches missed.">        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN)</span>
<span class="nc" id="L198">            playbackSeekBar.getThumb().setColorFilter(Color.RED, PorterDuff.Mode.SRC_IN);</span>
<span class="nc" id="L199">        this.playbackSeekBar.getProgressDrawable().setColorFilter(Color.RED, PorterDuff.Mode.MULTIPLY);</span>

<span class="nc" id="L201">        this.qualityPopupMenu = new PopupMenu(context, qualityTextView);</span>
<span class="nc" id="L202">        this.playbackSpeedPopupMenu = new PopupMenu(context, playbackSpeedTextView);</span>
<span class="nc" id="L203">        this.captionPopupMenu = new PopupMenu(context, captionTextView);</span>

<span class="nc" id="L205">        ((ProgressBar) this.loadingPanel.findViewById(R.id.progressBarLoadingPanel))</span>
<span class="nc" id="L206">                .getIndeterminateDrawable().setColorFilter(Color.WHITE, PorterDuff.Mode.MULTIPLY);</span>
<span class="nc" id="L207">    }</span>

    protected abstract void setupSubtitleView(@NonNull SubtitleView view,
                                              final float captionScale,
                                              @NonNull final CaptionStyleCompat captionStyle);

    @Override
    public void initListeners() {
<span class="nc" id="L215">        playbackSeekBar.setOnSeekBarChangeListener(this);</span>
<span class="nc" id="L216">        playbackSpeedTextView.setOnClickListener(this);</span>
<span class="nc" id="L217">        qualityTextView.setOnClickListener(this);</span>
<span class="nc" id="L218">        captionTextView.setOnClickListener(this);</span>
<span class="nc" id="L219">        resizeView.setOnClickListener(this);</span>
<span class="nc" id="L220">        playbackLiveSync.setOnClickListener(this);</span>
<span class="nc" id="L221">    }</span>

    @Override
    public void initPlayer(final boolean playOnReady) {
<span class="nc" id="L225">        super.initPlayer(playOnReady);</span>

        // Setup video view
<span class="nc" id="L228">        simpleExoPlayer.setVideoSurfaceView(surfaceView);</span>
<span class="nc" id="L229">        simpleExoPlayer.addVideoListener(this);</span>

        // Setup subtitle view
<span class="nc" id="L232">        simpleExoPlayer.addTextOutput(cues -&gt; subtitleView.onCues(cues));</span>

        // Setup audio session with onboard equalizer
<span class="nc bnc" id="L235" title="All 2 branches missed.">        if (Build.VERSION.SDK_INT &gt;= 21) {</span>
<span class="nc" id="L236">            trackSelector.setParameters(trackSelector.buildUponParameters()</span>
<span class="nc" id="L237">                    .setTunnelingAudioSessionId(C.generateAudioSessionIdV21(context)));</span>
        }
<span class="nc" id="L239">    }</span>

    @Override
    public void handleIntent(final Intent intent) {
<span class="nc bnc" id="L243" title="All 2 branches missed.">        if (intent == null) return;</span>

<span class="nc bnc" id="L245" title="All 2 branches missed.">        if (intent.hasExtra(PLAYBACK_QUALITY)) {</span>
<span class="nc" id="L246">            setPlaybackQuality(intent.getStringExtra(PLAYBACK_QUALITY));</span>
        }

<span class="nc" id="L249">        super.handleIntent(intent);</span>
<span class="nc" id="L250">    }</span>

    /*//////////////////////////////////////////////////////////////////////////
    // UI Builders
    //////////////////////////////////////////////////////////////////////////*/

    public void buildQualityMenu() {
<span class="nc bnc" id="L257" title="All 2 branches missed.">        if (qualityPopupMenu == null) return;</span>

<span class="nc" id="L259">        qualityPopupMenu.getMenu().removeGroup(qualityPopupMenuGroupId);</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">        for (int i = 0; i &lt; availableStreams.size(); i++) {</span>
<span class="nc" id="L261">            VideoStream videoStream = availableStreams.get(i);</span>
<span class="nc" id="L262">            qualityPopupMenu.getMenu().add(qualityPopupMenuGroupId, i, Menu.NONE,</span>
<span class="nc" id="L263">                    MediaFormat.getNameById(videoStream.getFormatId()) + &quot; &quot; + videoStream.resolution);</span>
        }
<span class="nc bnc" id="L265" title="All 2 branches missed.">        if (getSelectedVideoStream() != null) {</span>
<span class="nc" id="L266">            qualityTextView.setText(getSelectedVideoStream().resolution);</span>
        }
<span class="nc" id="L268">        qualityPopupMenu.setOnMenuItemClickListener(this);</span>
<span class="nc" id="L269">        qualityPopupMenu.setOnDismissListener(this);</span>
<span class="nc" id="L270">    }</span>

    private void buildPlaybackSpeedMenu() {
<span class="nc bnc" id="L273" title="All 2 branches missed.">        if (playbackSpeedPopupMenu == null) return;</span>

<span class="nc" id="L275">        playbackSpeedPopupMenu.getMenu().removeGroup(playbackSpeedPopupMenuGroupId);</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">        for (int i = 0; i &lt; PLAYBACK_SPEEDS.length; i++) {</span>
<span class="nc" id="L277">            playbackSpeedPopupMenu.getMenu().add(playbackSpeedPopupMenuGroupId, i, Menu.NONE, formatSpeed(PLAYBACK_SPEEDS[i]));</span>
        }
<span class="nc" id="L279">        playbackSpeedTextView.setText(formatSpeed(getPlaybackSpeed()));</span>
<span class="nc" id="L280">        playbackSpeedPopupMenu.setOnMenuItemClickListener(this);</span>
<span class="nc" id="L281">        playbackSpeedPopupMenu.setOnDismissListener(this);</span>
<span class="nc" id="L282">    }</span>

    private void buildCaptionMenu(final List&lt;String&gt; availableLanguages) {
<span class="nc bnc" id="L285" title="All 2 branches missed.">        if (captionPopupMenu == null) return;</span>
<span class="nc" id="L286">        captionPopupMenu.getMenu().removeGroup(captionPopupMenuGroupId);</span>

        // Add option for turning off caption
<span class="nc" id="L289">        MenuItem captionOffItem = captionPopupMenu.getMenu().add(captionPopupMenuGroupId,</span>
                0, Menu.NONE, R.string.caption_none);
<span class="nc" id="L291">        captionOffItem.setOnMenuItemClickListener(menuItem -&gt; {</span>
<span class="nc" id="L292">            final int textRendererIndex = getRendererIndex(C.TRACK_TYPE_TEXT);</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">            if (textRendererIndex != RENDERER_UNAVAILABLE) {</span>
<span class="nc" id="L294">                trackSelector.setParameters(trackSelector.buildUponParameters()</span>
<span class="nc" id="L295">                        .setRendererDisabled(textRendererIndex, true));</span>
            }
<span class="nc" id="L297">            return true;</span>
        });

        // Add all available captions
<span class="nc bnc" id="L301" title="All 2 branches missed.">        for (int i = 0; i &lt; availableLanguages.size(); i++) {</span>
<span class="nc" id="L302">            final String captionLanguage = availableLanguages.get(i);</span>
<span class="nc" id="L303">            MenuItem captionItem = captionPopupMenu.getMenu().add(captionPopupMenuGroupId,</span>
                    i + 1, Menu.NONE, captionLanguage);
<span class="nc" id="L305">            captionItem.setOnMenuItemClickListener(menuItem -&gt; {</span>
<span class="nc" id="L306">                final int textRendererIndex = getRendererIndex(C.TRACK_TYPE_TEXT);</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">                if (textRendererIndex != RENDERER_UNAVAILABLE) {</span>
<span class="nc" id="L308">                    trackSelector.setPreferredTextLanguage(captionLanguage);</span>
<span class="nc" id="L309">                    trackSelector.setParameters(trackSelector.buildUponParameters()</span>
<span class="nc" id="L310">                            .setRendererDisabled(textRendererIndex, false));</span>
                }
<span class="nc" id="L312">                return true;</span>
            });
        }
<span class="nc" id="L315">        captionPopupMenu.setOnDismissListener(this);</span>
<span class="nc" id="L316">    }</span>

    private void updateStreamRelatedViews() {
<span class="nc bnc" id="L319" title="All 2 branches missed.">        if (getCurrentMetadata() == null) return;</span>

<span class="nc" id="L321">        final MediaSourceTag tag = getCurrentMetadata();</span>
<span class="nc" id="L322">        final StreamInfo metadata = tag.getMetadata();</span>

<span class="nc" id="L324">        qualityTextView.setVisibility(View.GONE);</span>
<span class="nc" id="L325">        playbackSpeedTextView.setVisibility(View.GONE);</span>

<span class="nc" id="L327">        playbackEndTime.setVisibility(View.GONE);</span>
<span class="nc" id="L328">        playbackLiveSync.setVisibility(View.GONE);</span>

<span class="nc bnc" id="L330" title="All 5 branches missed.">        switch (metadata.getStreamType()) {</span>
            case AUDIO_STREAM:
<span class="nc" id="L332">                surfaceView.setVisibility(View.GONE);</span>
<span class="nc" id="L333">                endScreen.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L334">                playbackEndTime.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L335">                break;</span>

            case AUDIO_LIVE_STREAM:
<span class="nc" id="L338">                surfaceView.setVisibility(View.GONE);</span>
<span class="nc" id="L339">                endScreen.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L340">                playbackLiveSync.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L341">                break;</span>

            case LIVE_STREAM:
<span class="nc" id="L344">                surfaceView.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L345">                endScreen.setVisibility(View.GONE);</span>
<span class="nc" id="L346">                playbackLiveSync.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L347">                break;</span>

            case VIDEO_STREAM:
<span class="nc bnc" id="L350" title="All 2 branches missed.">                if (metadata.getVideoStreams().size() + metadata.getVideoOnlyStreams().size() == 0)</span>
<span class="nc" id="L351">                    break;</span>

<span class="nc" id="L353">                availableStreams = tag.getSortedAvailableVideoStreams();</span>
<span class="nc" id="L354">                selectedStreamIndex = tag.getSelectedVideoStreamIndex();</span>
<span class="nc" id="L355">                buildQualityMenu();</span>

<span class="nc" id="L357">                qualityTextView.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L358">                surfaceView.setVisibility(View.VISIBLE);</span>
            default:
<span class="nc" id="L360">                endScreen.setVisibility(View.GONE);</span>
<span class="nc" id="L361">                playbackEndTime.setVisibility(View.VISIBLE);</span>
                break;
        }

<span class="nc" id="L365">        buildPlaybackSpeedMenu();</span>
<span class="nc" id="L366">        playbackSpeedTextView.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L367">    }</span>
    /*//////////////////////////////////////////////////////////////////////////
    // Playback Listener
    //////////////////////////////////////////////////////////////////////////*/

    protected abstract VideoPlaybackResolver.QualityResolver getQualityResolver();

    protected void onMetadataChanged(@NonNull final MediaSourceTag tag) {
<span class="nc" id="L375">        super.onMetadataChanged(tag);</span>
<span class="nc" id="L376">        updateStreamRelatedViews();</span>
<span class="nc" id="L377">    }</span>

    @Override
    @Nullable
    public MediaSource sourceOf(final PlayQueueItem item, final StreamInfo info) {
<span class="nc" id="L382">        return resolver.resolve(info);</span>
    }

    /*//////////////////////////////////////////////////////////////////////////
    // States Implementation
    //////////////////////////////////////////////////////////////////////////*/

    @Override
    public void onBlocked() {
<span class="nc" id="L391">        super.onBlocked();</span>

<span class="nc" id="L393">        controlsVisibilityHandler.removeCallbacksAndMessages(null);</span>
<span class="nc" id="L394">        animateView(controlsRoot, false, DEFAULT_CONTROLS_DURATION);</span>

<span class="nc" id="L396">        playbackSeekBar.setEnabled(false);</span>
        // Bug on lower api, disabling and enabling the seekBar resets the thumb color -.-, so sets the color again
<span class="nc bnc" id="L398" title="All 2 branches missed.">        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN)</span>
<span class="nc" id="L399">            playbackSeekBar.getThumb().setColorFilter(Color.RED, PorterDuff.Mode.SRC_IN);</span>

<span class="nc" id="L401">        loadingPanel.setBackgroundColor(Color.BLACK);</span>
<span class="nc" id="L402">        animateView(loadingPanel, true, 0);</span>
<span class="nc" id="L403">        animateView(surfaceForeground, true, 100);</span>
<span class="nc" id="L404">    }</span>

    @Override
    public void onPlaying() {
<span class="nc" id="L408">        super.onPlaying();</span>

<span class="nc" id="L410">        updateStreamRelatedViews();</span>

<span class="nc" id="L412">        showAndAnimateControl(-1, true);</span>

<span class="nc" id="L414">        playbackSeekBar.setEnabled(true);</span>
        // Bug on lower api, disabling and enabling the seekBar resets the thumb color -.-, so sets the color again
<span class="nc bnc" id="L416" title="All 2 branches missed.">        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN)</span>
<span class="nc" id="L417">            playbackSeekBar.getThumb().setColorFilter(Color.RED, PorterDuff.Mode.SRC_IN);</span>

<span class="nc" id="L419">        loadingPanel.setVisibility(View.GONE);</span>

<span class="nc" id="L421">        animateView(currentDisplaySeek, AnimationUtils.Type.SCALE_AND_ALPHA, false, 200);</span>
<span class="nc" id="L422">    }</span>

    @Override
    public void onBuffering() {
<span class="nc bnc" id="L426" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onBuffering() called&quot;);</span>
<span class="nc" id="L427">        loadingPanel.setBackgroundColor(Color.TRANSPARENT);</span>
<span class="nc" id="L428">    }</span>

    @Override
    public void onPaused() {
<span class="nc bnc" id="L432" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onPaused() called&quot;);</span>
<span class="nc" id="L433">        showControls(400);</span>
<span class="nc" id="L434">        loadingPanel.setVisibility(View.GONE);</span>
<span class="nc" id="L435">    }</span>

    @Override
    public void onPausedSeek() {
<span class="nc bnc" id="L439" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onPausedSeek() called&quot;);</span>
<span class="nc" id="L440">        showAndAnimateControl(-1, true);</span>
<span class="nc" id="L441">    }</span>

    @Override
    public void onCompleted() {
<span class="nc" id="L445">        super.onCompleted();</span>

<span class="nc" id="L447">        showControls(500);</span>
<span class="nc" id="L448">        animateView(endScreen, true, 800);</span>
<span class="nc" id="L449">        animateView(currentDisplaySeek, AnimationUtils.Type.SCALE_AND_ALPHA, false, 200);</span>
<span class="nc" id="L450">        loadingPanel.setVisibility(View.GONE);</span>

<span class="nc" id="L452">        animateView(surfaceForeground, true, 100);</span>
<span class="nc" id="L453">    }</span>

    /*//////////////////////////////////////////////////////////////////////////
    // ExoPlayer Video Listener
    //////////////////////////////////////////////////////////////////////////*/

    @Override
    public void onTracksChanged(TrackGroupArray trackGroups, TrackSelectionArray trackSelections) {
<span class="nc" id="L461">        super.onTracksChanged(trackGroups, trackSelections);</span>
<span class="nc" id="L462">        onTextTrackUpdate();</span>
<span class="nc" id="L463">    }</span>

    @Override
    public void onPlaybackParametersChanged(PlaybackParameters playbackParameters) {
<span class="nc" id="L467">        super.onPlaybackParametersChanged(playbackParameters);</span>
<span class="nc" id="L468">        playbackSpeedTextView.setText(formatSpeed(playbackParameters.speed));</span>
<span class="nc" id="L469">    }</span>

    @Override
    public void onVideoSizeChanged(int width, int height, int unappliedRotationDegrees, float pixelWidthHeightRatio) {
<span class="nc bnc" id="L473" title="All 2 branches missed.">        if (DEBUG) {</span>
<span class="nc" id="L474">            Log.d(TAG, &quot;onVideoSizeChanged() called with: width / height = [&quot; + width + &quot; / &quot; + height + &quot; = &quot; + (((float) width) / height) + &quot;], unappliedRotationDegrees = [&quot; + unappliedRotationDegrees + &quot;], pixelWidthHeightRatio = [&quot; + pixelWidthHeightRatio + &quot;]&quot;);</span>
        }
<span class="nc" id="L476">        aspectRatioFrameLayout.setAspectRatio(((float) width) / height);</span>
<span class="nc" id="L477">    }</span>

    @Override
    public void onRenderedFirstFrame() {
<span class="nc" id="L481">        animateView(surfaceForeground, false, 100);</span>
<span class="nc" id="L482">    }</span>

    /*//////////////////////////////////////////////////////////////////////////
    // ExoPlayer Track Updates
    //////////////////////////////////////////////////////////////////////////*/

    private void onTextTrackUpdate() {
<span class="nc" id="L489">        final int textRenderer = getRendererIndex(C.TRACK_TYPE_TEXT);</span>

<span class="nc bnc" id="L491" title="All 2 branches missed.">        if (captionTextView == null) return;</span>
<span class="nc bnc" id="L492" title="All 4 branches missed.">        if (trackSelector.getCurrentMappedTrackInfo() == null || textRenderer == RENDERER_UNAVAILABLE) {</span>
<span class="nc" id="L493">            captionTextView.setVisibility(View.GONE);</span>
<span class="nc" id="L494">            return;</span>
        }

<span class="nc" id="L497">        final TrackGroupArray textTracks = trackSelector.getCurrentMappedTrackInfo()</span>
<span class="nc" id="L498">                .getTrackGroups(textRenderer);</span>

        // Extract all loaded languages
<span class="nc" id="L501">        List&lt;String&gt; availableLanguages = new ArrayList&lt;&gt;(textTracks.length);</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">        for (int i = 0; i &lt; textTracks.length; i++) {</span>
<span class="nc" id="L503">            final TrackGroup textTrack = textTracks.get(i);</span>
<span class="nc bnc" id="L504" title="All 4 branches missed.">            if (textTrack.length &gt; 0 &amp;&amp; textTrack.getFormat(0) != null) {</span>
<span class="nc" id="L505">                availableLanguages.add(textTrack.getFormat(0).language);</span>
            }
        }

        // Normalize mismatching language strings
<span class="nc" id="L510">        final String preferredLanguage = trackSelector.getPreferredTextLanguage();</span>
        // Build UI
<span class="nc" id="L512">        buildCaptionMenu(availableLanguages);</span>
<span class="nc bnc" id="L513" title="All 4 branches missed.">        if (trackSelector.getParameters().getRendererDisabled(textRenderer) ||</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">                preferredLanguage == null || (!availableLanguages.contains(preferredLanguage)</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">                &amp;&amp; !containsCaseInsensitive(availableLanguages, preferredLanguage))) {</span>
<span class="nc" id="L516">            captionTextView.setText(R.string.caption_none);</span>
        } else {
<span class="nc" id="L518">            captionTextView.setText(preferredLanguage);</span>
        }
<span class="nc bnc" id="L520" title="All 2 branches missed.">        captionTextView.setVisibility(availableLanguages.isEmpty() ? View.GONE : View.VISIBLE);</span>
<span class="nc" id="L521">    }</span>

    // workaround to match normalized captions like english to English or deutsch to Deutsch
    private static boolean containsCaseInsensitive(List&lt;String&gt; list, String toFind) {
<span class="nc bnc" id="L525" title="All 2 branches missed.">        for(String i : list){</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">            if(i.equalsIgnoreCase(toFind))</span>
<span class="nc" id="L527">                return true;</span>
<span class="nc" id="L528">        }</span>
<span class="nc" id="L529">        return false;</span>
    }

    /*//////////////////////////////////////////////////////////////////////////
    // General Player
    //////////////////////////////////////////////////////////////////////////*/

    @Override
    public void onPrepared(boolean playWhenReady) {
<span class="nc bnc" id="L538" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onPrepared() called with: playWhenReady = [&quot; + playWhenReady + &quot;]&quot;);</span>

<span class="nc" id="L540">        playbackSeekBar.setMax((int) simpleExoPlayer.getDuration());</span>
<span class="nc" id="L541">        playbackEndTime.setText(getTimeString((int) simpleExoPlayer.getDuration()));</span>
<span class="nc" id="L542">        playbackSpeedTextView.setText(formatSpeed(getPlaybackSpeed()));</span>

<span class="nc" id="L544">        super.onPrepared(playWhenReady);</span>

<span class="nc bnc" id="L546" title="All 4 branches missed.">        if (simpleExoPlayer.getCurrentPosition() != 0 &amp;&amp; !isControlsVisible()) {</span>
<span class="nc" id="L547">            controlsVisibilityHandler.removeCallbacksAndMessages(null);</span>
<span class="nc" id="L548">            controlsVisibilityHandler.postDelayed(this::showControlsThenHide, DEFAULT_CONTROLS_DURATION);</span>
        }
<span class="nc" id="L550">    }</span>

    @Override
    public void destroy() {
<span class="nc" id="L554">        super.destroy();</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">        if (endScreen != null) endScreen.setImageBitmap(null);</span>
<span class="nc" id="L556">    }</span>

    @Override
    public void onUpdateProgress(int currentProgress, int duration, int bufferPercent) {
<span class="nc bnc" id="L560" title="All 2 branches missed.">        if (!isPrepared()) return;</span>

<span class="nc bnc" id="L562" title="All 2 branches missed.">        if (duration != playbackSeekBar.getMax()) {</span>
<span class="nc" id="L563">            playbackEndTime.setText(getTimeString(duration));</span>
<span class="nc" id="L564">            playbackSeekBar.setMax(duration);</span>
        }
<span class="nc bnc" id="L566" title="All 2 branches missed.">        if (currentState != STATE_PAUSED) {</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">            if (currentState != STATE_PAUSED_SEEK) playbackSeekBar.setProgress(currentProgress);</span>
<span class="nc" id="L568">            playbackCurrentTime.setText(getTimeString(currentProgress));</span>
        }
<span class="nc bnc" id="L570" title="All 4 branches missed.">        if (simpleExoPlayer.isLoading() || bufferPercent &gt; 90) {</span>
<span class="nc" id="L571">            playbackSeekBar.setSecondaryProgress((int) (playbackSeekBar.getMax() * ((float) bufferPercent / 100)));</span>
        }
<span class="nc bnc" id="L573" title="All 4 branches missed.">        if (DEBUG &amp;&amp; bufferPercent % 20 == 0) { //Limit log</span>
<span class="nc" id="L574">            Log.d(TAG, &quot;updateProgress() called with: isVisible = &quot; + isControlsVisible() + &quot;, currentProgress = [&quot; + currentProgress + &quot;], duration = [&quot; + duration + &quot;], bufferPercent = [&quot; + bufferPercent + &quot;]&quot;);</span>
        }
<span class="nc bnc" id="L576" title="All 2 branches missed.">        playbackLiveSync.setClickable(!isLiveEdge());</span>
<span class="nc" id="L577">    }</span>

    @Override
    public void onLoadingComplete(String imageUri, View view, Bitmap loadedImage) {
<span class="nc" id="L581">        super.onLoadingComplete(imageUri, view, loadedImage);</span>
<span class="nc bnc" id="L582" title="All 2 branches missed.">        if (loadedImage != null) endScreen.setImageBitmap(loadedImage);</span>
<span class="nc" id="L583">    }</span>

    protected void onFullScreenButtonClicked() {
<span class="nc" id="L586">        changeState(STATE_BLOCKED);</span>
<span class="nc" id="L587">    }</span>

    @Override
    public void onFastRewind() {
<span class="nc" id="L591">        super.onFastRewind();</span>
<span class="nc" id="L592">        showAndAnimateControl(R.drawable.ic_action_av_fast_rewind, true);</span>
<span class="nc" id="L593">    }</span>

    @Override
    public void onFastForward() {
<span class="nc" id="L597">        super.onFastForward();</span>
<span class="nc" id="L598">        showAndAnimateControl(R.drawable.ic_action_av_fast_forward, true);</span>
<span class="nc" id="L599">    }</span>

    /*//////////////////////////////////////////////////////////////////////////
    // OnClick related
    //////////////////////////////////////////////////////////////////////////*/

    @Override
    public void onClick(View v) {
<span class="nc bnc" id="L607" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onClick() called with: v = [&quot; + v + &quot;]&quot;);</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">        if (v.getId() == qualityTextView.getId()) {</span>
<span class="nc" id="L609">            onQualitySelectorClicked();</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">        } else if (v.getId() == playbackSpeedTextView.getId()) {</span>
<span class="nc" id="L611">            onPlaybackSpeedClicked();</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">        } else if (v.getId() == resizeView.getId()) {</span>
<span class="nc" id="L613">            onResizeClicked();</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">        } else if (v.getId() == captionTextView.getId()) {</span>
<span class="nc" id="L615">            onCaptionClicked();</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">        } else if (v.getId() == playbackLiveSync.getId()) {</span>
<span class="nc" id="L617">            seekToDefault();</span>
        }
<span class="nc" id="L619">    }</span>

    /**
     * Called when an item of the quality selector or the playback speed selector is selected
     */
    @Override
    public boolean onMenuItemClick(MenuItem menuItem) {
<span class="nc bnc" id="L626" title="All 2 branches missed.">        if (DEBUG)</span>
<span class="nc" id="L627">            Log.d(TAG, &quot;onMenuItemClick() called with: menuItem = [&quot; + menuItem + &quot;], menuItem.getItemId = [&quot; + menuItem.getItemId() + &quot;]&quot;);</span>

<span class="nc bnc" id="L629" title="All 2 branches missed.">        if (qualityPopupMenuGroupId == menuItem.getGroupId()) {</span>
<span class="nc" id="L630">            final int menuItemIndex = menuItem.getItemId();</span>
<span class="nc bnc" id="L631" title="All 4 branches missed.">            if (selectedStreamIndex == menuItemIndex ||</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">                    availableStreams == null || availableStreams.size() &lt;= menuItemIndex) return true;</span>

<span class="nc" id="L634">            final String newResolution = availableStreams.get(menuItemIndex).resolution;</span>
<span class="nc" id="L635">            setRecovery();</span>
<span class="nc" id="L636">            setPlaybackQuality(newResolution);</span>
<span class="nc" id="L637">            reload();</span>

<span class="nc" id="L639">            qualityTextView.setText(menuItem.getTitle());</span>
<span class="nc" id="L640">            return true;</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">        } else if (playbackSpeedPopupMenuGroupId == menuItem.getGroupId()) {</span>
<span class="nc" id="L642">            int speedIndex = menuItem.getItemId();</span>
<span class="nc" id="L643">            float speed = PLAYBACK_SPEEDS[speedIndex];</span>

<span class="nc" id="L645">            setPlaybackSpeed(speed);</span>
<span class="nc" id="L646">            playbackSpeedTextView.setText(formatSpeed(speed));</span>
        }

<span class="nc" id="L649">        return false;</span>
    }

    /**
     * Called when some popup menu is dismissed
     */
    @Override
    public void onDismiss(PopupMenu menu) {
<span class="nc bnc" id="L657" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onDismiss() called with: menu = [&quot; + menu + &quot;]&quot;);</span>
<span class="nc" id="L658">        isSomePopupMenuVisible = false;</span>
<span class="nc bnc" id="L659" title="All 2 branches missed.">        if (getSelectedVideoStream() != null) {</span>
<span class="nc" id="L660">            qualityTextView.setText(getSelectedVideoStream().resolution);</span>
        }
<span class="nc" id="L662">    }</span>

    public void onQualitySelectorClicked() {
<span class="nc bnc" id="L665" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onQualitySelectorClicked() called&quot;);</span>
<span class="nc" id="L666">        qualityPopupMenu.show();</span>
<span class="nc" id="L667">        isSomePopupMenuVisible = true;</span>
<span class="nc" id="L668">        showControls(DEFAULT_CONTROLS_DURATION);</span>

<span class="nc" id="L670">        final VideoStream videoStream = getSelectedVideoStream();</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">        if (videoStream != null) {</span>
<span class="nc" id="L672">            final String qualityText = MediaFormat.getNameById(videoStream.getFormatId()) + &quot; &quot;</span>
                    + videoStream.resolution;
<span class="nc" id="L674">            qualityTextView.setText(qualityText);</span>
        }

<span class="nc" id="L677">        wasPlaying = simpleExoPlayer.getPlayWhenReady();</span>
<span class="nc" id="L678">    }</span>

    public void onPlaybackSpeedClicked() {
<span class="nc bnc" id="L681" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onPlaybackSpeedClicked() called&quot;);</span>
<span class="nc" id="L682">        playbackSpeedPopupMenu.show();</span>
<span class="nc" id="L683">        isSomePopupMenuVisible = true;</span>
<span class="nc" id="L684">        showControls(DEFAULT_CONTROLS_DURATION);</span>
<span class="nc" id="L685">    }</span>

    private void onCaptionClicked() {
<span class="nc bnc" id="L688" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onCaptionClicked() called&quot;);</span>
<span class="nc" id="L689">        captionPopupMenu.show();</span>
<span class="nc" id="L690">        isSomePopupMenuVisible = true;</span>
<span class="nc" id="L691">        showControls(DEFAULT_CONTROLS_DURATION);</span>
<span class="nc" id="L692">    }</span>

    private void onResizeClicked() {
<span class="nc bnc" id="L695" title="All 2 branches missed.">        if (getAspectRatioFrameLayout() != null) {</span>
<span class="nc" id="L696">            final int currentResizeMode = getAspectRatioFrameLayout().getResizeMode();</span>
<span class="nc" id="L697">            final int newResizeMode = nextResizeMode(currentResizeMode);</span>
<span class="nc" id="L698">            setResizeMode(newResizeMode);</span>
        }
<span class="nc" id="L700">    }</span>

    protected void setResizeMode(@AspectRatioFrameLayout.ResizeMode final int resizeMode) {
<span class="nc" id="L703">        getAspectRatioFrameLayout().setResizeMode(resizeMode);</span>
<span class="nc" id="L704">        getResizeView().setText(PlayerHelper.resizeTypeOf(context, resizeMode));</span>
<span class="nc" id="L705">    }</span>

    protected abstract int nextResizeMode(@AspectRatioFrameLayout.ResizeMode final int resizeMode);

    /*//////////////////////////////////////////////////////////////////////////
    // SeekBar Listener
    //////////////////////////////////////////////////////////////////////////*/

    @Override
    public void onProgressChanged(SeekBar seekBar, int progress, boolean fromUser) {
<span class="nc bnc" id="L715" title="All 4 branches missed.">        if (DEBUG &amp;&amp; fromUser) Log.d(TAG, &quot;onProgressChanged() called with: seekBar = [&quot; + seekBar + &quot;], progress = [&quot; + progress + &quot;]&quot;);</span>
        //if (fromUser) playbackCurrentTime.setText(getTimeString(progress));
<span class="nc bnc" id="L717" title="All 2 branches missed.">        if (fromUser) currentDisplaySeek.setText(getTimeString(progress));</span>
<span class="nc" id="L718">    }</span>

    @Override
    public void onStartTrackingTouch(SeekBar seekBar) {
<span class="nc bnc" id="L722" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onStartTrackingTouch() called with: seekBar = [&quot; + seekBar + &quot;]&quot;);</span>
<span class="nc bnc" id="L723" title="All 2 branches missed.">        if (getCurrentState() != STATE_PAUSED_SEEK) changeState(STATE_PAUSED_SEEK);</span>

<span class="nc" id="L725">        wasPlaying = simpleExoPlayer.getPlayWhenReady();</span>
<span class="nc bnc" id="L726" title="All 2 branches missed.">        if (isPlaying()) simpleExoPlayer.setPlayWhenReady(false);</span>

<span class="nc" id="L728">        showControls(0);</span>
<span class="nc" id="L729">        animateView(currentDisplaySeek, AnimationUtils.Type.SCALE_AND_ALPHA, true,</span>
                DEFAULT_CONTROLS_DURATION);
<span class="nc" id="L731">    }</span>

    @Override
    public void onStopTrackingTouch(SeekBar seekBar) {
<span class="nc bnc" id="L735" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onStopTrackingTouch() called with: seekBar = [&quot; + seekBar + &quot;]&quot;);</span>

<span class="nc" id="L737">        seekTo(seekBar.getProgress());</span>
<span class="nc bnc" id="L738" title="All 4 branches missed.">        if (wasPlaying || simpleExoPlayer.getDuration() == seekBar.getProgress()) simpleExoPlayer.setPlayWhenReady(true);</span>

<span class="nc" id="L740">        playbackCurrentTime.setText(getTimeString(seekBar.getProgress()));</span>
<span class="nc" id="L741">        animateView(currentDisplaySeek, AnimationUtils.Type.SCALE_AND_ALPHA, false, 200);</span>

<span class="nc bnc" id="L743" title="All 2 branches missed.">        if (getCurrentState() == STATE_PAUSED_SEEK) changeState(STATE_BUFFERING);</span>
<span class="nc bnc" id="L744" title="All 2 branches missed.">        if (!isProgressLoopRunning()) startProgressLoop();</span>
<span class="nc" id="L745">    }</span>

    /*//////////////////////////////////////////////////////////////////////////
    // Utils
    //////////////////////////////////////////////////////////////////////////*/

    public int getRendererIndex(final int trackIndex) {
<span class="nc bnc" id="L752" title="All 2 branches missed.">        if (simpleExoPlayer == null) return RENDERER_UNAVAILABLE;</span>

<span class="nc bnc" id="L754" title="All 2 branches missed.">        for (int t = 0; t &lt; simpleExoPlayer.getRendererCount(); t++) {</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">            if (simpleExoPlayer.getRendererType(t) == trackIndex) {</span>
<span class="nc" id="L756">                return t;</span>
            }
        }

<span class="nc" id="L760">        return RENDERER_UNAVAILABLE;</span>
    }

    public boolean isControlsVisible() {
<span class="nc bnc" id="L764" title="All 4 branches missed.">        return controlsRoot != null &amp;&amp; controlsRoot.getVisibility() == View.VISIBLE;</span>
    }

    /**
     * Show a animation, and depending on goneOnEnd, will stay on the screen or be gone
     *
     * @param drawableId the drawable that will be used to animate, pass -1 to clear any animation that is visible
     * @param goneOnEnd  will set the animation view to GONE on the end of the animation
     */
    public void showAndAnimateControl(final int drawableId, final boolean goneOnEnd) {
<span class="nc bnc" id="L774" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;showAndAnimateControl() called with: drawableId = [&quot; + drawableId + &quot;], goneOnEnd = [&quot; + goneOnEnd + &quot;]&quot;);</span>
<span class="nc bnc" id="L775" title="All 4 branches missed.">        if (controlViewAnimator != null &amp;&amp; controlViewAnimator.isRunning()) {</span>
<span class="nc bnc" id="L776" title="All 2 branches missed.">            if (DEBUG) Log.d(TAG, &quot;showAndAnimateControl: controlViewAnimator.isRunning&quot;);</span>
<span class="nc" id="L777">            controlViewAnimator.end();</span>
        }

<span class="nc bnc" id="L780" title="All 2 branches missed.">        if (drawableId == -1) {</span>
<span class="nc bnc" id="L781" title="All 2 branches missed.">            if (controlAnimationView.getVisibility() == View.VISIBLE) {</span>
<span class="nc" id="L782">                controlViewAnimator = ObjectAnimator.ofPropertyValuesHolder(controlAnimationView,</span>
<span class="nc" id="L783">                        PropertyValuesHolder.ofFloat(View.ALPHA, 1f, 0f),</span>
<span class="nc" id="L784">                        PropertyValuesHolder.ofFloat(View.SCALE_X, 1.4f, 1f),</span>
<span class="nc" id="L785">                        PropertyValuesHolder.ofFloat(View.SCALE_Y, 1.4f, 1f)</span>
<span class="nc" id="L786">                ).setDuration(DEFAULT_CONTROLS_DURATION);</span>
<span class="nc" id="L787">                controlViewAnimator.addListener(new AnimatorListenerAdapter() {</span>
                    @Override
                    public void onAnimationEnd(Animator animation) {
<span class="nc" id="L790">                        controlAnimationView.setVisibility(View.GONE);</span>
<span class="nc" id="L791">                    }</span>
                });
<span class="nc" id="L793">                controlViewAnimator.start();</span>
            }
<span class="nc" id="L795">            return;</span>
        }

<span class="nc bnc" id="L798" title="All 4 branches missed.">        float scaleFrom = goneOnEnd ? 1f : 1f, scaleTo = goneOnEnd ? 1.8f : 1.4f;</span>
<span class="nc bnc" id="L799" title="All 4 branches missed.">        float alphaFrom = goneOnEnd ? 1f : 0f, alphaTo = goneOnEnd ? 0f : 1f;</span>


<span class="nc" id="L802">        controlViewAnimator = ObjectAnimator.ofPropertyValuesHolder(controlAnimationView,</span>
<span class="nc" id="L803">                PropertyValuesHolder.ofFloat(View.ALPHA, alphaFrom, alphaTo),</span>
<span class="nc" id="L804">                PropertyValuesHolder.ofFloat(View.SCALE_X, scaleFrom, scaleTo),</span>
<span class="nc" id="L805">                PropertyValuesHolder.ofFloat(View.SCALE_Y, scaleFrom, scaleTo)</span>
        );
<span class="nc bnc" id="L807" title="All 2 branches missed.">        controlViewAnimator.setDuration(goneOnEnd ? 1000 : 500);</span>
<span class="nc" id="L808">        controlViewAnimator.addListener(new AnimatorListenerAdapter() {</span>
            @Override
            public void onAnimationEnd(Animator animation) {
<span class="nc bnc" id="L811" title="All 2 branches missed.">                if (goneOnEnd) controlAnimationView.setVisibility(View.GONE);</span>
<span class="nc" id="L812">                else controlAnimationView.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L813">            }</span>
        });


<span class="nc" id="L817">        controlAnimationView.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L818">        controlAnimationView.setImageDrawable(ContextCompat.getDrawable(context, drawableId));</span>
<span class="nc" id="L819">        controlViewAnimator.start();</span>
<span class="nc" id="L820">    }</span>

    public boolean isSomePopupMenuVisible() {
<span class="nc" id="L823">        return isSomePopupMenuVisible;</span>
    }

    public void showControlsThenHide() {
<span class="nc bnc" id="L827" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;showControlsThenHide() called&quot;);</span>
<span class="nc" id="L828">        animateView(controlsRoot, true, DEFAULT_CONTROLS_DURATION, 0,</span>
<span class="nc" id="L829">                () -&gt; hideControls(DEFAULT_CONTROLS_DURATION, DEFAULT_CONTROLS_HIDE_TIME));</span>
<span class="nc" id="L830">    }</span>

    public void showControls(long duration) {
<span class="nc bnc" id="L833" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;showControls() called&quot;);</span>
<span class="nc" id="L834">        controlsVisibilityHandler.removeCallbacksAndMessages(null);</span>
<span class="nc" id="L835">        animateView(controlsRoot, true, duration);</span>
<span class="nc" id="L836">    }</span>

    public void hideControls(final long duration, long delay) {
<span class="nc bnc" id="L839" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;hideControls() called with: delay = [&quot; + delay + &quot;]&quot;);</span>
<span class="nc" id="L840">        controlsVisibilityHandler.removeCallbacksAndMessages(null);</span>
<span class="nc" id="L841">        controlsVisibilityHandler.postDelayed(</span>
<span class="nc" id="L842">                () -&gt; animateView(controlsRoot, false, duration), delay);</span>
<span class="nc" id="L843">    }</span>

    public void hideControlsAndButton(final long duration, long delay, View button) {
<span class="nc bnc" id="L846" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;hideControls() called with: delay = [&quot; + delay + &quot;]&quot;);</span>
<span class="nc" id="L847">        controlsVisibilityHandler.removeCallbacksAndMessages(null);</span>
<span class="nc" id="L848">        controlsVisibilityHandler.postDelayed(hideControlsAndButtonHandler(duration, button), delay);</span>
<span class="nc" id="L849">    }</span>

    private Runnable hideControlsAndButtonHandler(long duration, View videoPlayPause)
    {
<span class="nc" id="L853">        return () -&gt; {</span>
<span class="nc" id="L854">            videoPlayPause.setVisibility(View.INVISIBLE);</span>
<span class="nc" id="L855">            animateView(controlsRoot, false,duration);</span>
<span class="nc" id="L856">        };</span>
    }
    /*//////////////////////////////////////////////////////////////////////////
    // Getters and Setters
    //////////////////////////////////////////////////////////////////////////*/

    public void setPlaybackQuality(final String quality) {
<span class="nc" id="L863">        this.resolver.setPlaybackQuality(quality);</span>
<span class="nc" id="L864">    }</span>

    @Nullable
    public String getPlaybackQuality() {
<span class="nc" id="L868">        return resolver.getPlaybackQuality();</span>
    }

    public AspectRatioFrameLayout getAspectRatioFrameLayout() {
<span class="nc" id="L872">        return aspectRatioFrameLayout;</span>
    }

    public SurfaceView getSurfaceView() {
<span class="nc" id="L876">        return surfaceView;</span>
    }

    public boolean wasPlaying() {
<span class="nc" id="L880">        return wasPlaying;</span>
    }

    @Nullable
    public VideoStream getSelectedVideoStream() {
<span class="nc bnc" id="L885" title="All 4 branches missed.">        return (selectedStreamIndex &gt;= 0 &amp;&amp; availableStreams != null &amp;&amp;</span>
<span class="nc bnc" id="L886" title="All 2 branches missed.">                availableStreams.size() &gt; selectedStreamIndex) ?</span>
<span class="nc" id="L887">                availableStreams.get(selectedStreamIndex) : null;</span>
    }

    public Handler getControlsVisibilityHandler() {
<span class="nc" id="L891">        return controlsVisibilityHandler;</span>
    }

    public View getRootView() {
<span class="nc" id="L895">        return rootView;</span>
    }

    public void setRootView(View rootView) {
<span class="nc" id="L899">        this.rootView = rootView;</span>
<span class="nc" id="L900">    }</span>

    public View getLoadingPanel() {
<span class="nc" id="L903">        return loadingPanel;</span>
    }

    public ImageView getEndScreen() {
<span class="nc" id="L907">        return endScreen;</span>
    }

    public ImageView getControlAnimationView() {
<span class="nc" id="L911">        return controlAnimationView;</span>
    }

    public View getControlsRoot() {
<span class="nc" id="L915">        return controlsRoot;</span>
    }

    public View getBottomControlsRoot() {
<span class="nc" id="L919">        return bottomControlsRoot;</span>
    }

    public SeekBar getPlaybackSeekBar() {
<span class="nc" id="L923">        return playbackSeekBar;</span>
    }

    public TextView getPlaybackCurrentTime() {
<span class="nc" id="L927">        return playbackCurrentTime;</span>
    }

    public TextView getPlaybackEndTime() {
<span class="nc" id="L931">        return playbackEndTime;</span>
    }

    public View getTopControlsRoot() {
<span class="nc" id="L935">        return topControlsRoot;</span>
    }

    public TextView getQualityTextView() {
<span class="nc" id="L939">        return qualityTextView;</span>
    }

    public PopupMenu getQualityPopupMenu() {
<span class="nc" id="L943">        return qualityPopupMenu;</span>
    }

    public PopupMenu getPlaybackSpeedPopupMenu() {
<span class="nc" id="L947">        return playbackSpeedPopupMenu;</span>
    }

    public View getSurfaceForeground() {
<span class="nc" id="L951">        return surfaceForeground;</span>
    }

    public TextView getCurrentDisplaySeek() {
<span class="nc" id="L955">        return currentDisplaySeek;</span>
    }

    public SubtitleView getSubtitleView() {
<span class="nc" id="L959">        return subtitleView;</span>
    }

    public TextView getResizeView() {
<span class="nc" id="L963">        return resizeView;</span>
    }

    public TextView getCaptionTextView() {
<span class="nc" id="L967">        return captionTextView;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span>Generated by the Android Gradle plugin 3.2.0</div></body></html>