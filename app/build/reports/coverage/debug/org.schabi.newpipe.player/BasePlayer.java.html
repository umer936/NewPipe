<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BasePlayer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">debugAndroidTest</a> &gt; <a href="index.source.html" class="el_package">org.schabi.newpipe.player</a> &gt; <span class="el_source">BasePlayer.java</span></div><h1>BasePlayer.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2017 Mauricio Colli &lt;mauriciocolli@outlook.com&gt;
 * BasePlayer.java is part of NewPipe
 *
 * License: GPL-3.0+
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package org.schabi.newpipe.player;

import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.content.SharedPreferences;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.media.AudioManager;
import android.preference.PreferenceManager;
import android.support.annotation.NonNull;
import android.support.annotation.Nullable;
import android.util.Log;
import android.view.View;
import android.widget.Toast;

import com.google.android.exoplayer2.DefaultRenderersFactory;
import com.google.android.exoplayer2.ExoPlaybackException;
import com.google.android.exoplayer2.ExoPlayerFactory;
import com.google.android.exoplayer2.LoadControl;
import com.google.android.exoplayer2.PlaybackParameters;
import com.google.android.exoplayer2.Player;
import com.google.android.exoplayer2.RenderersFactory;
import com.google.android.exoplayer2.SimpleExoPlayer;
import com.google.android.exoplayer2.Timeline;
import com.google.android.exoplayer2.source.BehindLiveWindowException;
import com.google.android.exoplayer2.source.MediaSource;
import com.google.android.exoplayer2.source.TrackGroupArray;
import com.google.android.exoplayer2.trackselection.TrackSelection;
import com.google.android.exoplayer2.trackselection.TrackSelectionArray;
import com.google.android.exoplayer2.upstream.DefaultBandwidthMeter;
import com.nostra13.universalimageloader.core.ImageLoader;
import com.nostra13.universalimageloader.core.assist.FailReason;
import com.nostra13.universalimageloader.core.listener.ImageLoadingListener;

import org.schabi.newpipe.BuildConfig;
import org.schabi.newpipe.Downloader;
import org.schabi.newpipe.R;
import org.schabi.newpipe.extractor.stream.StreamInfo;
import org.schabi.newpipe.local.history.HistoryRecordManager;
import org.schabi.newpipe.player.helper.AudioReactor;
import org.schabi.newpipe.player.helper.LoadController;
import org.schabi.newpipe.player.helper.MediaSessionManager;
import org.schabi.newpipe.player.helper.PlayerDataSource;
import org.schabi.newpipe.player.helper.PlayerHelper;
import org.schabi.newpipe.player.mediasource.FailedMediaSource;
import org.schabi.newpipe.player.playback.BasePlayerMediaSession;
import org.schabi.newpipe.player.playback.CustomTrackSelector;
import org.schabi.newpipe.player.playback.MediaSourceManager;
import org.schabi.newpipe.player.playback.PlaybackListener;
import org.schabi.newpipe.player.playqueue.PlayQueue;
import org.schabi.newpipe.player.playqueue.PlayQueueAdapter;
import org.schabi.newpipe.player.playqueue.PlayQueueItem;
import org.schabi.newpipe.player.resolver.MediaSourceTag;
import org.schabi.newpipe.util.ImageDisplayConstants;
import org.schabi.newpipe.util.SerializedCache;

import java.io.IOException;
import java.net.UnknownHostException;
import java.util.concurrent.TimeUnit;

import io.reactivex.Observable;
import io.reactivex.android.schedulers.AndroidSchedulers;
import io.reactivex.disposables.CompositeDisposable;
import io.reactivex.disposables.Disposable;
import io.reactivex.disposables.SerialDisposable;

import static com.google.android.exoplayer2.Player.DISCONTINUITY_REASON_INTERNAL;
import static com.google.android.exoplayer2.Player.DISCONTINUITY_REASON_PERIOD_TRANSITION;
import static com.google.android.exoplayer2.Player.DISCONTINUITY_REASON_SEEK;
import static com.google.android.exoplayer2.Player.DISCONTINUITY_REASON_SEEK_ADJUSTMENT;

/**
 * Base for the players, joining the common properties
 *
 * @author mauriciocolli
 */
@SuppressWarnings({&quot;WeakerAccess&quot;})
public abstract class BasePlayer implements
        Player.EventListener, PlaybackListener, ImageLoadingListener {

<span class="nc bnc" id="L102" title="All 2 branches missed.">    public static final boolean DEBUG = !BuildConfig.BUILD_TYPE.equals(&quot;release&quot;);</span>
    @NonNull
    public static final String TAG = &quot;BasePlayer&quot;;

    @NonNull
    final protected Context context;

    @NonNull
    final protected BroadcastReceiver broadcastReceiver;
    @NonNull
    final protected IntentFilter intentFilter;

    @NonNull
    final protected HistoryRecordManager recordManager;

    @NonNull
    final protected CustomTrackSelector trackSelector;
    @NonNull
    final protected PlayerDataSource dataSource;

    @NonNull
    final private LoadControl loadControl;
    @NonNull
    final private RenderersFactory renderFactory;

    @NonNull
    final private SerialDisposable progressUpdateReactor;
    @NonNull
    final private CompositeDisposable databaseUpdateReactor;
    /*//////////////////////////////////////////////////////////////////////////
    // Intent
    //////////////////////////////////////////////////////////////////////////*/

    @NonNull
    public static final String REPEAT_MODE = &quot;repeat_mode&quot;;
    @NonNull
    public static final String PLAYBACK_PITCH = &quot;playback_pitch&quot;;
    @NonNull
    public static final String PLAYBACK_SPEED = &quot;playback_speed&quot;;
    @NonNull
    public static final String PLAYBACK_SKIP_SILENCE = &quot;playback_skip_silence&quot;;
    @NonNull
    public static final String PLAYBACK_QUALITY = &quot;playback_quality&quot;;
    @NonNull
    public static final String PLAY_QUEUE_KEY = &quot;play_queue_key&quot;;
    @NonNull
    public static final String APPEND_ONLY = &quot;append_only&quot;;
    @NonNull
    public static final String RESUME_PLAYBACK = &quot;resume_playback&quot;;
    @NonNull
    public static final String SELECT_ON_APPEND = &quot;select_on_append&quot;;

    /*//////////////////////////////////////////////////////////////////////////
    // Playback
    //////////////////////////////////////////////////////////////////////////*/

<span class="nc" id="L158">    protected static final float[] PLAYBACK_SPEEDS = {0.5f, 0.75f, 1f, 1.25f, 1.5f, 1.75f, 2f};</span>

    protected PlayQueue playQueue;
    protected PlayQueueAdapter playQueueAdapter;

    @Nullable
    protected MediaSourceManager playbackManager;

    @Nullable
    private PlayQueueItem currentItem;
    @Nullable
    private MediaSourceTag currentMetadata;
    @Nullable
    private Bitmap currentThumbnail;

    @Nullable
    protected Toast errorToast;

    /*//////////////////////////////////////////////////////////////////////////
    // Player
    //////////////////////////////////////////////////////////////////////////*/

    protected final static int FAST_FORWARD_REWIND_AMOUNT_MILLIS = 10000; // 10 Seconds
    protected final static int PLAY_PREV_ACTIVATION_LIMIT_MILLIS = 5000; // 5 seconds
    protected final static int PROGRESS_LOOP_INTERVAL_MILLIS = 500;
    protected final static int RECOVERY_SKIP_THRESHOLD_MILLIS = 3000; // 3 seconds

    protected SimpleExoPlayer simpleExoPlayer;
    protected AudioReactor audioReactor;
    protected MediaSessionManager mediaSessionManager;

<span class="nc" id="L189">    private boolean isPrepared = false;</span>
    private Disposable stateLoader;

    //////////////////////////////////////////////////////////////////////////*/

<span class="nc" id="L194">    public BasePlayer(@NonNull final Context context) {</span>
<span class="nc" id="L195">        this.context = context;</span>

<span class="nc" id="L197">        this.broadcastReceiver = new BroadcastReceiver() {</span>
            @Override
            public void onReceive(Context context, Intent intent) {
<span class="nc" id="L200">                onBroadcastReceived(intent);</span>
<span class="nc" id="L201">            }</span>
        };
<span class="nc" id="L203">        this.intentFilter = new IntentFilter();</span>
<span class="nc" id="L204">        setupBroadcastReceiver(intentFilter);</span>

<span class="nc" id="L206">        this.recordManager = new HistoryRecordManager(context);</span>

<span class="nc" id="L208">        this.progressUpdateReactor = new SerialDisposable();</span>
<span class="nc" id="L209">        this.databaseUpdateReactor = new CompositeDisposable();</span>

<span class="nc" id="L211">        final String userAgent = Downloader.USER_AGENT;</span>
<span class="nc" id="L212">        final DefaultBandwidthMeter bandwidthMeter = new DefaultBandwidthMeter();</span>
<span class="nc" id="L213">        this.dataSource = new PlayerDataSource(context, userAgent, bandwidthMeter);</span>

<span class="nc" id="L215">        final TrackSelection.Factory trackSelectionFactory = PlayerHelper.getQualitySelector(context);</span>
<span class="nc" id="L216">        this.trackSelector = new CustomTrackSelector(trackSelectionFactory);</span>

<span class="nc" id="L218">        this.loadControl = new LoadController(context);</span>
<span class="nc" id="L219">        this.renderFactory = new DefaultRenderersFactory(context);</span>
<span class="nc" id="L220">    }</span>

    public void setup() {
<span class="nc bnc" id="L223" title="All 2 branches missed.">        if (simpleExoPlayer == null) {</span>
<span class="nc" id="L224">            initPlayer(/*playOnInit=*/true);</span>
        }
<span class="nc" id="L226">        initListeners();</span>
<span class="nc" id="L227">    }</span>

    public void initPlayer(final boolean playOnReady) {
<span class="nc bnc" id="L230" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;initPlayer() called with: context = [&quot; + context + &quot;]&quot;);</span>

<span class="nc" id="L232">        simpleExoPlayer = ExoPlayerFactory.newSimpleInstance(context, renderFactory, trackSelector, loadControl);</span>
<span class="nc" id="L233">        simpleExoPlayer.addListener(this);</span>
<span class="nc" id="L234">        simpleExoPlayer.setPlayWhenReady(playOnReady);</span>
<span class="nc" id="L235">        simpleExoPlayer.setSeekParameters(PlayerHelper.getSeekParameters(context));</span>

<span class="nc" id="L237">        audioReactor = new AudioReactor(context, simpleExoPlayer);</span>
<span class="nc" id="L238">        mediaSessionManager = new MediaSessionManager(context, simpleExoPlayer,</span>
                new BasePlayerMediaSession(this));

<span class="nc" id="L241">        registerBroadcastReceiver();</span>
<span class="nc" id="L242">    }</span>

    public void initListeners() {
<span class="nc" id="L245">    }</span>

    public void handleIntent(Intent intent) {
<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;handleIntent() called with: intent = [&quot; + intent + &quot;]&quot;);</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">        if (intent == null) return;</span>

        // Resolve play queue
<span class="nc bnc" id="L252" title="All 2 branches missed.">        if (!intent.hasExtra(PLAY_QUEUE_KEY)) return;</span>
<span class="nc" id="L253">        final String intentCacheKey = intent.getStringExtra(PLAY_QUEUE_KEY);</span>
<span class="nc" id="L254">        final PlayQueue queue = SerializedCache.getInstance().take(intentCacheKey, PlayQueue.class);</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (queue == null) return;</span>

        // Resolve append intents
<span class="nc bnc" id="L258" title="All 4 branches missed.">        if (intent.getBooleanExtra(APPEND_ONLY, false) &amp;&amp; playQueue != null) {</span>
<span class="nc" id="L259">            int sizeBeforeAppend = playQueue.size();</span>
<span class="nc" id="L260">            playQueue.append(queue.getStreams());</span>

<span class="nc bnc" id="L262" title="All 2 branches missed.">            if ((intent.getBooleanExtra(SELECT_ON_APPEND, false) ||</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">                    getCurrentState() == STATE_COMPLETED) &amp;&amp;</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">                    queue.getStreams().size() &gt; 0) {</span>
<span class="nc" id="L265">                playQueue.setIndex(sizeBeforeAppend);</span>
            }

<span class="nc" id="L268">            return;</span>
        }

<span class="nc" id="L271">        final int repeatMode = intent.getIntExtra(REPEAT_MODE, getRepeatMode());</span>
<span class="nc" id="L272">        final float playbackSpeed = intent.getFloatExtra(PLAYBACK_SPEED, getPlaybackSpeed());</span>
<span class="nc" id="L273">        final float playbackPitch = intent.getFloatExtra(PLAYBACK_PITCH, getPlaybackPitch());</span>
<span class="nc" id="L274">        final boolean playbackSkipSilence = intent.getBooleanExtra(PLAYBACK_SKIP_SILENCE,</span>
<span class="nc" id="L275">                getPlaybackSkipSilence());</span>

        // seek to timestamp if stream is already playing
<span class="nc bnc" id="L278" title="All 2 branches missed.">        if (simpleExoPlayer != null</span>
<span class="nc bnc" id="L279" title="All 4 branches missed.">                &amp;&amp; queue.size() == 1</span>
                &amp;&amp; playQueue != null
<span class="nc bnc" id="L281" title="All 2 branches missed.">                &amp;&amp; playQueue.getItem() != null</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">                &amp;&amp; queue.getItem().getUrl().equals(playQueue.getItem().getUrl())</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">                &amp;&amp; queue.getItem().getRecoveryPosition() != PlayQueueItem.RECOVERY_UNSET</span>
                ) {
<span class="nc" id="L285">            simpleExoPlayer.seekTo(playQueue.getIndex(), queue.getItem().getRecoveryPosition());</span>
<span class="nc" id="L286">            return;</span>

<span class="nc bnc" id="L288" title="All 4 branches missed.">        } else if (intent.getBooleanExtra(RESUME_PLAYBACK, false) &amp;&amp; isPlaybackResumeEnabled()) {</span>
<span class="nc" id="L289">            final PlayQueueItem item = queue.getItem();</span>
<span class="nc bnc" id="L290" title="All 4 branches missed.">            if (item != null &amp;&amp; item.getRecoveryPosition() == PlayQueueItem.RECOVERY_UNSET) {</span>
<span class="nc" id="L291">                stateLoader = recordManager.loadStreamState(item)</span>
<span class="nc" id="L292">                        .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L293">                        .doFinally(() -&gt; initPlayback(queue, repeatMode, playbackSpeed, playbackPitch, playbackSkipSilence,</span>
                                /*playOnInit=*/true))
<span class="nc" id="L295">                        .subscribe(</span>
<span class="nc" id="L296">                                state -&gt; queue.setRecovery(queue.getIndex(), state.getProgressTime()),</span>
                                error -&gt; {
<span class="nc bnc" id="L298" title="All 2 branches missed.">                                    if (DEBUG) error.printStackTrace();</span>
<span class="nc" id="L299">                                }</span>
                        );
<span class="nc" id="L301">                databaseUpdateReactor.add(stateLoader);</span>
<span class="nc" id="L302">                return;</span>
            }
        }
        // Good to go...
<span class="nc" id="L306">        initPlayback(queue, repeatMode, playbackSpeed, playbackPitch, playbackSkipSilence,</span>
                /*playOnInit=*/true);
<span class="nc" id="L308">    }</span>

    protected void initPlayback(@NonNull final PlayQueue queue,
                                @Player.RepeatMode final int repeatMode,
                                final float playbackSpeed,
                                final float playbackPitch,
                                final boolean playbackSkipSilence,
                                final boolean playOnReady) {
<span class="nc" id="L316">        destroyPlayer();</span>
<span class="nc" id="L317">        initPlayer(playOnReady);</span>
<span class="nc" id="L318">        setRepeatMode(repeatMode);</span>
<span class="nc" id="L319">        setPlaybackParameters(playbackSpeed, playbackPitch, playbackSkipSilence);</span>

<span class="nc" id="L321">        playQueue = queue;</span>
<span class="nc" id="L322">        playQueue.init();</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">        if (playbackManager != null) playbackManager.dispose();</span>
<span class="nc" id="L324">        playbackManager = new MediaSourceManager(this, playQueue);</span>

<span class="nc bnc" id="L326" title="All 2 branches missed.">        if (playQueueAdapter != null) playQueueAdapter.dispose();</span>
<span class="nc" id="L327">        playQueueAdapter = new PlayQueueAdapter(context, playQueue);</span>
<span class="nc" id="L328">    }</span>

    public void destroyPlayer() {
<span class="nc bnc" id="L331" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;destroyPlayer() called&quot;);</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">        if (simpleExoPlayer != null) {</span>
<span class="nc" id="L333">            simpleExoPlayer.removeListener(this);</span>
<span class="nc" id="L334">            simpleExoPlayer.stop();</span>
<span class="nc" id="L335">            simpleExoPlayer.release();</span>
        }
<span class="nc bnc" id="L337" title="All 2 branches missed.">        if (isProgressLoopRunning()) stopProgressLoop();</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">        if (playQueue != null) playQueue.dispose();</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">        if (audioReactor != null) audioReactor.dispose();</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">        if (playbackManager != null) playbackManager.dispose();</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">        if (mediaSessionManager != null) mediaSessionManager.dispose();</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">        if (stateLoader != null) stateLoader.dispose();</span>

<span class="nc bnc" id="L344" title="All 2 branches missed.">        if (playQueueAdapter != null) {</span>
<span class="nc" id="L345">            playQueueAdapter.unsetSelectedListener();</span>
<span class="nc" id="L346">            playQueueAdapter.dispose();</span>
        }
<span class="nc" id="L348">    }</span>

    public void destroy() {
<span class="nc bnc" id="L351" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;destroy() called&quot;);</span>
<span class="nc" id="L352">        destroyPlayer();</span>
<span class="nc" id="L353">        unregisterBroadcastReceiver();</span>

<span class="nc" id="L355">        databaseUpdateReactor.clear();</span>
<span class="nc" id="L356">        progressUpdateReactor.set(null);</span>

<span class="nc" id="L358">    }</span>

    /*//////////////////////////////////////////////////////////////////////////
    // Thumbnail Loading
    //////////////////////////////////////////////////////////////////////////*/

    private void initThumbnail(final String url) {
<span class="nc bnc" id="L365" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;Thumbnail - initThumbnail() called&quot;);</span>
<span class="nc bnc" id="L366" title="All 4 branches missed.">        if (url == null || url.isEmpty()) return;</span>
<span class="nc" id="L367">        ImageLoader.getInstance().resume();</span>
<span class="nc" id="L368">        ImageLoader.getInstance().loadImage(url, ImageDisplayConstants.DISPLAY_THUMBNAIL_OPTIONS,</span>
                this);
<span class="nc" id="L370">    }</span>

    @Override
    public void onLoadingStarted(String imageUri, View view) {
<span class="nc bnc" id="L374" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;Thumbnail - onLoadingStarted() called on: &quot; +</span>
                &quot;imageUri = [&quot; + imageUri + &quot;], view = [&quot; + view + &quot;]&quot;);
<span class="nc" id="L376">    }</span>

    @Override
    public void onLoadingFailed(String imageUri, View view, FailReason failReason) {
<span class="nc" id="L380">        Log.e(TAG, &quot;Thumbnail - onLoadingFailed() called on imageUri = [&quot; + imageUri + &quot;]&quot;,</span>
<span class="nc" id="L381">                failReason.getCause());</span>
<span class="nc" id="L382">        currentThumbnail = null;</span>
<span class="nc" id="L383">    }</span>

    @Override
    public void onLoadingComplete(String imageUri, View view, Bitmap loadedImage) {
<span class="nc bnc" id="L387" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;Thumbnail - onLoadingComplete() called with: &quot; +</span>
                &quot;imageUri = [&quot; + imageUri + &quot;], view = [&quot; + view + &quot;], &quot; +
                &quot;loadedImage = [&quot; + loadedImage + &quot;]&quot;);
<span class="nc" id="L390">        currentThumbnail = loadedImage;</span>
<span class="nc" id="L391">    }</span>

    @Override
    public void onLoadingCancelled(String imageUri, View view) {
<span class="nc bnc" id="L395" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;Thumbnail - onLoadingCancelled() called with: &quot; +</span>
                &quot;imageUri = [&quot; + imageUri + &quot;], view = [&quot; + view + &quot;]&quot;);
<span class="nc" id="L397">        currentThumbnail = null;</span>
<span class="nc" id="L398">    }</span>

    /*//////////////////////////////////////////////////////////////////////////
    // Broadcast Receiver
    //////////////////////////////////////////////////////////////////////////*/

    /**
     * Add your action in the intentFilter
     *
     * @param intentFilter intent filter that will be used for register the receiver
     */
    protected void setupBroadcastReceiver(IntentFilter intentFilter) {
<span class="nc" id="L410">        intentFilter.addAction(AudioManager.ACTION_AUDIO_BECOMING_NOISY);</span>
<span class="nc" id="L411">    }</span>

    public void onBroadcastReceived(Intent intent) {
<span class="nc bnc" id="L414" title="All 4 branches missed.">        if (intent == null || intent.getAction() == null) return;</span>
<span class="nc bnc" id="L415" title="All 6 branches missed.">        switch (intent.getAction()) {</span>
            case AudioManager.ACTION_AUDIO_BECOMING_NOISY:
<span class="nc" id="L417">                onPause();</span>
                break;
        }
<span class="nc" id="L420">    }</span>

    protected void registerBroadcastReceiver() {
        // Try to unregister current first
<span class="nc" id="L424">        unregisterBroadcastReceiver();</span>
<span class="nc" id="L425">        context.registerReceiver(broadcastReceiver, intentFilter);</span>
<span class="nc" id="L426">    }</span>

    protected void unregisterBroadcastReceiver() {
        try {
<span class="nc" id="L430">            context.unregisterReceiver(broadcastReceiver);</span>
<span class="nc" id="L431">        } catch (final IllegalArgumentException unregisteredException) {</span>
<span class="nc" id="L432">            Log.w(TAG, &quot;Broadcast receiver already unregistered (&quot; + unregisteredException.getMessage() + &quot;)&quot;);</span>
<span class="nc" id="L433">        }</span>
<span class="nc" id="L434">    }</span>

    /*//////////////////////////////////////////////////////////////////////////
    // States Implementation
    //////////////////////////////////////////////////////////////////////////*/

    public static final int STATE_PREFLIGHT = -1;
    public static final int STATE_BLOCKED = 123;
    public static final int STATE_PLAYING = 124;
    public static final int STATE_BUFFERING = 125;
    public static final int STATE_PAUSED = 126;
    public static final int STATE_PAUSED_SEEK = 127;
    public static final int STATE_COMPLETED = 128;

<span class="nc" id="L448">    protected int currentState = STATE_PREFLIGHT;</span>

    public void changeState(int state) {
<span class="nc bnc" id="L451" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;changeState() called with: state = [&quot; + state + &quot;]&quot;);</span>
<span class="nc" id="L452">        currentState = state;</span>
<span class="nc bnc" id="L453" title="All 7 branches missed.">        switch (state) {</span>
            case STATE_BLOCKED:
<span class="nc" id="L455">                onBlocked();</span>
<span class="nc" id="L456">                break;</span>
            case STATE_PLAYING:
<span class="nc" id="L458">                onPlaying();</span>
<span class="nc" id="L459">                break;</span>
            case STATE_BUFFERING:
<span class="nc" id="L461">                onBuffering();</span>
<span class="nc" id="L462">                break;</span>
            case STATE_PAUSED:
<span class="nc" id="L464">                onPaused();</span>
<span class="nc" id="L465">                break;</span>
            case STATE_PAUSED_SEEK:
<span class="nc" id="L467">                onPausedSeek();</span>
<span class="nc" id="L468">                break;</span>
            case STATE_COMPLETED:
<span class="nc" id="L470">                onCompleted();</span>
                break;
        }
<span class="nc" id="L473">    }</span>

    public void onBlocked() {
<span class="nc bnc" id="L476" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onBlocked() called&quot;);</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">        if (!isProgressLoopRunning()) startProgressLoop();</span>
<span class="nc" id="L478">    }</span>

    public void onPlaying() {
<span class="nc bnc" id="L481" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onPlaying() called&quot;);</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">        if (!isProgressLoopRunning()) startProgressLoop();</span>
<span class="nc" id="L483">    }</span>

    public void onBuffering() {
<span class="nc" id="L486">    }</span>

    public void onPaused() {
<span class="nc bnc" id="L489" title="All 2 branches missed.">        if (isProgressLoopRunning()) stopProgressLoop();</span>
<span class="nc" id="L490">    }</span>

    public void onPausedSeek() {
<span class="nc" id="L493">    }</span>

    public void onCompleted() {
<span class="nc bnc" id="L496" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onCompleted() called&quot;);</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">        if (playQueue.getIndex() &lt; playQueue.size() - 1) playQueue.offsetIndex(+1);</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">        if (isProgressLoopRunning()) stopProgressLoop();</span>
<span class="nc" id="L499">    }</span>

    /*//////////////////////////////////////////////////////////////////////////
    // Repeat and shuffle
    //////////////////////////////////////////////////////////////////////////*/

    public void onRepeatClicked() {
<span class="nc bnc" id="L506" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onRepeatClicked() called&quot;);</span>

        final int mode;

<span class="nc bnc" id="L510" title="All 3 branches missed.">        switch (getRepeatMode()) {</span>
            case Player.REPEAT_MODE_OFF:
<span class="nc" id="L512">                mode = Player.REPEAT_MODE_ONE;</span>
<span class="nc" id="L513">                break;</span>
            case Player.REPEAT_MODE_ONE:
<span class="nc" id="L515">                mode = Player.REPEAT_MODE_ALL;</span>
<span class="nc" id="L516">                break;</span>
            case Player.REPEAT_MODE_ALL:
            default:
<span class="nc" id="L519">                mode = Player.REPEAT_MODE_OFF;</span>
                break;
        }

<span class="nc" id="L523">        setRepeatMode(mode);</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onRepeatClicked() currentRepeatMode = &quot; + getRepeatMode());</span>
<span class="nc" id="L525">    }</span>

    public void onShuffleClicked() {
<span class="nc bnc" id="L528" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onShuffleClicked() called&quot;);</span>

<span class="nc bnc" id="L530" title="All 2 branches missed.">        if (simpleExoPlayer == null) return;</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">        simpleExoPlayer.setShuffleModeEnabled(!simpleExoPlayer.getShuffleModeEnabled());</span>
<span class="nc" id="L532">    }</span>

    /*//////////////////////////////////////////////////////////////////////////
    // Progress Updates
    //////////////////////////////////////////////////////////////////////////*/

    public abstract void onUpdateProgress(int currentProgress, int duration, int bufferPercent);

    protected void startProgressLoop() {
<span class="nc" id="L541">        progressUpdateReactor.set(getProgressReactor());</span>
<span class="nc" id="L542">    }</span>

    protected void stopProgressLoop() {
<span class="nc" id="L545">        progressUpdateReactor.set(null);</span>
<span class="nc" id="L546">    }</span>

    public void triggerProgressUpdate() {
<span class="nc bnc" id="L549" title="All 2 branches missed.">        if (simpleExoPlayer == null) return;</span>
<span class="nc" id="L550">        onUpdateProgress(</span>
<span class="nc" id="L551">                Math.max((int) simpleExoPlayer.getCurrentPosition(), 0),</span>
<span class="nc" id="L552">                (int) simpleExoPlayer.getDuration(),</span>
<span class="nc" id="L553">                simpleExoPlayer.getBufferedPercentage()</span>
        );
<span class="nc" id="L555">    }</span>

    private Disposable getProgressReactor() {
<span class="nc" id="L558">        return Observable.interval(PROGRESS_LOOP_INTERVAL_MILLIS, TimeUnit.MILLISECONDS)</span>
<span class="nc" id="L559">                .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L560">                .subscribe(ignored -&gt; triggerProgressUpdate(),</span>
<span class="nc" id="L561">                        error -&gt; Log.e(TAG, &quot;Progress update failure: &quot;, error));</span>
    }

    /*//////////////////////////////////////////////////////////////////////////
    // ExoPlayer Listener
    //////////////////////////////////////////////////////////////////////////*/

    @Override
    public void onTimelineChanged(Timeline timeline, Object manifest,
                                  @Player.TimelineChangeReason final int reason) {
<span class="nc bnc" id="L571" title="All 4 branches missed.">        if (DEBUG) Log.d(TAG, &quot;ExoPlayer - onTimelineChanged() called with &quot; +</span>
                (manifest == null ? &quot;no manifest&quot; : &quot;available manifest&quot;) + &quot;, &quot; +
<span class="nc" id="L573">                &quot;timeline size = [&quot; + timeline.getWindowCount() + &quot;], &quot; +</span>
                &quot;reason = [&quot; + reason + &quot;]&quot;);

<span class="nc" id="L576">        maybeUpdateCurrentMetadata();</span>
<span class="nc" id="L577">    }</span>

    @Override
    public void onTracksChanged(TrackGroupArray trackGroups, TrackSelectionArray trackSelections) {
<span class="nc bnc" id="L581" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;ExoPlayer - onTracksChanged(), &quot; +</span>
                &quot;track group size = &quot; + trackGroups.length);

<span class="nc" id="L584">        maybeUpdateCurrentMetadata();</span>
<span class="nc" id="L585">    }</span>

    @Override
    public void onPlaybackParametersChanged(PlaybackParameters playbackParameters) {
<span class="nc bnc" id="L589" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;ExoPlayer - playbackParameters(), &quot; +</span>
                &quot;speed: &quot; + playbackParameters.speed + &quot;, &quot; +
                &quot;pitch: &quot; + playbackParameters.pitch);
<span class="nc" id="L592">    }</span>

    @Override
    public void onLoadingChanged(final boolean isLoading) {
<span class="nc bnc" id="L596" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;ExoPlayer - onLoadingChanged() called with: &quot; +</span>
                &quot;isLoading = [&quot; + isLoading + &quot;]&quot;);

<span class="nc bnc" id="L599" title="All 6 branches missed.">        if (!isLoading &amp;&amp; getCurrentState() == STATE_PAUSED &amp;&amp; isProgressLoopRunning()) {</span>
<span class="nc" id="L600">            stopProgressLoop();</span>
<span class="nc bnc" id="L601" title="All 4 branches missed.">        } else if (isLoading &amp;&amp; !isProgressLoopRunning()) {</span>
<span class="nc" id="L602">            startProgressLoop();</span>
        }

<span class="nc" id="L605">        maybeUpdateCurrentMetadata();</span>
<span class="nc" id="L606">    }</span>

    @Override
    public void onPlayerStateChanged(boolean playWhenReady, int playbackState) {
<span class="nc bnc" id="L610" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;ExoPlayer - onPlayerStateChanged() called with: &quot; +</span>
                &quot;playWhenReady = [&quot; + playWhenReady + &quot;], &quot; +
                &quot;playbackState = [&quot; + playbackState + &quot;]&quot;);

<span class="nc bnc" id="L614" title="All 2 branches missed.">        if (getCurrentState() == STATE_PAUSED_SEEK) {</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">            if (DEBUG) Log.d(TAG, &quot;ExoPlayer - onPlayerStateChanged() is currently blocked&quot;);</span>
<span class="nc" id="L616">            return;</span>
        }

<span class="nc bnc" id="L619" title="All 5 branches missed.">        switch (playbackState) {</span>
            case Player.STATE_IDLE: // 1
<span class="nc" id="L621">                isPrepared = false;</span>
<span class="nc" id="L622">                break;</span>
            case Player.STATE_BUFFERING: // 2
<span class="nc bnc" id="L624" title="All 2 branches missed.">                if (isPrepared) {</span>
<span class="nc" id="L625">                    changeState(STATE_BUFFERING);</span>
                }
                break;
            case Player.STATE_READY: //3
<span class="nc" id="L629">                maybeUpdateCurrentMetadata();</span>
<span class="nc" id="L630">                maybeCorrectSeekPosition();</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">                if (!isPrepared) {</span>
<span class="nc" id="L632">                    isPrepared = true;</span>
<span class="nc" id="L633">                    onPrepared(playWhenReady);</span>
<span class="nc" id="L634">                    break;</span>
                }
<span class="nc bnc" id="L636" title="All 2 branches missed.">                changeState(playWhenReady ? STATE_PLAYING : STATE_PAUSED);</span>
<span class="nc" id="L637">                break;</span>
            case Player.STATE_ENDED: // 4
<span class="nc" id="L639">                changeState(STATE_COMPLETED);</span>
<span class="nc bnc" id="L640" title="All 2 branches missed.">                if (currentMetadata != null) {</span>
<span class="nc" id="L641">                    resetPlaybackState(currentMetadata.getMetadata());</span>
                }
<span class="nc" id="L643">                isPrepared = false;</span>
                break;
        }
<span class="nc" id="L646">    }</span>

    private void maybeCorrectSeekPosition() {
<span class="nc bnc" id="L649" title="All 6 branches missed.">        if (playQueue == null || simpleExoPlayer == null || currentMetadata == null) return;</span>

<span class="nc" id="L651">        final PlayQueueItem currentSourceItem = playQueue.getItem();</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">        if (currentSourceItem == null) return;</span>

<span class="nc" id="L654">        final StreamInfo currentInfo = currentMetadata.getMetadata();</span>
<span class="nc" id="L655">        final long presetStartPositionMillis = currentInfo.getStartPosition() * 1000;</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">        if (presetStartPositionMillis &gt; 0L) {</span>
            // Has another start position?
<span class="nc bnc" id="L658" title="All 2 branches missed.">            if (DEBUG) Log.d(TAG, &quot;Playback - Seeking to preset start &quot; +</span>
                    &quot;position=[&quot; + presetStartPositionMillis + &quot;]&quot;);
<span class="nc" id="L660">            seekTo(presetStartPositionMillis);</span>
        }
<span class="nc" id="L662">    }</span>

    /**
     * Processes the exceptions produced by {@link com.google.android.exoplayer2.ExoPlayer ExoPlayer}.
     * There are multiple types of errors: &lt;br&gt;&lt;br&gt;
     * &lt;p&gt;
     * {@link ExoPlaybackException#TYPE_SOURCE TYPE_SOURCE}: &lt;br&gt;&lt;br&gt;
     * &lt;p&gt;
     * {@link ExoPlaybackException#TYPE_UNEXPECTED TYPE_UNEXPECTED}: &lt;br&gt;&lt;br&gt;
     * If a runtime error occurred, then we can try to recover it by restarting the playback
     * after setting the timestamp recovery. &lt;br&gt;&lt;br&gt;
     * &lt;p&gt;
     * {@link ExoPlaybackException#TYPE_RENDERER TYPE_RENDERER}: &lt;br&gt;&lt;br&gt;
     * If the renderer failed, treat the error as unrecoverable.
     *
     * @see #processSourceError(IOException)
     * @see Player.EventListener#onPlayerError(ExoPlaybackException)
     */
    @Override
    public void onPlayerError(ExoPlaybackException error) {
<span class="nc bnc" id="L682" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;ExoPlayer - onPlayerError() called with: &quot; +</span>
                &quot;error = [&quot; + error + &quot;]&quot;);
<span class="nc bnc" id="L684" title="All 2 branches missed.">        if (errorToast != null) {</span>
<span class="nc" id="L685">            errorToast.cancel();</span>
<span class="nc" id="L686">            errorToast = null;</span>
        }

<span class="nc" id="L689">        savePlaybackState();</span>

<span class="nc bnc" id="L691" title="All 3 branches missed.">        switch (error.type) {</span>
            case ExoPlaybackException.TYPE_SOURCE:
<span class="nc" id="L693">                processSourceError(error.getSourceException());</span>
<span class="nc" id="L694">                showStreamError(error);</span>
<span class="nc" id="L695">                break;</span>
            case ExoPlaybackException.TYPE_UNEXPECTED:
<span class="nc" id="L697">                showRecoverableError(error);</span>
<span class="nc" id="L698">                setRecovery();</span>
<span class="nc" id="L699">                reload();</span>
<span class="nc" id="L700">                break;</span>
            default:
<span class="nc" id="L702">                showUnrecoverableError(error);</span>
<span class="nc" id="L703">                onPlaybackShutdown();</span>
                break;
        }
<span class="nc" id="L706">    }</span>

    private void processSourceError(final IOException error) {
<span class="nc bnc" id="L709" title="All 4 branches missed.">        if (simpleExoPlayer == null || playQueue == null) return;</span>
<span class="nc" id="L710">        setRecovery();</span>

<span class="nc" id="L712">        final Throwable cause = error.getCause();</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">        if (error instanceof BehindLiveWindowException) {</span>
<span class="nc" id="L714">            reload();</span>
<span class="nc bnc" id="L715" title="All 2 branches missed.">        } else if (cause instanceof UnknownHostException) {</span>
<span class="nc" id="L716">            playQueue.error(/*isNetworkProblem=*/true);</span>
<span class="nc bnc" id="L717" title="All 2 branches missed.">        } else if (isCurrentWindowValid()) {</span>
<span class="nc" id="L718">            playQueue.error(/*isTransitioningToBadStream=*/true);</span>
<span class="nc bnc" id="L719" title="All 2 branches missed.">        } else if (cause instanceof FailedMediaSource.MediaSourceResolutionException) {</span>
<span class="nc" id="L720">            playQueue.error(/*recoverableWithNoAvailableStream=*/false);</span>
<span class="nc bnc" id="L721" title="All 2 branches missed.">        } else if (cause instanceof FailedMediaSource.StreamInfoLoadException) {</span>
<span class="nc" id="L722">            playQueue.error(/*recoverableIfLoadFailsWhenNetworkIsFine=*/false);</span>
        } else {
<span class="nc" id="L724">            playQueue.error(/*noIdeaWhatHappenedAndLetUserChooseWhatToDo=*/true);</span>
        }
<span class="nc" id="L726">    }</span>

    @Override
    public void onPositionDiscontinuity(@Player.DiscontinuityReason final int reason) {
<span class="nc bnc" id="L730" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;ExoPlayer - onPositionDiscontinuity() called with &quot; +</span>
                &quot;reason = [&quot; + reason + &quot;]&quot;);
<span class="nc bnc" id="L732" title="All 2 branches missed.">        if (playQueue == null) return;</span>

        // Refresh the playback if there is a transition to the next video
<span class="nc" id="L735">        final int newWindowIndex = simpleExoPlayer.getCurrentWindowIndex();</span>
<span class="nc bnc" id="L736" title="All 3 branches missed.">        switch (reason) {</span>
            case DISCONTINUITY_REASON_PERIOD_TRANSITION:
                // When player is in single repeat mode and a period transition occurs,
                // we need to register a view count here since no metadata has changed
<span class="nc bnc" id="L740" title="All 2 branches missed.">                if (getRepeatMode() == Player.REPEAT_MODE_ONE &amp;&amp;</span>
<span class="nc bnc" id="L741" title="All 2 branches missed.">                        newWindowIndex == playQueue.getIndex()) {</span>
<span class="nc" id="L742">                    registerView();</span>
<span class="nc" id="L743">                    break;</span>
                }
            case DISCONTINUITY_REASON_SEEK:
            case DISCONTINUITY_REASON_SEEK_ADJUSTMENT:
            case DISCONTINUITY_REASON_INTERNAL:
<span class="nc bnc" id="L748" title="All 2 branches missed.">                if (playQueue.getIndex() != newWindowIndex) {</span>
<span class="nc" id="L749">                    resetPlaybackState(playQueue.getItem());</span>
<span class="nc" id="L750">                    playQueue.setIndex(newWindowIndex);</span>
                }
                break;
        }

<span class="nc" id="L755">        maybeUpdateCurrentMetadata();</span>
<span class="nc" id="L756">    }</span>

    @Override
    public void onRepeatModeChanged(@Player.RepeatMode final int reason) {
<span class="nc bnc" id="L760" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;ExoPlayer - onRepeatModeChanged() called with: &quot; +</span>
                &quot;mode = [&quot; + reason + &quot;]&quot;);
<span class="nc" id="L762">    }</span>

    @Override
    public void onShuffleModeEnabledChanged(final boolean shuffleModeEnabled) {
<span class="nc bnc" id="L766" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;ExoPlayer - onShuffleModeEnabledChanged() called with: &quot; +</span>
                &quot;mode = [&quot; + shuffleModeEnabled + &quot;]&quot;);
<span class="nc bnc" id="L768" title="All 2 branches missed.">        if (playQueue == null) return;</span>
<span class="nc bnc" id="L769" title="All 2 branches missed.">        if (shuffleModeEnabled) {</span>
<span class="nc" id="L770">            playQueue.shuffle();</span>
        } else {
<span class="nc" id="L772">            playQueue.unshuffle();</span>
        }
<span class="nc" id="L774">    }</span>

    @Override
    public void onSeekProcessed() {
<span class="nc bnc" id="L778" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;ExoPlayer - onSeekProcessed() called&quot;);</span>
<span class="nc bnc" id="L779" title="All 2 branches missed.">        if (isPrepared) {</span>
<span class="nc" id="L780">            savePlaybackState();</span>
        }
<span class="nc" id="L782">    }</span>
    /*//////////////////////////////////////////////////////////////////////////
    // Playback Listener
    //////////////////////////////////////////////////////////////////////////*/

    @Override
    public boolean isApproachingPlaybackEdge(final long timeToEndMillis) {
        // If live, then not near playback edge
        // If not playing, then not approaching playback edge
<span class="nc bnc" id="L791" title="All 6 branches missed.">        if (simpleExoPlayer == null || isLive() || !isPlaying()) return false;</span>

<span class="nc" id="L793">        final long currentPositionMillis = simpleExoPlayer.getCurrentPosition();</span>
<span class="nc" id="L794">        final long currentDurationMillis = simpleExoPlayer.getDuration();</span>
<span class="nc bnc" id="L795" title="All 2 branches missed.">        return currentDurationMillis - currentPositionMillis &lt; timeToEndMillis;</span>
    }

    @Override
    public void onPlaybackBlock() {
<span class="nc bnc" id="L800" title="All 2 branches missed.">        if (simpleExoPlayer == null) return;</span>
<span class="nc bnc" id="L801" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;Playback - onPlaybackBlock() called&quot;);</span>

<span class="nc" id="L803">        currentItem = null;</span>
<span class="nc" id="L804">        currentMetadata = null;</span>
<span class="nc" id="L805">        simpleExoPlayer.stop();</span>
<span class="nc" id="L806">        isPrepared = false;</span>

<span class="nc" id="L808">        changeState(STATE_BLOCKED);</span>
<span class="nc" id="L809">    }</span>

    @Override
    public void onPlaybackUnblock(final MediaSource mediaSource) {
<span class="nc bnc" id="L813" title="All 2 branches missed.">        if (simpleExoPlayer == null) return;</span>
<span class="nc bnc" id="L814" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;Playback - onPlaybackUnblock() called&quot;);</span>

<span class="nc bnc" id="L816" title="All 2 branches missed.">        if (getCurrentState() == STATE_BLOCKED) changeState(STATE_BUFFERING);</span>

<span class="nc" id="L818">        simpleExoPlayer.prepare(mediaSource);</span>
<span class="nc" id="L819">    }</span>

    public void onPlaybackSynchronize(@NonNull final PlayQueueItem item) {
<span class="nc bnc" id="L822" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;Playback - onPlaybackSynchronize() called with &quot; +</span>
<span class="nc" id="L823">                &quot;item=[&quot; + item.getTitle() + &quot;], url=[&quot; + item.getUrl() + &quot;]&quot;);</span>
<span class="nc bnc" id="L824" title="All 4 branches missed.">        if (simpleExoPlayer == null || playQueue == null) return;</span>

<span class="nc bnc" id="L826" title="All 2 branches missed.">        final boolean onPlaybackInitial = currentItem == null;</span>
<span class="nc bnc" id="L827" title="All 2 branches missed.">        final boolean hasPlayQueueItemChanged = currentItem != item;</span>

<span class="nc" id="L829">        final int currentPlayQueueIndex = playQueue.indexOf(item);</span>
<span class="nc" id="L830">        final int currentPlaylistIndex = simpleExoPlayer.getCurrentWindowIndex();</span>
<span class="nc" id="L831">        final int currentPlaylistSize = simpleExoPlayer.getCurrentTimeline().getWindowCount();</span>

        // If nothing to synchronize
<span class="nc bnc" id="L834" title="All 2 branches missed.">        if (!hasPlayQueueItemChanged) return;</span>
<span class="nc" id="L835">        currentItem = item;</span>

        // Check if on wrong window
<span class="nc bnc" id="L838" title="All 2 branches missed.">        if (currentPlayQueueIndex != playQueue.getIndex()) {</span>
<span class="nc" id="L839">            Log.e(TAG, &quot;Playback - Play Queue may be desynchronized: item &quot; +</span>
                    &quot;index=[&quot; + currentPlayQueueIndex + &quot;], &quot; +
<span class="nc" id="L841">                    &quot;queue index=[&quot; + playQueue.getIndex() + &quot;]&quot;);</span>

            // Check if bad seek position
<span class="nc bnc" id="L844" title="All 6 branches missed.">        } else if ((currentPlaylistSize &gt; 0 &amp;&amp; currentPlayQueueIndex &gt;= currentPlaylistSize) ||</span>
                currentPlayQueueIndex &lt; 0) {
<span class="nc" id="L846">            Log.e(TAG, &quot;Playback - Trying to seek to invalid &quot; +</span>
                    &quot;index=[&quot; + currentPlayQueueIndex + &quot;] with &quot; +
                    &quot;playlist length=[&quot; + currentPlaylistSize + &quot;]&quot;);

<span class="nc bnc" id="L850" title="All 4 branches missed.">        } else if (currentPlaylistIndex != currentPlayQueueIndex || onPlaybackInitial ||</span>
<span class="nc bnc" id="L851" title="All 2 branches missed.">                !isPlaying()) {</span>
<span class="nc bnc" id="L852" title="All 2 branches missed.">            if (DEBUG) Log.d(TAG, &quot;Playback - Rewinding to correct&quot; +</span>
                    &quot; index=[&quot; + currentPlayQueueIndex + &quot;],&quot; +
                    &quot; from=[&quot; + currentPlaylistIndex + &quot;], size=[&quot; + currentPlaylistSize + &quot;].&quot;);

<span class="nc bnc" id="L856" title="All 2 branches missed.">            if (item.getRecoveryPosition() != PlayQueueItem.RECOVERY_UNSET) {</span>
<span class="nc" id="L857">                simpleExoPlayer.seekTo(currentPlayQueueIndex, item.getRecoveryPosition());</span>
<span class="nc" id="L858">                playQueue.unsetRecovery(currentPlayQueueIndex);</span>
            } else {
<span class="nc" id="L860">                simpleExoPlayer.seekToDefaultPosition(currentPlayQueueIndex);</span>
            }
        }
<span class="nc" id="L863">    }</span>

    protected void onMetadataChanged(@NonNull final MediaSourceTag tag) {
<span class="nc" id="L866">        final StreamInfo info = tag.getMetadata();</span>
<span class="nc bnc" id="L867" title="All 2 branches missed.">        if (DEBUG) {</span>
<span class="nc" id="L868">            Log.d(TAG, &quot;Playback - onMetadataChanged() called, playing: &quot; + info.getName());</span>
        }

<span class="nc" id="L871">        initThumbnail(info.getThumbnailUrl());</span>
<span class="nc" id="L872">        registerView();</span>
<span class="nc" id="L873">    }</span>

    @Override
    public void onPlaybackShutdown() {
<span class="nc bnc" id="L877" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;Shutting down...&quot;);</span>
<span class="nc" id="L878">        destroy();</span>
<span class="nc" id="L879">    }</span>

    /*//////////////////////////////////////////////////////////////////////////
    // General Player
    //////////////////////////////////////////////////////////////////////////*/

    public void showStreamError(Exception exception) {
<span class="nc" id="L886">        exception.printStackTrace();</span>

<span class="nc bnc" id="L888" title="All 2 branches missed.">        if (errorToast == null) {</span>
<span class="nc" id="L889">            errorToast = Toast.makeText(context, R.string.player_stream_failure, Toast.LENGTH_SHORT);</span>
<span class="nc" id="L890">            errorToast.show();</span>
        }
<span class="nc" id="L892">    }</span>

    public void showRecoverableError(Exception exception) {
<span class="nc" id="L895">        exception.printStackTrace();</span>

<span class="nc bnc" id="L897" title="All 2 branches missed.">        if (errorToast == null) {</span>
<span class="nc" id="L898">            errorToast = Toast.makeText(context, R.string.player_recoverable_failure, Toast.LENGTH_SHORT);</span>
<span class="nc" id="L899">            errorToast.show();</span>
        }
<span class="nc" id="L901">    }</span>

    public void showUnrecoverableError(Exception exception) {
<span class="nc" id="L904">        exception.printStackTrace();</span>

<span class="nc bnc" id="L906" title="All 2 branches missed.">        if (errorToast != null) {</span>
<span class="nc" id="L907">            errorToast.cancel();</span>
        }
<span class="nc" id="L909">        errorToast = Toast.makeText(context, R.string.player_unrecoverable_failure, Toast.LENGTH_SHORT);</span>
<span class="nc" id="L910">        errorToast.show();</span>
<span class="nc" id="L911">    }</span>

    public void onPrepared(boolean playWhenReady) {
<span class="nc bnc" id="L914" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onPrepared() called with: playWhenReady = [&quot; + playWhenReady + &quot;]&quot;);</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">        if (playWhenReady) audioReactor.requestAudioFocus();</span>
<span class="nc bnc" id="L916" title="All 2 branches missed.">        changeState(playWhenReady ? STATE_PLAYING : STATE_PAUSED);</span>
<span class="nc" id="L917">    }</span>

    public void onPlay() {
<span class="nc bnc" id="L920" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onPlay() called&quot;);</span>
<span class="nc bnc" id="L921" title="All 6 branches missed.">        if (audioReactor == null || playQueue == null || simpleExoPlayer == null) return;</span>

<span class="nc" id="L923">        audioReactor.requestAudioFocus();</span>

<span class="nc bnc" id="L925" title="All 2 branches missed.">        if (getCurrentState() == STATE_COMPLETED) {</span>
<span class="nc bnc" id="L926" title="All 2 branches missed.">            if (playQueue.getIndex() == 0) {</span>
<span class="nc" id="L927">                seekToDefault();</span>
            } else {
<span class="nc" id="L929">                playQueue.setIndex(0);</span>
            }
        }

<span class="nc" id="L933">        simpleExoPlayer.setPlayWhenReady(true);</span>
<span class="nc" id="L934">    }</span>

    public void onPause() {
<span class="nc bnc" id="L937" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onPause() called&quot;);</span>
<span class="nc bnc" id="L938" title="All 4 branches missed.">        if (audioReactor == null || simpleExoPlayer == null) return;</span>

<span class="nc" id="L940">        audioReactor.abandonAudioFocus();</span>
<span class="nc" id="L941">        simpleExoPlayer.setPlayWhenReady(false);</span>
<span class="nc" id="L942">    }</span>

    public void onPlayPause() {
<span class="nc bnc" id="L945" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onPlayPause() called&quot;);</span>

<span class="nc bnc" id="L947" title="All 2 branches missed.">        if (!isPlaying()) {</span>
<span class="nc" id="L948">            onPlay();</span>
        } else {
<span class="nc" id="L950">            onPause();</span>
        }
<span class="nc" id="L952">    }</span>

    public void onFastRewind() {
<span class="nc bnc" id="L955" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onFastRewind() called&quot;);</span>
<span class="nc" id="L956">        seekBy(-FAST_FORWARD_REWIND_AMOUNT_MILLIS);</span>
<span class="nc" id="L957">    }</span>

    public void onFastForward() {
<span class="nc bnc" id="L960" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onFastForward() called&quot;);</span>
<span class="nc" id="L961">        seekBy(FAST_FORWARD_REWIND_AMOUNT_MILLIS);</span>
<span class="nc" id="L962">    }</span>

    public void onPlayPrevious() {
<span class="nc bnc" id="L965" title="All 4 branches missed.">        if (simpleExoPlayer == null || playQueue == null) return;</span>
<span class="nc bnc" id="L966" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onPlayPrevious() called&quot;);</span>

        /* If current playback has run for PLAY_PREV_ACTIVATION_LIMIT_MILLIS milliseconds,
         * restart current track. Also restart the track if the current track
         * is the first in a queue.*/
<span class="nc bnc" id="L971" title="All 2 branches missed.">        if (simpleExoPlayer.getCurrentPosition() &gt; PLAY_PREV_ACTIVATION_LIMIT_MILLIS ||</span>
<span class="nc bnc" id="L972" title="All 2 branches missed.">                playQueue.getIndex() == 0) {</span>
<span class="nc" id="L973">            seekToDefault();</span>
<span class="nc" id="L974">            playQueue.offsetIndex(0);</span>
        } else {
<span class="nc" id="L976">            savePlaybackState();</span>
<span class="nc" id="L977">            playQueue.offsetIndex(-1);</span>
        }
<span class="nc" id="L979">    }</span>

    public void onPlayNext() {
<span class="nc bnc" id="L982" title="All 2 branches missed.">        if (playQueue == null) return;</span>
<span class="nc bnc" id="L983" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;onPlayNext() called&quot;);</span>

<span class="nc" id="L985">        savePlaybackState();</span>
<span class="nc" id="L986">        playQueue.offsetIndex(+1);</span>
<span class="nc" id="L987">    }</span>

    public void onSelected(final PlayQueueItem item) {
<span class="nc bnc" id="L990" title="All 4 branches missed.">        if (playQueue == null || simpleExoPlayer == null) return;</span>

<span class="nc" id="L992">        final int index = playQueue.indexOf(item);</span>
<span class="nc bnc" id="L993" title="All 2 branches missed.">        if (index == -1) return;</span>

<span class="nc bnc" id="L995" title="All 4 branches missed.">        if (playQueue.getIndex() == index &amp;&amp; simpleExoPlayer.getCurrentWindowIndex() == index) {</span>
<span class="nc" id="L996">            seekToDefault();</span>
        } else {
<span class="nc" id="L998">            savePlaybackState();</span>
        }
<span class="nc" id="L1000">        playQueue.setIndex(index);</span>
<span class="nc" id="L1001">    }</span>

    public void seekTo(long positionMillis) {
<span class="nc bnc" id="L1004" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;seekBy() called with: position = [&quot; + positionMillis + &quot;]&quot;);</span>
<span class="nc bnc" id="L1005" title="All 2 branches missed.">        if (simpleExoPlayer != null) simpleExoPlayer.seekTo(positionMillis);</span>
<span class="nc" id="L1006">    }</span>

    public void seekBy(long offsetMillis) {
<span class="nc bnc" id="L1009" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;seekBy() called with: offsetMillis = [&quot; + offsetMillis + &quot;]&quot;);</span>
<span class="nc" id="L1010">        seekTo(simpleExoPlayer.getCurrentPosition() + offsetMillis);</span>
<span class="nc" id="L1011">    }</span>

    public boolean isCurrentWindowValid() {
<span class="nc bnc" id="L1014" title="All 4 branches missed.">        return simpleExoPlayer != null &amp;&amp; simpleExoPlayer.getDuration() &gt;= 0</span>
<span class="nc bnc" id="L1015" title="All 2 branches missed.">                &amp;&amp; simpleExoPlayer.getCurrentPosition() &gt;= 0;</span>
    }

    public void seekToDefault() {
<span class="nc bnc" id="L1019" title="All 2 branches missed.">        if (simpleExoPlayer != null) {</span>
<span class="nc" id="L1020">            simpleExoPlayer.seekToDefaultPosition();</span>
        }
<span class="nc" id="L1022">    }</span>

    /*//////////////////////////////////////////////////////////////////////////
    // Utils
    //////////////////////////////////////////////////////////////////////////*/

    private void registerView() {
<span class="nc bnc" id="L1029" title="All 2 branches missed.">        if (currentMetadata == null) return;</span>
<span class="nc" id="L1030">        final StreamInfo currentInfo = currentMetadata.getMetadata();</span>
<span class="nc" id="L1031">        final Disposable viewRegister = recordManager.onViewed(currentInfo).onErrorComplete()</span>
<span class="nc" id="L1032">                .subscribe(</span>
<span class="nc" id="L1033">                        ignored -&gt; {/* successful */},</span>
<span class="nc" id="L1034">                        error -&gt; Log.e(TAG, &quot;Player onViewed() failure: &quot;, error)</span>
                );
<span class="nc" id="L1036">        databaseUpdateReactor.add(viewRegister);</span>
<span class="nc" id="L1037">    }</span>

    protected void reload() {
<span class="nc bnc" id="L1040" title="All 2 branches missed.">        if (playbackManager != null) {</span>
<span class="nc" id="L1041">            playbackManager.dispose();</span>
        }

<span class="nc bnc" id="L1044" title="All 2 branches missed.">        if (playQueue != null) {</span>
<span class="nc" id="L1045">            playbackManager = new MediaSourceManager(this, playQueue);</span>
        }
<span class="nc" id="L1047">    }</span>

    private void savePlaybackState(final StreamInfo info, final long progress) {
<span class="nc bnc" id="L1050" title="All 2 branches missed.">        if (info == null) return;</span>
<span class="nc bnc" id="L1051" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;savePlaybackState() called&quot;);</span>
<span class="nc" id="L1052">        final SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(context);</span>
<span class="nc bnc" id="L1053" title="All 2 branches missed.">        if (prefs.getBoolean(context.getString(R.string.enable_watch_history_key), true)) {</span>
<span class="nc" id="L1054">            final Disposable stateSaver = recordManager.saveStreamState(info, progress)</span>
<span class="nc" id="L1055">                    .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L1056">                    .doOnError((e) -&gt; {</span>
<span class="nc bnc" id="L1057" title="All 2 branches missed.">                        if (DEBUG) e.printStackTrace();</span>
<span class="nc" id="L1058">                    })</span>
<span class="nc" id="L1059">                    .onErrorComplete()</span>
<span class="nc" id="L1060">                    .subscribe();</span>
<span class="nc" id="L1061">            databaseUpdateReactor.add(stateSaver);</span>
        }
<span class="nc" id="L1063">    }</span>

    private void resetPlaybackState(final PlayQueueItem queueItem) {
<span class="nc bnc" id="L1066" title="All 2 branches missed.">        if (queueItem == null) return;</span>
<span class="nc" id="L1067">        final SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(context);</span>
<span class="nc bnc" id="L1068" title="All 2 branches missed.">        if (prefs.getBoolean(context.getString(R.string.enable_watch_history_key), true)) {</span>
<span class="nc" id="L1069">            final Disposable stateSaver = queueItem.getStream()</span>
<span class="nc" id="L1070">                    .flatMapCompletable(info -&gt; recordManager.saveStreamState(info, 0))</span>
<span class="nc" id="L1071">                    .observeOn(AndroidSchedulers.mainThread())</span>
<span class="nc" id="L1072">                    .doOnError((e) -&gt; {</span>
<span class="nc bnc" id="L1073" title="All 2 branches missed.">                        if (DEBUG) e.printStackTrace();</span>
<span class="nc" id="L1074">                    })</span>
<span class="nc" id="L1075">                    .onErrorComplete()</span>
<span class="nc" id="L1076">                    .subscribe();</span>
<span class="nc" id="L1077">            databaseUpdateReactor.add(stateSaver);</span>
        }
<span class="nc" id="L1079">    }</span>

    public void resetPlaybackState(final StreamInfo info) {
<span class="nc" id="L1082">        savePlaybackState(info, 0);</span>
<span class="nc" id="L1083">    }</span>

    public void savePlaybackState() {
<span class="nc bnc" id="L1086" title="All 4 branches missed.">        if (simpleExoPlayer == null || currentMetadata == null) return;</span>
<span class="nc" id="L1087">        final StreamInfo currentInfo = currentMetadata.getMetadata();</span>
<span class="nc" id="L1088">        savePlaybackState(currentInfo, simpleExoPlayer.getCurrentPosition());</span>
<span class="nc" id="L1089">    }</span>

    private void maybeUpdateCurrentMetadata() {
<span class="nc bnc" id="L1092" title="All 2 branches missed.">        if (simpleExoPlayer == null) return;</span>

        final MediaSourceTag metadata;
        try {
<span class="nc" id="L1096">            metadata = (MediaSourceTag) simpleExoPlayer.getCurrentTag();</span>
<span class="nc" id="L1097">        } catch (IndexOutOfBoundsException | ClassCastException error) {</span>
<span class="nc bnc" id="L1098" title="All 2 branches missed.">            if (DEBUG) Log.d(TAG, &quot;Could not update metadata: &quot; + error.getMessage());</span>
<span class="nc bnc" id="L1099" title="All 2 branches missed.">            if (DEBUG) error.printStackTrace();</span>
<span class="nc" id="L1100">            return;</span>
<span class="nc" id="L1101">        }</span>

<span class="nc bnc" id="L1103" title="All 2 branches missed.">        if (metadata == null) return;</span>
<span class="nc" id="L1104">        maybeAutoQueueNextStream(metadata);</span>

<span class="nc bnc" id="L1106" title="All 2 branches missed.">        if (currentMetadata == metadata) return;</span>
<span class="nc" id="L1107">        currentMetadata = metadata;</span>
<span class="nc" id="L1108">        onMetadataChanged(metadata);</span>
<span class="nc" id="L1109">    }</span>

    private void maybeAutoQueueNextStream(@NonNull final MediaSourceTag currentMetadata) {
<span class="nc bnc" id="L1112" title="All 4 branches missed.">        if (playQueue == null || playQueue.getIndex() != playQueue.size() - 1 ||</span>
<span class="nc bnc" id="L1113" title="All 2 branches missed.">                getRepeatMode() != Player.REPEAT_MODE_OFF ||</span>
<span class="nc bnc" id="L1114" title="All 2 branches missed.">                !PlayerHelper.isAutoQueueEnabled(context)) return;</span>
        // auto queue when starting playback on the last item when not repeating
<span class="nc" id="L1116">        final PlayQueue autoQueue = PlayerHelper.autoQueueOf(currentMetadata.getMetadata(),</span>
<span class="nc" id="L1117">                playQueue.getStreams());</span>
<span class="nc bnc" id="L1118" title="All 2 branches missed.">        if (autoQueue != null) playQueue.append(autoQueue.getStreams());</span>
<span class="nc" id="L1119">    }</span>
    /*//////////////////////////////////////////////////////////////////////////
    // Getters and Setters
    //////////////////////////////////////////////////////////////////////////*/

    public SimpleExoPlayer getPlayer() {
<span class="nc" id="L1125">        return simpleExoPlayer;</span>
    }

    public AudioReactor getAudioReactor() {
<span class="nc" id="L1129">        return audioReactor;</span>
    }

    public int getCurrentState() {
<span class="nc" id="L1133">        return currentState;</span>
    }

    @Nullable
    public MediaSourceTag getCurrentMetadata() {
<span class="nc" id="L1138">        return currentMetadata;</span>
    }

    @NonNull
    public String getVideoUrl() {
<span class="nc bnc" id="L1143" title="All 2 branches missed.">        return currentMetadata == null ? context.getString(R.string.unknown_content) : currentMetadata.getMetadata().getUrl();</span>
    }

    @NonNull
    public String getVideoTitle() {
<span class="nc bnc" id="L1148" title="All 2 branches missed.">        return currentMetadata == null ? context.getString(R.string.unknown_content) : currentMetadata.getMetadata().getName();</span>
    }

    @NonNull
    public String getUploaderName() {
<span class="nc bnc" id="L1153" title="All 2 branches missed.">        return currentMetadata == null ? context.getString(R.string.unknown_content) : currentMetadata.getMetadata().getUploaderName();</span>
    }

    @Nullable
    public Bitmap getThumbnail() {
<span class="nc bnc" id="L1158" title="All 2 branches missed.">        return currentThumbnail == null ?</span>
<span class="nc" id="L1159">                BitmapFactory.decodeResource(context.getResources(), R.drawable.dummy_thumbnail) :</span>
                currentThumbnail;
    }

    /**
     * Checks if the current playback is a livestream AND is playing at or beyond the live edge
     */
    @SuppressWarnings(&quot;BooleanMethodIsAlwaysInverted&quot;)
    public boolean isLiveEdge() {
<span class="nc bnc" id="L1168" title="All 4 branches missed.">        if (simpleExoPlayer == null || !isLive()) return false;</span>

<span class="nc" id="L1170">        final Timeline currentTimeline = simpleExoPlayer.getCurrentTimeline();</span>
<span class="nc" id="L1171">        final int currentWindowIndex = simpleExoPlayer.getCurrentWindowIndex();</span>
<span class="nc bnc" id="L1172" title="All 4 branches missed.">        if (currentTimeline.isEmpty() || currentWindowIndex &lt; 0 ||</span>
<span class="nc bnc" id="L1173" title="All 2 branches missed.">                currentWindowIndex &gt;= currentTimeline.getWindowCount()) {</span>
<span class="nc" id="L1174">            return false;</span>
        }

<span class="nc" id="L1177">        Timeline.Window timelineWindow = new Timeline.Window();</span>
<span class="nc" id="L1178">        currentTimeline.getWindow(currentWindowIndex, timelineWindow);</span>
<span class="nc bnc" id="L1179" title="All 2 branches missed.">        return timelineWindow.getDefaultPositionMs() &lt;= simpleExoPlayer.getCurrentPosition();</span>
    }

    public boolean isLive() {
<span class="nc bnc" id="L1183" title="All 2 branches missed.">        if (simpleExoPlayer == null) return false;</span>
        try {
<span class="nc" id="L1185">            return simpleExoPlayer.isCurrentWindowDynamic();</span>
<span class="nc" id="L1186">        } catch (@NonNull IndexOutOfBoundsException ignored) {</span>
            // Why would this even happen =(
            // But lets log it anyway. Save is save
<span class="nc bnc" id="L1189" title="All 2 branches missed.">            if (DEBUG) Log.d(TAG, &quot;Could not update metadata: &quot; + ignored.getMessage());</span>
<span class="nc bnc" id="L1190" title="All 2 branches missed.">            if (DEBUG) ignored.printStackTrace();</span>
<span class="nc" id="L1191">            return false;</span>
        }
    }

    public boolean isPlaying() {
<span class="nc bnc" id="L1196" title="All 2 branches missed.">        if (simpleExoPlayer == null) return false;</span>
<span class="nc" id="L1197">        final int state = simpleExoPlayer.getPlaybackState();</span>
<span class="nc bnc" id="L1198" title="All 4 branches missed.">        return (state == Player.STATE_READY || state == Player.STATE_BUFFERING)</span>
<span class="nc bnc" id="L1199" title="All 2 branches missed.">                &amp;&amp; simpleExoPlayer.getPlayWhenReady();</span>
    }

    @Player.RepeatMode
    public int getRepeatMode() {
<span class="nc bnc" id="L1204" title="All 2 branches missed.">        return simpleExoPlayer == null</span>
                ? Player.REPEAT_MODE_OFF
<span class="nc" id="L1206">                : simpleExoPlayer.getRepeatMode();</span>
    }

    public void setRepeatMode(@Player.RepeatMode final int repeatMode) {
<span class="nc bnc" id="L1210" title="All 2 branches missed.">        if (simpleExoPlayer != null) simpleExoPlayer.setRepeatMode(repeatMode);</span>
<span class="nc" id="L1211">    }</span>

    public float getPlaybackSpeed() {
<span class="nc" id="L1214">        return getPlaybackParameters().speed;</span>
    }

    public float getPlaybackPitch() {
<span class="nc" id="L1218">        return getPlaybackParameters().pitch;</span>
    }

    public boolean getPlaybackSkipSilence() {
<span class="nc" id="L1222">        return getPlaybackParameters().skipSilence;</span>
    }

    public void setPlaybackSpeed(float speed) {
<span class="nc" id="L1226">        setPlaybackParameters(speed, getPlaybackPitch(), getPlaybackSkipSilence());</span>
<span class="nc" id="L1227">    }</span>

    public PlaybackParameters getPlaybackParameters() {
<span class="nc bnc" id="L1230" title="All 2 branches missed.">        if (simpleExoPlayer == null) return PlaybackParameters.DEFAULT;</span>
<span class="nc" id="L1231">        final PlaybackParameters parameters = simpleExoPlayer.getPlaybackParameters();</span>
<span class="nc bnc" id="L1232" title="All 2 branches missed.">        return parameters == null ? PlaybackParameters.DEFAULT : parameters;</span>
    }

    public void setPlaybackParameters(float speed, float pitch, boolean skipSilence) {
<span class="nc" id="L1236">        simpleExoPlayer.setPlaybackParameters(new PlaybackParameters(speed, pitch, skipSilence));</span>
<span class="nc" id="L1237">    }</span>

    public PlayQueue getPlayQueue() {
<span class="nc" id="L1240">        return playQueue;</span>
    }

    public PlayQueueAdapter getPlayQueueAdapter() {
<span class="nc" id="L1244">        return playQueueAdapter;</span>
    }

    public boolean isPrepared() {
<span class="nc" id="L1248">        return isPrepared;</span>
    }

    public boolean isProgressLoopRunning() {
<span class="nc bnc" id="L1252" title="All 2 branches missed.">        return progressUpdateReactor.get() != null;</span>
    }

    public void setRecovery() {
<span class="nc bnc" id="L1256" title="All 4 branches missed.">        if (playQueue == null || simpleExoPlayer == null) return;</span>

<span class="nc" id="L1258">        final int queuePos = playQueue.getIndex();</span>
<span class="nc" id="L1259">        final long windowPos = simpleExoPlayer.getCurrentPosition();</span>

<span class="nc bnc" id="L1261" title="All 4 branches missed.">        if (windowPos &gt; 0 &amp;&amp; windowPos &lt;= simpleExoPlayer.getDuration()) {</span>
<span class="nc" id="L1262">            setRecovery(queuePos, windowPos);</span>
        }
<span class="nc" id="L1264">    }</span>

    public void setRecovery(final int queuePos, final long windowPos) {
<span class="nc bnc" id="L1267" title="All 2 branches missed.">        if (playQueue.size() &lt;= queuePos) return;</span>

<span class="nc bnc" id="L1269" title="All 2 branches missed.">        if (DEBUG) Log.d(TAG, &quot;Setting recovery, queue: &quot; + queuePos + &quot;, pos: &quot; + windowPos);</span>
<span class="nc" id="L1270">        playQueue.setRecovery(queuePos, windowPos);</span>
<span class="nc" id="L1271">    }</span>

    public boolean gotDestroyed() {
<span class="nc bnc" id="L1274" title="All 2 branches missed.">        return simpleExoPlayer == null;</span>
    }

    private boolean isPlaybackResumeEnabled() {
<span class="nc" id="L1278">        final SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(context);</span>
<span class="nc bnc" id="L1279" title="All 2 branches missed.">        return prefs.getBoolean(context.getString(R.string.enable_watch_history_key), true)</span>
<span class="nc bnc" id="L1280" title="All 2 branches missed.">                &amp;&amp; prefs.getBoolean(context.getString(R.string.enable_playback_resume_key), true);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span>Generated by the Android Gradle plugin 3.2.0</div></body></html>