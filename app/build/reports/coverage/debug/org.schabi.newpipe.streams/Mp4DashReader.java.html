<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Mp4DashReader.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">debugAndroidTest</a> &gt; <a href="index.source.html" class="el_package">org.schabi.newpipe.streams</a> &gt; <span class="el_source">Mp4DashReader.java</span></div><h1>Mp4DashReader.java</h1><pre class="source lang-java linenums">package org.schabi.newpipe.streams;

import org.schabi.newpipe.streams.io.SharpStream;

import java.io.EOFException;
import java.io.IOException;
import java.io.InputStream;
import java.io.UnsupportedEncodingException;
import java.nio.ByteBuffer;
import java.util.ArrayList;
import java.util.NoSuchElementException;

/**
 * @author kapodamy
 */
public class Mp4DashReader {

    // &lt;editor-fold defaultState=&quot;collapsed&quot; desc=&quot;Constants&quot;&gt;
    private static final int ATOM_MOOF = 0x6D6F6F66;
    private static final int ATOM_MFHD = 0x6D666864;
    private static final int ATOM_TRAF = 0x74726166;
    private static final int ATOM_TFHD = 0x74666864;
    private static final int ATOM_TFDT = 0x74666474;
    private static final int ATOM_TRUN = 0x7472756E;
    private static final int ATOM_MDIA = 0x6D646961;
    private static final int ATOM_FTYP = 0x66747970;
    private static final int ATOM_SIDX = 0x73696478;
    private static final int ATOM_MOOV = 0x6D6F6F76;
    private static final int ATOM_MDAT = 0x6D646174;
    private static final int ATOM_MVHD = 0x6D766864;
    private static final int ATOM_TRAK = 0x7472616B;
    private static final int ATOM_MVEX = 0x6D766578;
    private static final int ATOM_TREX = 0x74726578;
    private static final int ATOM_TKHD = 0x746B6864;
    private static final int ATOM_MFRA = 0x6D667261;
    private static final int ATOM_MDHD = 0x6D646864;
    private static final int ATOM_EDTS = 0x65647473;
    private static final int ATOM_ELST = 0x656C7374;
    private static final int ATOM_HDLR = 0x68646C72;
    private static final int ATOM_MINF = 0x6D696E66;
    private static final int ATOM_DINF = 0x64696E66;
    private static final int ATOM_STBL = 0x7374626C;
    private static final int ATOM_STSD = 0x73747364;
    private static final int ATOM_VMHD = 0x766D6864;
    private static final int ATOM_SMHD = 0x736D6864;

    private static final int BRAND_DASH = 0x64617368;
    private static final int BRAND_ISO5 = 0x69736F35;

    private static final int HANDLER_VIDE = 0x76696465;
    private static final int HANDLER_SOUN = 0x736F756E;
    private static final int HANDLER_SUBT = 0x73756274;
    // &lt;/editor-fold&gt;

    private final DataReader stream;

<span class="nc" id="L57">    private Mp4Track[] tracks = null;</span>
<span class="nc" id="L58">    private int[] brands = null;</span>

    private Box box;
    private Moof moof;

<span class="nc" id="L63">    private boolean chunkZero = false;</span>

<span class="nc" id="L65">    private int selectedTrack = -1;</span>
<span class="nc" id="L66">    private Box backupBox = null;</span>

<span class="nc" id="L68">    public enum TrackKind {</span>
<span class="nc" id="L69">        Audio, Video, Subtitles, Other</span>
    }

<span class="nc" id="L72">    public Mp4DashReader(SharpStream source) {</span>
<span class="nc" id="L73">        this.stream = new DataReader(source);</span>
<span class="nc" id="L74">    }</span>

    public void parse() throws IOException, NoSuchElementException {
<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (selectedTrack &gt; -1) {</span>
<span class="nc" id="L78">            return;</span>
        }

<span class="nc" id="L81">        box = readBox(ATOM_FTYP);</span>
<span class="nc" id="L82">        brands = parse_ftyp(box);</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">        switch (brands[0]) {</span>
            case BRAND_DASH:
            case BRAND_ISO5:// Â¿why not?
<span class="nc" id="L86">                break;</span>
            default:
<span class="nc" id="L88">                throw new NoSuchElementException(</span>
<span class="nc" id="L89">                        &quot;Not a MPEG-4 DASH container, major brand is not 'dash' or 'iso5' is &quot; + boxName(brands[0])</span>
                );
        }

<span class="nc" id="L93">        Moov moov = null;</span>
        int i;

<span class="nc bnc" id="L96" title="All 2 branches missed.">        while (box.type != ATOM_MOOF) {</span>
<span class="nc" id="L97">            ensure(box);</span>
<span class="nc" id="L98">            box = readBox();</span>

<span class="nc bnc" id="L100" title="All 3 branches missed.">            switch (box.type) {</span>
                case ATOM_MOOV:
<span class="nc" id="L102">                    moov = parse_moov(box);</span>
<span class="nc" id="L103">                    break;</span>
                case ATOM_SIDX:
<span class="nc" id="L105">                    break;</span>
                case ATOM_MFRA:
<span class="nc" id="L107">                    break;</span>
            }
        }

<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (moov == null) {</span>
<span class="nc" id="L112">            throw new IOException(&quot;The provided Mp4 doesn't have the 'moov' box&quot;);</span>
        }

<span class="nc" id="L115">        tracks = new Mp4Track[moov.trak.length];</span>

<span class="nc bnc" id="L117" title="All 2 branches missed.">        for (i = 0; i &lt; tracks.length; i++) {</span>
<span class="nc" id="L118">            tracks[i] = new Mp4Track();</span>
<span class="nc" id="L119">            tracks[i].trak = moov.trak[i];</span>

<span class="nc bnc" id="L121" title="All 2 branches missed.">            if (moov.mvex_trex != null) {</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">                for (Trex mvex_trex : moov.mvex_trex) {</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">                    if (tracks[i].trak.tkhd.trackId == mvex_trex.trackId) {</span>
<span class="nc" id="L124">                        tracks[i].trex = mvex_trex;</span>
                    }
                }
            }

<span class="nc bnc" id="L129" title="All 4 branches missed.">            switch (moov.trak[i].mdia.hdlr.subType) {</span>
                case HANDLER_VIDE:
<span class="nc" id="L131">                    tracks[i].kind = TrackKind.Video;</span>
<span class="nc" id="L132">                    break;</span>
                case HANDLER_SOUN:
<span class="nc" id="L134">                    tracks[i].kind = TrackKind.Audio;</span>
<span class="nc" id="L135">                    break;</span>
                case HANDLER_SUBT:
<span class="nc" id="L137">                    tracks[i].kind = TrackKind.Subtitles;</span>
<span class="nc" id="L138">                    break;</span>
                default:
<span class="nc" id="L140">                    tracks[i].kind = TrackKind.Other;</span>
                    break;
            }
        }

<span class="nc" id="L145">        backupBox = box;</span>
<span class="nc" id="L146">    }</span>

    Mp4Track selectTrack(int index) {
<span class="nc" id="L149">        selectedTrack = index;</span>
<span class="nc" id="L150">        return tracks[index];</span>
    }

    /**
     * Count all fragments present. This operation requires a seekable stream
     *
     * @return list with a basic info
     * @throws IOException if the source stream is not seekeable
     */
    int getFragmentsCount() throws IOException {
<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (selectedTrack &lt; 0) {</span>
<span class="nc" id="L161">            throw new IllegalStateException(&quot;track no selected&quot;);</span>
        }
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (!stream.canRewind()) {</span>
<span class="nc" id="L164">            throw new IOException(&quot;The provided stream doesn't allow seek&quot;);</span>
        }

        Box tmp;
<span class="nc" id="L168">        int count = 0;</span>

<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (box.type == ATOM_MOOF) {</span>
<span class="nc" id="L171">            tmp = box;</span>
        } else {
<span class="nc" id="L173">            ensure(box);</span>
<span class="nc" id="L174">            tmp = readBox();</span>
        }

        do {
<span class="nc bnc" id="L178" title="All 2 branches missed.">            if (tmp.type == ATOM_MOOF) {</span>
<span class="nc" id="L179">                ensure(readBox(ATOM_MFHD));</span>
                Box traf;
<span class="nc bnc" id="L181" title="All 2 branches missed.">                while ((traf = untilBox(tmp, ATOM_TRAF)) != null) {</span>
<span class="nc" id="L182">                    Box tfhd = readBox(ATOM_TFHD);</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">                    if (parse_tfhd(tracks[selectedTrack].trak.tkhd.trackId) != null) {</span>
<span class="nc" id="L184">                        count++;</span>
<span class="nc" id="L185">                        break;</span>
                    }
<span class="nc" id="L187">                    ensure(tfhd);</span>
<span class="nc" id="L188">                    ensure(traf);</span>
<span class="nc" id="L189">                }</span>
            }
<span class="nc" id="L191">            ensure(tmp);</span>
<span class="nc bnc" id="L192" title="All 4 branches missed.">        } while (stream.available() &amp;&amp; (tmp = readBox()) != null);</span>

<span class="nc" id="L194">        rewind();</span>

<span class="nc" id="L196">        return count;</span>
    }

    public int[] getBrands() {
<span class="nc bnc" id="L200" title="All 2 branches missed.">        if (brands == null) throw new IllegalStateException(&quot;Not parsed&quot;);</span>
<span class="nc" id="L201">        return brands;</span>
    }

    public void rewind() throws IOException {
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (!stream.canRewind()) {</span>
<span class="nc" id="L206">            throw new IOException(&quot;The provided stream doesn't allow seek&quot;);</span>
        }
<span class="nc bnc" id="L208" title="All 2 branches missed.">        if (box == null) {</span>
<span class="nc" id="L209">            return;</span>
        }

<span class="nc" id="L212">        box = backupBox;</span>
<span class="nc" id="L213">        chunkZero = false;</span>

<span class="nc" id="L215">        stream.rewind();</span>
<span class="nc" id="L216">        stream.skipBytes(backupBox.offset + (DataReader.INTEGER_SIZE * 2));</span>
<span class="nc" id="L217">    }</span>

    public Mp4Track[] getAvailableTracks() {
<span class="nc" id="L220">        return tracks;</span>
    }

    public Mp4DashChunk getNextChunk(boolean infoOnly) throws IOException {
<span class="nc" id="L224">        Mp4Track track = tracks[selectedTrack];</span>

<span class="nc bnc" id="L226" title="All 2 branches missed.">        while (stream.available()) {</span>

<span class="nc bnc" id="L228" title="All 2 branches missed.">            if (chunkZero) {</span>
<span class="nc" id="L229">                ensure(box);</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">                if (!stream.available()) {</span>
<span class="nc" id="L231">                    break;</span>
                }
<span class="nc" id="L233">                box = readBox();</span>
            } else {
<span class="nc" id="L235">                chunkZero = true;</span>
            }

<span class="nc bnc" id="L238" title="All 3 branches missed.">            switch (box.type) {</span>
                case ATOM_MOOF:
<span class="nc bnc" id="L240" title="All 2 branches missed.">                    if (moof != null) {</span>
<span class="nc" id="L241">                        throw new IOException(&quot;moof found without mdat&quot;);</span>
                    }

<span class="nc" id="L244">                    moof = parse_moof(box, track.trak.tkhd.trackId);</span>

<span class="nc bnc" id="L246" title="All 2 branches missed.">                    if (moof.traf != null) {</span>

<span class="nc bnc" id="L248" title="All 2 branches missed.">                        if (hasFlag(moof.traf.trun.bFlags, 0x0001)) {</span>
<span class="nc" id="L249">                            moof.traf.trun.dataOffset -= box.size + 8;</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">                            if (moof.traf.trun.dataOffset &lt; 0) {</span>
<span class="nc" id="L251">                                throw new IOException(&quot;trun box has wrong data offset, points outside of concurrent mdat box&quot;);</span>
                            }
                        }

<span class="nc bnc" id="L255" title="All 2 branches missed.">                        if (moof.traf.trun.chunkSize &lt; 1) {</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">                            if (hasFlag(moof.traf.tfhd.bFlags, 0x10)) {</span>
<span class="nc" id="L257">                                moof.traf.trun.chunkSize = moof.traf.tfhd.defaultSampleSize * moof.traf.trun.entryCount;</span>
                            } else {
<span class="nc" id="L259">                                moof.traf.trun.chunkSize = (int) (box.size - 8);</span>
                            }
                        }
<span class="nc bnc" id="L262" title="All 4 branches missed.">                        if (!hasFlag(moof.traf.trun.bFlags, 0x900) &amp;&amp; moof.traf.trun.chunkDuration == 0) {</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">                            if (hasFlag(moof.traf.tfhd.bFlags, 0x20)) {</span>
<span class="nc" id="L264">                                moof.traf.trun.chunkDuration = moof.traf.tfhd.defaultSampleDuration * moof.traf.trun.entryCount;</span>
                            }
                        }
                    }
                    break;
                case ATOM_MDAT:
<span class="nc bnc" id="L270" title="All 2 branches missed.">                    if (moof == null) {</span>
<span class="nc" id="L271">                        throw new IOException(&quot;mdat found without moof&quot;);</span>
                    }

<span class="nc bnc" id="L274" title="All 2 branches missed.">                    if (moof.traf == null) {</span>
<span class="nc" id="L275">                        moof = null;</span>
<span class="nc" id="L276">                        continue;// find another chunk</span>
                    }

<span class="nc" id="L279">                    Mp4DashChunk chunk = new Mp4DashChunk();</span>
<span class="nc" id="L280">                    chunk.moof = moof;</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">                    if (!infoOnly) {</span>
<span class="nc" id="L282">                        chunk.data = stream.getView(moof.traf.trun.chunkSize);</span>
                    }

<span class="nc" id="L285">                    moof = null;</span>

<span class="nc" id="L287">                    stream.skipBytes(chunk.moof.traf.trun.dataOffset);</span>
<span class="nc" id="L288">                    return chunk;</span>
                default:
            }
        }

<span class="nc" id="L293">        return null;</span>
    }

    // &lt;editor-fold defaultState=&quot;collapsed&quot; desc=&quot;Utils&quot;&gt;
    private long readUint() throws IOException {
<span class="nc" id="L298">        return stream.readInt() &amp; 0xffffffffL;</span>
    }

    public static boolean hasFlag(int flags, int mask) {
<span class="nc bnc" id="L302" title="All 2 branches missed.">        return (flags &amp; mask) == mask;</span>
    }

    private String boxName(Box ref) {
<span class="nc" id="L306">        return boxName(ref.type);</span>
    }

    private String boxName(int type) {
        try {
<span class="nc" id="L311">            return new String(ByteBuffer.allocate(4).putInt(type).array(), &quot;UTF-8&quot;);</span>
<span class="nc" id="L312">        } catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L313">            return &quot;0x&quot; + Integer.toHexString(type);</span>
        }
    }

    private Box readBox() throws IOException {
<span class="nc" id="L318">        Box b = new Box();</span>
<span class="nc" id="L319">        b.offset = stream.position();</span>
<span class="nc" id="L320">        b.size = stream.readInt();</span>
<span class="nc" id="L321">        b.type = stream.readInt();</span>

<span class="nc bnc" id="L323" title="All 2 branches missed.">        if (b.size == 1) {</span>
<span class="nc" id="L324">            b.size = stream.readLong();</span>
        }

<span class="nc" id="L327">        return b;</span>
    }

    private Box readBox(int expected) throws IOException {
<span class="nc" id="L331">        Box b = readBox();</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">        if (b.type != expected) {</span>
<span class="nc" id="L333">            throw new NoSuchElementException(&quot;expected &quot; + boxName(expected) + &quot; found &quot; + boxName(b));</span>
        }
<span class="nc" id="L335">        return b;</span>
    }

    private byte[] readFullBox(Box ref) throws IOException {
        // full box reading is limited to 2 GiB, and should be enough
<span class="nc" id="L340">        int size = (int) ref.size;</span>

<span class="nc" id="L342">        ByteBuffer buffer = ByteBuffer.allocate(size);</span>
<span class="nc" id="L343">        buffer.putInt(size);</span>
<span class="nc" id="L344">        buffer.putInt(ref.type);</span>

<span class="nc" id="L346">        int read = size - 8;</span>

<span class="nc bnc" id="L348" title="All 2 branches missed.">        if (stream.read(buffer.array(), 8, read) != read) {</span>
<span class="nc" id="L349">            throw new EOFException(</span>
<span class="nc" id="L350">                    String.format(&quot;EOF reached in box: type=%s offset=%s size=%s&quot;, boxName(ref.type), ref.offset, ref.size)</span>
            );
        }

<span class="nc" id="L354">        return buffer.array();</span>
    }

    private void ensure(Box ref) throws IOException {
<span class="nc" id="L358">        long skip = ref.offset + ref.size - stream.position();</span>

<span class="nc bnc" id="L360" title="All 2 branches missed.">        if (skip == 0) {</span>
<span class="nc" id="L361">            return;</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">        } else if (skip &lt; 0) {</span>
<span class="nc" id="L363">            throw new EOFException(String.format(</span>
                    &quot;parser go beyond limits of the box. type=%s offset=%s size=%s position=%s&quot;,
<span class="nc" id="L365">                    boxName(ref), ref.offset, ref.size, stream.position()</span>
            ));
        }

<span class="nc" id="L369">        stream.skipBytes((int) skip);</span>
<span class="nc" id="L370">    }</span>

    private Box untilBox(Box ref, int... expected) throws IOException {
        Box b;
<span class="nc bnc" id="L374" title="All 2 branches missed.">        while (stream.position() &lt; (ref.offset + ref.size)) {</span>
<span class="nc" id="L375">            b = readBox();</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">            for (int type : expected) {</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">                if (b.type == type) {</span>
<span class="nc" id="L378">                    return b;</span>
                }
            }
<span class="nc" id="L381">            ensure(b);</span>
        }

<span class="nc" id="L384">        return null;</span>
    }

    private Box untilAnyBox(Box ref) throws IOException {
<span class="nc bnc" id="L388" title="All 2 branches missed.">        if (stream.position() &gt;= (ref.offset + ref.size)) {</span>
<span class="nc" id="L389">            return null;</span>
        }

<span class="nc" id="L392">        return readBox();</span>
    }

    // &lt;/editor-fold&gt;

    // &lt;editor-fold defaultState=&quot;collapsed&quot; desc=&quot;Box readers&quot;&gt;

    private Moof parse_moof(Box ref, int trackId) throws IOException {
<span class="nc" id="L400">        Moof obj = new Moof();</span>

<span class="nc" id="L402">        Box b = readBox(ATOM_MFHD);</span>
<span class="nc" id="L403">        obj.mfhd_SequenceNumber = parse_mfhd();</span>
<span class="nc" id="L404">        ensure(b);</span>

<span class="nc bnc" id="L406" title="All 2 branches missed.">        while ((b = untilBox(ref, ATOM_TRAF)) != null) {</span>
<span class="nc" id="L407">            obj.traf = parse_traf(b, trackId);</span>
<span class="nc" id="L408">            ensure(b);</span>

<span class="nc bnc" id="L410" title="All 2 branches missed.">            if (obj.traf != null) {</span>
<span class="nc" id="L411">                return obj;</span>
            }
        }

<span class="nc" id="L415">        return obj;</span>
    }

    private int parse_mfhd() throws IOException {
        // version
        // flags
<span class="nc" id="L421">        stream.skipBytes(4);</span>

<span class="nc" id="L423">        return stream.readInt();</span>
    }

    private Traf parse_traf(Box ref, int trackId) throws IOException {
<span class="nc" id="L427">        Traf traf = new Traf();</span>

<span class="nc" id="L429">        Box b = readBox(ATOM_TFHD);</span>
<span class="nc" id="L430">        traf.tfhd = parse_tfhd(trackId);</span>
<span class="nc" id="L431">        ensure(b);</span>

<span class="nc bnc" id="L433" title="All 2 branches missed.">        if (traf.tfhd == null) {</span>
<span class="nc" id="L434">            return null;</span>
        }

<span class="nc" id="L437">        b = untilBox(ref, ATOM_TRUN, ATOM_TFDT);</span>

<span class="nc bnc" id="L439" title="All 2 branches missed.">        if (b.type == ATOM_TFDT) {</span>
<span class="nc" id="L440">            traf.tfdt = parse_tfdt();</span>
<span class="nc" id="L441">            ensure(b);</span>
<span class="nc" id="L442">            b = readBox(ATOM_TRUN);</span>
        }

<span class="nc" id="L445">        traf.trun = parse_trun();</span>
<span class="nc" id="L446">        ensure(b);</span>

<span class="nc" id="L448">        return traf;</span>
    }

    private Tfhd parse_tfhd(int trackId) throws IOException {
<span class="nc" id="L452">        Tfhd obj = new Tfhd();</span>

<span class="nc" id="L454">        obj.bFlags = stream.readInt();</span>
<span class="nc" id="L455">        obj.trackId = stream.readInt();</span>

<span class="nc bnc" id="L457" title="All 4 branches missed.">        if (trackId != -1 &amp;&amp; obj.trackId != trackId) {</span>
<span class="nc" id="L458">            return null;</span>
        }

<span class="nc bnc" id="L461" title="All 2 branches missed.">        if (hasFlag(obj.bFlags, 0x01)) {</span>
<span class="nc" id="L462">            stream.skipBytes(8);</span>
        }
<span class="nc bnc" id="L464" title="All 2 branches missed.">        if (hasFlag(obj.bFlags, 0x02)) {</span>
<span class="nc" id="L465">            stream.skipBytes(4);</span>
        }
<span class="nc bnc" id="L467" title="All 2 branches missed.">        if (hasFlag(obj.bFlags, 0x08)) {</span>
<span class="nc" id="L468">            obj.defaultSampleDuration = stream.readInt();</span>
        }
<span class="nc bnc" id="L470" title="All 2 branches missed.">        if (hasFlag(obj.bFlags, 0x10)) {</span>
<span class="nc" id="L471">            obj.defaultSampleSize = stream.readInt();</span>
        }
<span class="nc bnc" id="L473" title="All 2 branches missed.">        if (hasFlag(obj.bFlags, 0x20)) {</span>
<span class="nc" id="L474">            obj.defaultSampleFlags = stream.readInt();</span>
        }

<span class="nc" id="L477">        return obj;</span>
    }

    private long parse_tfdt() throws IOException {
<span class="nc" id="L481">        int version = stream.read();</span>
<span class="nc" id="L482">        stream.skipBytes(3);// flags</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">        return version == 0 ? readUint() : stream.readLong();</span>
    }

    private Trun parse_trun() throws IOException {
<span class="nc" id="L487">        Trun obj = new Trun();</span>
<span class="nc" id="L488">        obj.bFlags = stream.readInt();</span>
<span class="nc" id="L489">        obj.entryCount = stream.readInt();// unsigned int</span>

<span class="nc" id="L491">        obj.entries_rowSize = 0;</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">        if (hasFlag(obj.bFlags, 0x0100)) {</span>
<span class="nc" id="L493">            obj.entries_rowSize += 4;</span>
        }
<span class="nc bnc" id="L495" title="All 2 branches missed.">        if (hasFlag(obj.bFlags, 0x0200)) {</span>
<span class="nc" id="L496">            obj.entries_rowSize += 4;</span>
        }
<span class="nc bnc" id="L498" title="All 2 branches missed.">        if (hasFlag(obj.bFlags, 0x0400)) {</span>
<span class="nc" id="L499">            obj.entries_rowSize += 4;</span>
        }
<span class="nc bnc" id="L501" title="All 2 branches missed.">        if (hasFlag(obj.bFlags, 0x0800)) {</span>
<span class="nc" id="L502">            obj.entries_rowSize += 4;</span>
        }
<span class="nc" id="L504">        obj.bEntries = new byte[obj.entries_rowSize * obj.entryCount];</span>

<span class="nc bnc" id="L506" title="All 2 branches missed.">        if (hasFlag(obj.bFlags, 0x0001)) {</span>
<span class="nc" id="L507">            obj.dataOffset = stream.readInt();</span>
        }
<span class="nc bnc" id="L509" title="All 2 branches missed.">        if (hasFlag(obj.bFlags, 0x0004)) {</span>
<span class="nc" id="L510">            obj.bFirstSampleFlags = stream.readInt();</span>
        }

<span class="nc" id="L513">        stream.read(obj.bEntries);</span>

<span class="nc bnc" id="L515" title="All 2 branches missed.">        for (int i = 0; i &lt; obj.entryCount; i++) {</span>
<span class="nc" id="L516">            TrunEntry entry = obj.getEntry(i);</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">            if (hasFlag(obj.bFlags, 0x0100)) {</span>
<span class="nc" id="L518">                obj.chunkDuration += entry.sampleDuration;</span>
            }
<span class="nc bnc" id="L520" title="All 2 branches missed.">            if (hasFlag(obj.bFlags, 0x0200)) {</span>
<span class="nc" id="L521">                obj.chunkSize += entry.sampleSize;</span>
            }
<span class="nc bnc" id="L523" title="All 2 branches missed.">            if (hasFlag(obj.bFlags, 0x0800)) {</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">                if (!hasFlag(obj.bFlags, 0x0100)) {</span>
<span class="nc" id="L525">                    obj.chunkDuration += entry.sampleCompositionTimeOffset;</span>
                }
            }
        }

<span class="nc" id="L530">        return obj;</span>
    }

    private int[] parse_ftyp(Box ref) throws IOException {
<span class="nc" id="L534">        int i = 0;</span>
<span class="nc" id="L535">        int[] list = new int[(int) ((ref.offset + ref.size - stream.position() - 4) / 4)];</span>

<span class="nc" id="L537">        list[i++] = stream.readInt();// major brand</span>

<span class="nc" id="L539">        stream.skipBytes(4);// minor version</span>

<span class="nc bnc" id="L541" title="All 2 branches missed.">        for (; i &lt; list.length; i++)</span>
<span class="nc" id="L542">            list[i] = stream.readInt();// compatible brands</span>

<span class="nc" id="L544">        return list;</span>
    }

    private Mvhd parse_mvhd() throws IOException {
<span class="nc" id="L548">        int version = stream.read();</span>
<span class="nc" id="L549">        stream.skipBytes(3);// flags</span>

        // creation entries_time
        // modification entries_time
<span class="nc bnc" id="L553" title="All 2 branches missed.">        stream.skipBytes(2 * (version == 0 ? 4 : 8));</span>

<span class="nc" id="L555">        Mvhd obj = new Mvhd();</span>
<span class="nc" id="L556">        obj.timeScale = readUint();</span>

        // chunkDuration
<span class="nc bnc" id="L559" title="All 2 branches missed.">        stream.skipBytes(version == 0 ? 4 : 8);</span>

        // rate
        // volume
        // reserved
        // matrix array
        // predefined
<span class="nc" id="L566">        stream.skipBytes(76);</span>

<span class="nc" id="L568">        obj.nextTrackId = readUint();</span>

<span class="nc" id="L570">        return obj;</span>
    }

    private Tkhd parse_tkhd() throws IOException {
<span class="nc" id="L574">        int version = stream.read();</span>

<span class="nc" id="L576">        Tkhd obj = new Tkhd();</span>

        // flags
        // creation entries_time
        // modification entries_time
<span class="nc bnc" id="L581" title="All 2 branches missed.">        stream.skipBytes(3 + (2 * (version == 0 ? 4 : 8)));</span>

<span class="nc" id="L583">        obj.trackId = stream.readInt();</span>

<span class="nc" id="L585">        stream.skipBytes(4);// reserved</span>

<span class="nc bnc" id="L587" title="All 2 branches missed.">        obj.duration = version == 0 ? readUint() : stream.readLong();</span>

<span class="nc" id="L589">        stream.skipBytes(2 * 4);// reserved</span>

<span class="nc" id="L591">        obj.bLayer = stream.readShort();</span>
<span class="nc" id="L592">        obj.bAlternateGroup = stream.readShort();</span>
<span class="nc" id="L593">        obj.bVolume = stream.readShort();</span>

<span class="nc" id="L595">        stream.skipBytes(2);// reserved</span>

<span class="nc" id="L597">        obj.matrix = new byte[9 * 4];</span>
<span class="nc" id="L598">        stream.read(obj.matrix);</span>

<span class="nc" id="L600">        obj.bWidth = stream.readInt();</span>
<span class="nc" id="L601">        obj.bHeight = stream.readInt();</span>

<span class="nc" id="L603">        return obj;</span>
    }

    private Trak parse_trak(Box ref) throws IOException {
<span class="nc" id="L607">        Trak trak = new Trak();</span>

<span class="nc" id="L609">        Box b = readBox(ATOM_TKHD);</span>
<span class="nc" id="L610">        trak.tkhd = parse_tkhd();</span>
<span class="nc" id="L611">        ensure(b);</span>

<span class="nc bnc" id="L613" title="All 2 branches missed.">        while ((b = untilBox(ref, ATOM_MDIA, ATOM_EDTS)) != null) {</span>
<span class="nc bnc" id="L614" title="All 3 branches missed.">            switch (b.type) {</span>
                case ATOM_MDIA:
<span class="nc" id="L616">                    trak.mdia = parse_mdia(b);</span>
<span class="nc" id="L617">                    break;</span>
                case ATOM_EDTS:
<span class="nc" id="L619">                    trak.edst_elst = parse_edts(b);</span>
                    break;
            }

<span class="nc" id="L623">            ensure(b);</span>
        }

<span class="nc" id="L626">        return trak;</span>
    }

    private Mdia parse_mdia(Box ref) throws IOException {
<span class="nc" id="L630">        Mdia obj = new Mdia();</span>

        Box b;
<span class="nc bnc" id="L633" title="All 2 branches missed.">        while ((b = untilBox(ref, ATOM_MDHD, ATOM_HDLR, ATOM_MINF)) != null) {</span>
<span class="nc bnc" id="L634" title="All 4 branches missed.">            switch (b.type) {</span>
                case ATOM_MDHD:
<span class="nc" id="L636">                    obj.mdhd = readFullBox(b);</span>

                    // read time scale
<span class="nc" id="L639">                    ByteBuffer buffer = ByteBuffer.wrap(obj.mdhd);</span>
<span class="nc" id="L640">                    byte version = buffer.get(8);</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">                    buffer.position(12 + ((version == 0 ? 4 : 8) * 2));</span>
<span class="nc" id="L642">                    obj.mdhd_timeScale = buffer.getInt();</span>
<span class="nc" id="L643">                    break;</span>
                case ATOM_HDLR:
<span class="nc" id="L645">                    obj.hdlr = parse_hdlr(b);</span>
<span class="nc" id="L646">                    break;</span>
                case ATOM_MINF:
<span class="nc" id="L648">                    obj.minf = parse_minf(b);</span>
                    break;
            }
<span class="nc" id="L651">            ensure(b);</span>
        }

<span class="nc" id="L654">        return obj;</span>
    }

    private Hdlr parse_hdlr(Box ref) throws IOException {
        // version
        // flags
<span class="nc" id="L660">        stream.skipBytes(4);</span>

<span class="nc" id="L662">        Hdlr obj = new Hdlr();</span>
<span class="nc" id="L663">        obj.bReserved = new byte[12];</span>

<span class="nc" id="L665">        obj.type = stream.readInt();</span>
<span class="nc" id="L666">        obj.subType = stream.readInt();</span>
<span class="nc" id="L667">        stream.read(obj.bReserved);</span>

        // component name (is a ansi/ascii string)
<span class="nc" id="L670">        stream.skipBytes((ref.offset + ref.size) - stream.position());</span>

<span class="nc" id="L672">        return obj;</span>
    }

    private Moov parse_moov(Box ref) throws IOException {
<span class="nc" id="L676">        Box b = readBox(ATOM_MVHD);</span>
<span class="nc" id="L677">        Moov moov = new Moov();</span>
<span class="nc" id="L678">        moov.mvhd = parse_mvhd();</span>
<span class="nc" id="L679">        ensure(b);</span>

<span class="nc" id="L681">        ArrayList&lt;Trak&gt; tmp = new ArrayList&lt;&gt;((int) moov.mvhd.nextTrackId);</span>
<span class="nc bnc" id="L682" title="All 2 branches missed.">        while ((b = untilBox(ref, ATOM_TRAK, ATOM_MVEX)) != null) {</span>

<span class="nc bnc" id="L684" title="All 3 branches missed.">            switch (b.type) {</span>
                case ATOM_TRAK:
<span class="nc" id="L686">                    tmp.add(parse_trak(b));</span>
<span class="nc" id="L687">                    break;</span>
                case ATOM_MVEX:
<span class="nc" id="L689">                    moov.mvex_trex = parse_mvex(b, (int) moov.mvhd.nextTrackId);</span>
                    break;
            }

<span class="nc" id="L693">            ensure(b);</span>
        }

<span class="nc" id="L696">        moov.trak = tmp.toArray(new Trak[0]);</span>

<span class="nc" id="L698">        return moov;</span>
    }

    private Trex[] parse_mvex(Box ref, int possibleTrackCount) throws IOException {
<span class="nc" id="L702">        ArrayList&lt;Trex&gt; tmp = new ArrayList&lt;&gt;(possibleTrackCount);</span>

        Box b;
<span class="nc bnc" id="L705" title="All 2 branches missed.">        while ((b = untilBox(ref, ATOM_TREX)) != null) {</span>
<span class="nc" id="L706">            tmp.add(parse_trex());</span>
<span class="nc" id="L707">            ensure(b);</span>
        }

<span class="nc" id="L710">        return tmp.toArray(new Trex[0]);</span>
    }

    private Trex parse_trex() throws IOException {
        // version
        // flags
<span class="nc" id="L716">        stream.skipBytes(4);</span>

<span class="nc" id="L718">        Trex obj = new Trex();</span>
<span class="nc" id="L719">        obj.trackId = stream.readInt();</span>
<span class="nc" id="L720">        obj.defaultSampleDescriptionIndex = stream.readInt();</span>
<span class="nc" id="L721">        obj.defaultSampleDuration = stream.readInt();</span>
<span class="nc" id="L722">        obj.defaultSampleSize = stream.readInt();</span>
<span class="nc" id="L723">        obj.defaultSampleFlags = stream.readInt();</span>

<span class="nc" id="L725">        return obj;</span>
    }

    private Elst parse_edts(Box ref) throws IOException {
<span class="nc" id="L729">        Box b = untilBox(ref, ATOM_ELST);</span>
<span class="nc bnc" id="L730" title="All 2 branches missed.">        if (b == null) {</span>
<span class="nc" id="L731">            return null;</span>
        }

<span class="nc" id="L734">        Elst obj = new Elst();</span>

<span class="nc bnc" id="L736" title="All 2 branches missed.">        boolean v1 = stream.read() == 1;</span>
<span class="nc" id="L737">        stream.skipBytes(3);// flags</span>

<span class="nc" id="L739">        int entryCount = stream.readInt();</span>
<span class="nc bnc" id="L740" title="All 2 branches missed.">        if (entryCount &lt; 1) {</span>
<span class="nc" id="L741">            obj.bMediaRate = 0x00010000;// default media rate (1.0)</span>
<span class="nc" id="L742">            return obj;</span>
        }

<span class="nc bnc" id="L745" title="All 2 branches missed.">        if (v1) {</span>
<span class="nc" id="L746">            stream.skipBytes(DataReader.LONG_SIZE);// segment duration</span>
<span class="nc" id="L747">            obj.MediaTime = stream.readLong();</span>
            // ignore all remain entries
<span class="nc" id="L749">            stream.skipBytes((entryCount - 1) * (DataReader.LONG_SIZE * 2));</span>
        } else {
<span class="nc" id="L751">            stream.skipBytes(DataReader.INTEGER_SIZE);// segment duration</span>
<span class="nc" id="L752">            obj.MediaTime = stream.readInt();</span>
        }

<span class="nc" id="L755">        obj.bMediaRate = stream.readInt();</span>

<span class="nc" id="L757">        return obj;</span>
    }

    private Minf parse_minf(Box ref) throws IOException {
<span class="nc" id="L761">        Minf obj = new Minf();</span>

        Box b;
<span class="nc bnc" id="L764" title="All 2 branches missed.">        while ((b = untilAnyBox(ref)) != null) {</span>

<span class="nc bnc" id="L766" title="All 4 branches missed.">            switch (b.type) {</span>
                case ATOM_DINF:
<span class="nc" id="L768">                    obj.dinf = readFullBox(b);</span>
<span class="nc" id="L769">                    break;</span>
                case ATOM_STBL:
<span class="nc" id="L771">                    obj.stbl_stsd = parse_stbl(b);</span>
<span class="nc" id="L772">                    break;</span>
                case ATOM_VMHD:
                case ATOM_SMHD:
<span class="nc" id="L775">                    obj.$mhd = readFullBox(b);</span>
                    break;

            }
<span class="nc" id="L779">            ensure(b);</span>
        }

<span class="nc" id="L782">        return obj;</span>
    }

    /**
     * this only read the &quot;stsd&quot; box inside
     */
    private byte[] parse_stbl(Box ref) throws IOException {
<span class="nc" id="L789">        Box b = untilBox(ref, ATOM_STSD);</span>

<span class="nc bnc" id="L791" title="All 2 branches missed.">        if (b == null) {</span>
<span class="nc" id="L792">            return new byte[0];// this never should happens (missing codec startup data)</span>
        }

<span class="nc" id="L795">        return readFullBox(b);</span>
    }

    // &lt;/editor-fold&gt;

    // &lt;editor-fold defaultState=&quot;collapsed&quot; desc=&quot;Helper classes&quot;&gt;
<span class="nc" id="L801">    class Box {</span>

        int type;
        long offset;
        long size;
    }

<span class="nc" id="L808">    public class Moof {</span>

        int mfhd_SequenceNumber;
        public Traf traf;
    }

<span class="nc" id="L814">    public class Traf {</span>

        public Tfhd tfhd;
        long tfdt;
        public Trun trun;
    }

<span class="nc" id="L821">    public class Tfhd {</span>

        int bFlags;
        public int trackId;
        int defaultSampleDuration;
        int defaultSampleSize;
        int defaultSampleFlags;
    }

<span class="nc" id="L830">    class TrunEntry {</span>

        int sampleDuration;
        int sampleSize;
        int sampleFlags;
        int sampleCompositionTimeOffset;

        boolean hasCompositionTimeOffset;
        boolean isKeyframe;

    }

<span class="nc" id="L842">    public class Trun {</span>

        public int chunkDuration;
        public int chunkSize;

        public int bFlags;
        int bFirstSampleFlags;
        int dataOffset;

        public int entryCount;
        byte[] bEntries;
        int entries_rowSize;

        public TrunEntry getEntry(int i) {
<span class="nc" id="L856">            ByteBuffer buffer = ByteBuffer.wrap(bEntries, i * entries_rowSize, entries_rowSize);</span>
<span class="nc" id="L857">            TrunEntry entry = new TrunEntry();</span>

<span class="nc bnc" id="L859" title="All 2 branches missed.">            if (hasFlag(bFlags, 0x0100)) {</span>
<span class="nc" id="L860">                entry.sampleDuration = buffer.getInt();</span>
            }
<span class="nc bnc" id="L862" title="All 2 branches missed.">            if (hasFlag(bFlags, 0x0200)) {</span>
<span class="nc" id="L863">                entry.sampleSize = buffer.getInt();</span>
            }
<span class="nc bnc" id="L865" title="All 2 branches missed.">            if (hasFlag(bFlags, 0x0400)) {</span>
<span class="nc" id="L866">                entry.sampleFlags = buffer.getInt();</span>
            }
<span class="nc bnc" id="L868" title="All 2 branches missed.">            if (hasFlag(bFlags, 0x0800)) {</span>
<span class="nc" id="L869">                entry.sampleCompositionTimeOffset = buffer.getInt();</span>
            }

<span class="nc" id="L872">            entry.hasCompositionTimeOffset = hasFlag(bFlags, 0x0800);</span>
<span class="nc bnc" id="L873" title="All 2 branches missed.">            entry.isKeyframe = !hasFlag(entry.sampleFlags, 0x10000);</span>

<span class="nc" id="L875">            return entry;</span>
        }

        public TrunEntry getAbsoluteEntry(int i, Tfhd header) {
<span class="nc" id="L879">            TrunEntry entry = getEntry(i);</span>

<span class="nc bnc" id="L881" title="All 4 branches missed.">            if (!hasFlag(bFlags, 0x0100) &amp;&amp; hasFlag(header.bFlags, 0x20)) {</span>
<span class="nc" id="L882">                entry.sampleFlags = header.defaultSampleFlags;</span>
            }

<span class="nc bnc" id="L885" title="All 4 branches missed.">            if (!hasFlag(bFlags, 0x0200) &amp;&amp; hasFlag(header.bFlags, 0x10)) {</span>
<span class="nc" id="L886">                entry.sampleSize = header.defaultSampleSize;</span>
            }

<span class="nc bnc" id="L889" title="All 4 branches missed.">            if (!hasFlag(bFlags, 0x0100) &amp;&amp; hasFlag(header.bFlags, 0x08)) {</span>
<span class="nc" id="L890">                entry.sampleDuration = header.defaultSampleDuration;</span>
            }

<span class="nc bnc" id="L893" title="All 4 branches missed.">            if (i == 0 &amp;&amp; hasFlag(bFlags, 0x0004)) {</span>
<span class="nc" id="L894">                entry.sampleFlags = bFirstSampleFlags;</span>
            }

<span class="nc" id="L897">            return entry;</span>
        }
    }

<span class="nc" id="L901">    public class Tkhd {</span>

        int trackId;
        long duration;
        short bVolume;
        int bWidth;
        int bHeight;
        byte[] matrix;
        short bLayer;
        short bAlternateGroup;
    }

<span class="nc" id="L913">    public class Trak {</span>

        public Tkhd tkhd;
        public Elst edst_elst;
        public Mdia mdia;

    }

<span class="nc" id="L921">    class Mvhd {</span>

        long timeScale;
        long nextTrackId;
    }

<span class="nc" id="L927">    class Moov {</span>

        Mvhd mvhd;
        Trak[] trak;
        Trex[] mvex_trex;
    }

<span class="nc" id="L934">    public class Trex {</span>

        private int trackId;
        int defaultSampleDescriptionIndex;
        int defaultSampleDuration;
        int defaultSampleSize;
        int defaultSampleFlags;
    }

<span class="nc" id="L943">    public class Elst {</span>

        public long MediaTime;
        public int bMediaRate;
    }

<span class="nc" id="L949">    public class Mdia {</span>

        public int mdhd_timeScale;
        public byte[] mdhd;
        public Hdlr hdlr;
        public Minf minf;
    }

<span class="nc" id="L957">    public class Hdlr {</span>

        public int type;
        public int subType;
        public byte[] bReserved;
    }

<span class="nc" id="L964">    public class Minf {</span>

        public byte[] dinf;
        public byte[] stbl_stsd;
        public byte[] $mhd;
    }

<span class="nc" id="L971">    public class Mp4Track {</span>

        public TrackKind kind;
        public Trak trak;
        public Trex trex;
    }

<span class="nc" id="L978">    public class Mp4DashChunk {</span>

        public InputStream data;
        public Moof moof;
<span class="nc" id="L982">        private int i = 0;</span>

        public TrunEntry getNextSampleInfo() {
<span class="nc bnc" id="L985" title="All 2 branches missed.">            if (i &gt;= moof.traf.trun.entryCount) {</span>
<span class="nc" id="L986">                return null;</span>
            }
<span class="nc" id="L988">            return moof.traf.trun.getAbsoluteEntry(i++, moof.traf.tfhd);</span>
        }

        public Mp4DashSample getNextSample() throws IOException {
<span class="nc bnc" id="L992" title="All 2 branches missed.">            if (data == null) {</span>
<span class="nc" id="L993">                throw new IllegalStateException(&quot;This chunk has info only&quot;);</span>
            }
<span class="nc bnc" id="L995" title="All 2 branches missed.">            if (i &gt;= moof.traf.trun.entryCount) {</span>
<span class="nc" id="L996">                return null;</span>
            }

<span class="nc" id="L999">            Mp4DashSample sample = new Mp4DashSample();</span>
<span class="nc" id="L1000">            sample.info = moof.traf.trun.getAbsoluteEntry(i++, moof.traf.tfhd);</span>
<span class="nc" id="L1001">            sample.data = new byte[sample.info.sampleSize];</span>

<span class="nc bnc" id="L1003" title="All 2 branches missed.">            if (data.read(sample.data) != sample.info.sampleSize) {</span>
<span class="nc" id="L1004">                throw new EOFException(&quot;EOF reached while reading a sample&quot;);</span>
            }

<span class="nc" id="L1007">            return sample;</span>
        }
    }

<span class="nc" id="L1011">    public class Mp4DashSample {</span>

        public TrunEntry info;
        public byte[] data;
    }
//&lt;/editor-fold&gt;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span>Generated by the Android Gradle plugin 3.2.0</div></body></html>